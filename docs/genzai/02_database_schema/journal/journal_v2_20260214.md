# Phase 5 完全スキーマ定義 v2.0（定義B準拠）

**作成日**: 2026-02-14  
**更新**: 定義B（2026-02-13夜）を正式採用  
**目的**: 協力型フロー + Streamed互換の完全なスキーマ定義  
**思想**: 業務効率SaaS、MF拡張レイヤー、Streamed準拠

---

## 🎯 設計思想

### 責任範囲の明確化

| システム | 責任範囲 | 境界線 |
|---------|---------|--------|
| **本システム** | 仕訳作成〜CSV出力まで | `exported` status |
| **マネーフォワード** | CSV取り込み後〜決算確定まで | インポート完了 |

**原則**:
- ✅ MFが会計の真実（Source of Truth）
- ✅ 本システムは業務効率・統制レイヤー
- ❌ 完全同期しない（差分検知のみ）

---

## 📊 1. status定義（1つ、シンプル）

### ENUM型定義

```sql
CREATE TYPE journal_status AS ENUM (
  'exported'   -- 出力済み（CSV出力完了、編集不可）
);
```

### 詳細定義

| status | 日本語 | 意味 | 編集可否 | 責任範囲 |
|--------|--------|------|----------|----------|
| `exported` | 出力済み | CSV出力完了 | ❌ 不可 | MFへ引き渡し完了 |
| `null` | 未出力 | 通常の仕訳（デフォルト）| ✅ 可能 | 本システム |

### 状態遷移図

```
null → exported
```

**特徴**:
- `null`: デフォルト状態、編集可能
- `exported`: 一方通行（出力後は編集不可）

### 設計判断の根拠

**旧ステータス廃止の理由**:
- 旧: `pending`, `help`, `soudan`, `kakunin` → 新: ラベルで表現
- 理由: ステータスは「出力済みかどうか」のみを管理すべき
- Streamed準拠: 出力=完了、ステータスはシンプルに

---

## 🏷️ 2. label定義（21個、非排他的）

### 事故フラグ（6個）

```typescript
'DEBIT_CREDIT_MISMATCH'    // 貸借不一致
'TAX_CALCULATION_ERROR'    // 税計算誤差
'DUPLICATE_SUSPECT'        // 重複疑い
'DATE_ANOMALY'             // 日付異常
'AMOUNT_ANOMALY'           // 金額異常
'MISSING_RECEIPT'          // 証憑欠落
```

### OCR関連（2個）

```typescript
'OCR_LOW_CONFIDENCE'       // OCR信頼度低
'OCR_FAILED'               // OCR完全失敗
```

### 証憑種類（5個）

```typescript
'RECEIPT'                  // レシート
'INVOICE'                  // 請求書
'TRANSPORT'                // 交通費
'CREDIT_CARD'              // クレジットカード
'BANK_STATEMENT'           // 銀行明細
```

### 制度系（3個）

```typescript
'INVOICE_QUALIFIED'        // 適格請求書
'INVOICE_NOT_QUALIFIED'    // 不適格請求書
'MULTI_TAX_RATE'           // 複数税率
```

### ルール（2個）

```typescript
'RULE_APPLIED'             // ルール適用済み
'RULE_AVAILABLE'           // ルール適用可能
```

### その他（1個）

```typescript
'HAS_MEMO'                 // メモあり
```

### 要対応（3個）

```typescript
'NEED_DOCUMENT'            // 資料が必要
'NEED_CONFIRM'             // 確認が必要
'NEED_CONSULT'             // 相談が必要
```

### 出力制御（1個）

```typescript
'EXPORT_EXCLUDE'           // 出力対象外
```

---
- 個人的な支出で会計に含めない仕訳
- 一時的な仮入力で出力したくない仕訳

### PostgreSQL実装

```sql
-- TEXT配列（GINインデックス可能）
ALTER TABLE journals
ADD COLUMN labels TEXT[] DEFAULT '{}';

-- GINインデックス（高速検索）
CREATE INDEX idx_journals_labels ON journals USING GIN(labels);
```

---

## 📖 未読・既読管理

### is_read フィールド

| フィールド | 型 | 説明 |
|-----------|----|----|
| `is_read` | boolean | 未読（false）/ 既読（true）|
| `read_at` | timestamp | 既読日時 |

### 既読になる条件

以下のいずれかの操作で自動的に既読になる:

1. **手動既読**: ユーザーが既読ボタンをクリック
2. **編集時**: 仕訳を編集した時
3. **詳細画面表示時**: 詳細画面を開いた時

### UI表示

- 未読: 背景色が黄色（`bg-yellow-50`）
- 既読: 背景色が白（`bg-white`）

### データベース実装

```sql
ALTER TABLE journals
ADD COLUMN is_read BOOLEAN NOT NULL DEFAULT FALSE,
ADD COLUMN read_at TIMESTAMP NULL;
```

---

## 🔒 3. readonly定義

### 基本式

```typescript
readonly = (status === 'exported')
```

### 理由

- **`exported` = CSV出力完了 = MFへ引き渡し完了**
- 本システムの責任範囲外
- 修正はMF側で実施

### Phase 5での拡張（予定）

```typescript
function isJournalEditable(
  journal: Journal, 
  context?: { periodClosed?: boolean; user?: User }
): boolean {
  if (journal.status === 'exported') return false;
  if (context?.periodClosed) return false;  // 期間締め
  if (!context?.user?.hasPermission('edit')) return false;  // 権限
  return true;
}
```

---

## 📋 4. journals テーブル完全スキーマ

### CREATE TABLE文

```sql
CREATE TABLE journals (
  -- 基本情報
  id UUID PRIMARY KEY,
  client_id UUID NOT NULL,
  receipt_id UUID REFERENCES receipts(id),
  
  -- status管理（協力型フロー）
  status journal_status NOT NULL DEFAULT 'pending',
  status_updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  status_updated_by UUID NOT NULL REFERENCES users(id),
  
  -- 基本タイムスタンプ
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  
  -- 未読/既読（背景色管理）
  is_read BOOLEAN DEFAULT FALSE,
  read_at TIMESTAMP NULL,
  
  -- メモ機能（help/soudan/kakunin共通）
  memo TEXT NULL,
  memo_author VARCHAR(100) NULL,
  memo_target VARCHAR(100) NULL,
  memo_created_at TIMESTAMP NULL,
  
  -- 出力管理
  exported_at TIMESTAMP NULL,
  exported_by VARCHAR(100) NULL,
  export_exclude BOOLEAN DEFAULT FALSE,
  export_exclude_reason VARCHAR(200) NULL,
  
  -- ゴミ箱（Streamed準拠）
  deleted_at TIMESTAMP NULL,
  deleted_by VARCHAR(100) NULL,
  
  -- labels（17個、非排他的）
  labels TEXT[] DEFAULT '{}',
  
  -- 仕訳データ（省略）
  amount NUMERIC NOT NULL,
  debit_account VARCHAR(50),
  credit_account VARCHAR(50),
  description TEXT,
  
  -- 整合性制約
  CONSTRAINT check_exported_sync CHECK (
    (status = 'exported' AND exported_at IS NOT NULL)
    OR (status != 'exported' AND exported_at IS NULL)
  ),
  
  CONSTRAINT check_memo_author CHECK (
    (memo IS NULL) 
    OR (memo IS NOT NULL AND memo_author IS NOT NULL)
  ),
  
  CONSTRAINT check_deleted_by CHECK (
    (deleted_at IS NULL) 
    OR (deleted_at IS NOT NULL AND deleted_by IS NOT NULL)
  ),
  
  CONSTRAINT check_export_exclude_reason CHECK (
    (export_exclude = FALSE)
    OR (export_exclude = TRUE AND export_exclude_reason IS NOT NULL)
  )
);
```

### カラム一覧と用途

| カラム | 型 | Phase 5 | 用途 |
|--------|----|---------| -----|
| `id` | UUID | ✅ | 主キー |
| `client_id` | UUID | ✅ | 顧問先ID |
| `receipt_id` | UUID | ✅ | 証票ID |
| `status` | ENUM | ✅ | 現在の状態（協力型フロー） |
| `status_updated_at` | TIMESTAMP | ✅ | 最終status更新日時 |
| `status_updated_by` | UUID | ✅ | 最終更新者 |
| `created_at` | TIMESTAMP | ✅ | 作成日時（不変） |
| `updated_at` | TIMESTAMP | ✅ | 最終更新日時 |
| `is_read` | BOOLEAN | ✅ | 未読/既読（背景色管理） |
| `read_at` | TIMESTAMP | ✅ | 既読日時 |
| `memo` | TEXT | ✅ | メモ内容 |
| `memo_author` | VARCHAR | ✅ | メモ作成者 |
| `memo_target` | VARCHAR | ✅ | メモ対象者 |
| `memo_created_at` | TIMESTAMP | ✅ | メモ作成日時 |
| `exported_at` | TIMESTAMP | ✅ | exported遷移日時 |
| `exported_by` | VARCHAR | ✅ | 出力者 |
| `export_exclude` | BOOLEAN | ✅ | 出力対象外フラグ |
| `export_exclude_reason` | VARCHAR | ✅ | 出力対象外理由 |
| `deleted_at` | TIMESTAMP | ✅ | 論理削除日時 |
| `deleted_by` | VARCHAR | ✅ | 削除者 |
| `labels` | TEXT[] | ✅ | 17個のlabel |

**合計**: 約25カラム（仕訳データ除く）

---

## 📊 5. インデックス設計（7個）

```sql
-- status検索（help/soudan/kakunin一覧）
CREATE INDEX idx_journals_status ON journals(status);

-- 未読一覧（黄色ハイライト）
CREATE INDEX idx_journals_is_read ON journals(is_read);

-- ゴミ箱一覧
CREATE INDEX idx_journals_deleted_at ON journals(deleted_at);

-- labels検索（GINインデックス）
CREATE INDEX idx_journals_labels ON journals USING GIN(labels);

-- 複合インデックス（背景色ロジック高速化）
CREATE INDEX idx_journals_status_read ON journals(status, is_read);

-- 出力履歴検索
CREATE INDEX idx_journals_exported_at ON journals(exported_at);

-- 作成日時順ソート
CREATE INDEX idx_journals_created_at ON journals(created_at);
```

**設計判断**:
- 部分インデックス廃止（WHERE句不要）
- 200社規模では維持コストは無視できる（約5秒/日）
- すべてのクエリパターンにインデックス作成

---

## 🎨 6. 背景色ロジック（優先順位制御）

```typescript
function getRowBackgroundColor(journal: Journal): string {
  // 1. 出力済み → グレー（最優先、変更不可）
  if (journal.status === 'exported') {
    return '#E0E0E0'; // グレー
  }
  
  // 2. 未読 → 黄色（業務未着手）
  if (!journal.is_read) {
    return '#FFF9C4'; // 黄色
  }
  
  // 3. 既読 → 白（業務着手済み）
  return '#FFFFFF'; // 白
}
```

**意味**:
- 🟨 黄色（未読） = 「まだ誰も見てない！」→ 業務未着手
- ⬜ 白（既読） = 「誰かが見た」→ 業務着手済み
- ⬛ グレー（出力済み） = 「完了、変更不可」→ 業務完了

---

## 📋 7. UI列構成（13列）

| 列 | 内容 | データ | 操作 |
|----|------|--------|------|
| 1 | 一括操作チェック | - | コピー、削除等 |
| 2 | No | display_order | - |
| 3 | サポートアイコン | status | 🆘💬📋 ホバーでメモ |
| 4 | ラベルアイコン | labels[] | 事故フラグ等 |
| 5 | 適格判定 | labels | ⭕❌ |
| 6 | 取引日付 | date | - |
| 7 | 摘要 | description | - |
| 8-10 | 借方 | 科目、補助、金額 | - |
| 11-13 | 貸方 | 科目、補助、金額 | - |

**一括操作**:
- コピー → 直下に未読で挿入
- 既読にする → `is_read = TRUE`（黄色→白）
- 未読にする → `is_read = FALSE`（備忘録）
- 出力対象外 → `export_exclude = TRUE`
- ゴミ箱 → `deleted_at = NOW()`

---

## 📦 8. export管理テーブル

### export_batches テーブル

```sql
CREATE TABLE export_batches (
  id UUID PRIMARY KEY,
  client_id UUID NOT NULL,
  exported_at TIMESTAMP NOT NULL DEFAULT NOW(),
  exported_by UUID NOT NULL REFERENCES users(id),
  journal_count INTEGER NOT NULL,
  filename TEXT NOT NULL
);
```

**用途**: CSV出力の履歴管理（いつ、誰が、何件）

### journal_exports テーブル

```sql
CREATE TABLE journal_exports (
  id UUID PRIMARY KEY,
  journal_id UUID NOT NULL REFERENCES journals(id),
  export_batch_id UUID NOT NULL REFERENCES export_batches(id),
  exported_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(journal_id, export_batch_id)
);
```

**用途**: 仕訳とバッチの紐付け（N対N）

---

## 🔄 9. CSV出力フロー

### 処理手順

```typescript
async function exportToCSV(clientId: string, userId: string) {
  // 1. pending/help/soudan/kakuninのみ取得（exportedは含まない）
  const journals = await db.journals.findMany({
    where: { 
      clientId,
      status: { in: ['pending', 'help', 'soudan', 'kakunin'] },
      export_exclude: false  // 出力対象外を除外
    }
  });
  
  // 2. CSV生成
  const csv = generateMFCSV(journals);
  
  // 3. ファイル名（日時を含む）
  const timestamp = format(new Date(), 'yyyyMMdd_HHmmss');
  const filename = `${clientId}_${timestamp}_journals.csv`;
  
  // 4. ダウンロード
  downloadFile(csv, filename);
  
  // 5. 即座に exported に遷移
  await db.journals.updateMany(
    { id: { in: journals.map(j => j.id) } },
    { 
      status: 'exported',
      exported_at: new Date(),
      exported_by: userId
    }
  );
  
  // 6. バッチ記録
  await db.exportBatches.create({
    data: {
      clientId,
      exportedBy: userId,
      journalCount: journals.length,
      filename
    }
  });
  
  return { filename, count: journals.length };
}
```

### ファイル名規則

```
{client_id}_{yyyyMMdd_HHmmss}_journals.csv
例: clientA_20261211_143022_journals.csv
```

---

## 🛡️ 10. API層でのガード句（必須）

### 編集防止

```typescript
export async function updateJournal(
  journalId: string, 
  updates: Partial<Journal>,
  context: { userId: string }
): Promise<Journal> {
  const journal = await getJournal(journalId);
  
  // exported は編集不可
  if (journal.status === 'exported') {
    throw new BusinessRuleError(
      'CSV出力済みの仕訳は編集できません。' +
      'MF側で修正するか、管理者に問い合わせてください。',
      'EXPORTED_JOURNAL_READONLY'
    );
  }
  
  // ゴミ箱復元
  if (journal.deleted_at && !isRestoreRequest) {
    throw new Error('ゴミ箱内の仕訳は編集不可');
  }
  
  return await db.journals.update(journalId, updates);
}
```

---

## 🎨 11. UI表示仕様

### status表示

UI上では`status`は直接表示されません。

| status | 意味 | UI上の影響 |
|--------|------|------------| 
| `null` | 未出力（デフォルト） | 編集可能 |
| `exported` | 出力済み | 編集不可（グレーアウト） |

### Composable実装

```typescript
// composables/useJournalStatus.ts
export function useJournalStatus(status: JournalStatus | null) {
  const isEditable = computed(() => status !== 'exported');
  const displayStatus = computed(() => status === 'exported' ? '出力済み' : '編集可能');
  
  return { isEditable, displayStatus };
}
```

---

## 📊 12. Streamedとの比較

### Streamedから採用した設計

| 項目 | Streamedの設計 | 本システムでの採用 |
|------|---------------|--------------------|
| 出力=完了 | 出力したら編集不可 | ✅ `status = 'exported'`で確定 |
| シンプルUI | ボタンを押させない | ✅ 自動保存、明示的な完了ボタンなし |
| ゴミ箱30日 | 論理削除→30日後物理削除 | ✅ `deleted_at` + バッチ処理 |
| 背景色管理 | 未読/既読で色分け | ✅ 黄色/白/グレー |
| コピー挙動 | 未読で直下に挿入 | ✅ `is_read = FALSE` |

### 本システム独自の要件

| 項目 | 本システムの必要性 | 実装方法 |
|------|--------------------|----------|
| 協力型フロー | 複数人で助け合う | ✅ labels (NEED_DOCUMENT, NEED_CONFIRM, NEED_CONSULT) |
| メモ機能 | サポート要請時の詳細記録 | ✅ memo, memo_author, memo_target |
| 出力対象外 | CSV出力しない意思表示 | ✅ EXPORT_EXCLUDE label |

---

## ⏰ 13. Phase 5 vs 遠い将来の切り分け

### Phase 5（今すぐ実装）

| 項目 | 実装 |
|------|------|
| status 1つの型定義（exported + null） | ✅ |
| label 21個の型定義 | ✅ |
| タイムスタンプカラム | ✅ |
| 未読/既読カラム | ✅ |
| メモ機能カラム | ✅ |
| 出力管理カラム | ✅ |
| export管理テーブル | ✅ |
| readonly API層ガード | ✅ |
| CHECK制約4つ | ✅ |
| インデックス7個 | ✅ |

### 遠い将来（MF API連携後）

| 項目 | 内容 |
|------|------|
| MF差分検知 | API連携、ハッシュ比較 |
| 双方向同期 | MF側修正の自動取り込み |

---

## 🚨 14. 重要な設計判断

### ✅ 確定事項

1. **exported は編集不可**（Phase 5から厳格）
2. **MFが会計の真実**（本システムは業務レイヤー）
3. **完全同期しない**（差分検知のみ）
4. **CSV出力 = バッチ管理**（1仕訳ずつではない）
5. **ファイル名に日時含む**（重複防止）
6. **協力型フロー**（階層型承認フローではない）
7. **Streamed準拠**（出力=完了、背景色管理、ゴミ箱30日）

### ❌ やらないこと

1. ❌ MF側の修正を自動同期
2. ❌ exported の自動巻き戻し
3. ❌ 仕訳番号の厳密管理
4. ❌ CSV差分管理
5. ❌ リアルタイム双方向同期
6. ❌ 階層型承認フロー

---

## ✅ 15. 完成条件

Phase 5実装完了の定義：

- [ ] status 5つの型定義実装
- [ ] label 17つの型定義実装
- [ ] journals テーブルに全カラム追加
- [ ] export_batches / journal_exports テーブル作成
- [ ] API層にexportedガード句実装
- [ ] CSV出力時の自動遷移実装
- [ ] UI層にstatus表示実装
- [ ] 背景色ロジック実装
- [ ] CHECK制約4つ実装
- [ ] インデックス7個実装

---

**Status**: 設計確定 ✅（定義B準拠）  
**Version**: v2.0  
**Next**: Phase 5実装開始
