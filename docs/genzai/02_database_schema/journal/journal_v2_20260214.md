# Phase 5 å®Œå…¨ã‚¹ã‚­ãƒ¼ãƒå®šç¾© v2.0ï¼ˆå®šç¾©Bæº–æ‹ ï¼‰

**ä½œæˆæ—¥**: 2026-02-14  
**æ›´æ–°**: å®šç¾©Bï¼ˆ2026-02-13å¤œï¼‰ã‚’æ­£å¼æ¡ç”¨  
**ç›®çš„**: å”åŠ›å‹ãƒ•ãƒ­ãƒ¼ + Streamedäº’æ›ã®å®Œå…¨ãªã‚¹ã‚­ãƒ¼ãƒå®šç¾©  
**æ€æƒ³**: æ¥­å‹™åŠ¹ç‡SaaSã€MFæ‹¡å¼µãƒ¬ã‚¤ãƒ¤ãƒ¼ã€Streamedæº–æ‹ 

---

## ğŸ¯ è¨­è¨ˆæ€æƒ³

### è²¬ä»»ç¯„å›²ã®æ˜ç¢ºåŒ–

| ã‚·ã‚¹ãƒ†ãƒ  | è²¬ä»»ç¯„å›² | å¢ƒç•Œç·š |
|---------|---------|--------|
| **æœ¬ã‚·ã‚¹ãƒ†ãƒ ** | ä»•è¨³ä½œæˆã€œCSVå‡ºåŠ›ã¾ã§ | `exported` status |
| **ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰** | CSVå–ã‚Šè¾¼ã¿å¾Œã€œæ±ºç®—ç¢ºå®šã¾ã§ | ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº† |

**åŸå‰‡**:
- âœ… MFãŒä¼šè¨ˆã®çœŸå®Ÿï¼ˆSource of Truthï¼‰
- âœ… æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯æ¥­å‹™åŠ¹ç‡ãƒ»çµ±åˆ¶ãƒ¬ã‚¤ãƒ¤ãƒ¼
- âŒ å®Œå…¨åŒæœŸã—ãªã„ï¼ˆå·®åˆ†æ¤œçŸ¥ã®ã¿ï¼‰

---

## ğŸ“Š 1. statuså®šç¾©ï¼ˆ1ã¤ã€ã‚·ãƒ³ãƒ—ãƒ«ï¼‰

### ENUMå‹å®šç¾©

```sql
CREATE TYPE journal_status AS ENUM (
  'exported'   -- å‡ºåŠ›æ¸ˆã¿ï¼ˆCSVå‡ºåŠ›å®Œäº†ã€ç·¨é›†ä¸å¯ï¼‰
);
```

### è©³ç´°å®šç¾©

| status | æ—¥æœ¬èª | æ„å‘³ | ç·¨é›†å¯å¦ | è²¬ä»»ç¯„å›² |
|--------|--------|------|----------|----------|
| `exported` | å‡ºåŠ›æ¸ˆã¿ | CSVå‡ºåŠ›å®Œäº† | âŒ ä¸å¯ | MFã¸å¼•ãæ¸¡ã—å®Œäº† |
| `null` | æœªå‡ºåŠ› | é€šå¸¸ã®ä»•è¨³ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰| âœ… å¯èƒ½ | æœ¬ã‚·ã‚¹ãƒ†ãƒ  |

### çŠ¶æ…‹é·ç§»å›³

```
null â†’ exported
```

**ç‰¹å¾´**:
- `null`: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã€ç·¨é›†å¯èƒ½
- `exported`: ä¸€æ–¹é€šè¡Œï¼ˆå‡ºåŠ›å¾Œã¯ç·¨é›†ä¸å¯ï¼‰

### è¨­è¨ˆåˆ¤æ–­ã®æ ¹æ‹ 

**æ—§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å»ƒæ­¢ã®ç†ç”±**:
- æ—§: `pending`, `help`, `soudan`, `kakunin` â†’ æ–°: ãƒ©ãƒ™ãƒ«ã§è¡¨ç¾
- ç†ç”±: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ã€Œå‡ºåŠ›æ¸ˆã¿ã‹ã©ã†ã‹ã€ã®ã¿ã‚’ç®¡ç†ã™ã¹ã
- Streamedæº–æ‹ : å‡ºåŠ›=å®Œäº†ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«

---

## ğŸ·ï¸ 2. labelå®šç¾©ï¼ˆ21å€‹ã€éæ’ä»–çš„ï¼‰

### äº‹æ•…ãƒ•ãƒ©ã‚°ï¼ˆ6å€‹ï¼‰

```typescript
'DEBIT_CREDIT_MISMATCH'    // è²¸å€Ÿä¸ä¸€è‡´
'TAX_CALCULATION_ERROR'    // ç¨è¨ˆç®—èª¤å·®
'DUPLICATE_SUSPECT'        // é‡è¤‡ç–‘ã„
'DATE_ANOMALY'             // æ—¥ä»˜ç•°å¸¸
'AMOUNT_ANOMALY'           // é‡‘é¡ç•°å¸¸
'MISSING_RECEIPT'          // è¨¼æ†‘æ¬ è½
```

### OCRé–¢é€£ï¼ˆ2å€‹ï¼‰

```typescript
'OCR_LOW_CONFIDENCE'       // OCRä¿¡é ¼åº¦ä½
'OCR_FAILED'               // OCRå®Œå…¨å¤±æ•—
```

### è¨¼æ†‘ç¨®é¡ï¼ˆ5å€‹ï¼‰

```typescript
'RECEIPT'                  // ãƒ¬ã‚·ãƒ¼ãƒˆ
'INVOICE'                  // è«‹æ±‚æ›¸
'TRANSPORT'                // äº¤é€šè²»
'CREDIT_CARD'              // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
'BANK_STATEMENT'           // éŠ€è¡Œæ˜ç´°
```

### åˆ¶åº¦ç³»ï¼ˆ3å€‹ï¼‰

```typescript
'INVOICE_QUALIFIED'        // é©æ ¼è«‹æ±‚æ›¸
'INVOICE_NOT_QUALIFIED'    // ä¸é©æ ¼è«‹æ±‚æ›¸
'MULTI_TAX_RATE'           // è¤‡æ•°ç¨ç‡
```

### ãƒ«ãƒ¼ãƒ«ï¼ˆ2å€‹ï¼‰

```typescript
'RULE_APPLIED'             // ãƒ«ãƒ¼ãƒ«é©ç”¨æ¸ˆã¿
'RULE_AVAILABLE'           // ãƒ«ãƒ¼ãƒ«é©ç”¨å¯èƒ½
```

### ãã®ä»–ï¼ˆ1å€‹ï¼‰

```typescript
'HAS_MEMO'                 // ãƒ¡ãƒ¢ã‚ã‚Š
```

### è¦å¯¾å¿œï¼ˆ3å€‹ï¼‰

```typescript
'NEED_DOCUMENT'            // è³‡æ–™ãŒå¿…è¦
'NEED_CONFIRM'             // ç¢ºèªãŒå¿…è¦
'NEED_CONSULT'             // ç›¸è«‡ãŒå¿…è¦
```

### å‡ºåŠ›åˆ¶å¾¡ï¼ˆ0å€‹ â€” 2026-02-20åˆ¤æ–­: ã‚«ãƒ©ãƒ ç®¡ç†ã«ç§»è¡Œï¼‰

> **âš ï¸ Phase Cå¤‰æ›´äºˆå®š**: `EXPORT_EXCLUDE` ã¯ãƒ©ãƒ™ãƒ«ã‹ã‚‰å»ƒæ­¢ã—ã€`export_exclude` ã‚«ãƒ©ãƒ ï¼ˆBOOLEAN + CHECKåˆ¶ç´„ï¼‰ã®ã¿ã§ç®¡ç†ã™ã‚‹ã€‚
> ç†ç”±: ãƒ©ãƒ™ãƒ«ã¯ã€Œç‰¹æ€§ï¼ˆä½•ã§ã‚ã‚‹ã‹ï¼‰ã€ã€export_excludeã¯ã€Œåˆ¶å¾¡ï¼ˆã©ã†ã™ã‚‹ã‹ï¼‰ã€ã€‚ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé•ã†ã€‚
> åˆ¤æ–­ã®è©³ç´°: task_current.mdã€Œ2026-02-20ç¢ºå®š: export_excludeè¨­è¨ˆåˆ¤æ–­ã€å‚ç…§ã€‚

ç”¨ä¾‹:
- å€‹äººçš„ãªæ”¯å‡ºã§ä¼šè¨ˆã«å«ã‚ãªã„ä»•è¨³
- ä¸€æ™‚çš„ãªä»®å…¥åŠ›ã§å‡ºåŠ›ã—ãŸããªã„ä»•è¨³

---

### PostgreSQLå®Ÿè£…

```sql
-- TEXTé…åˆ—ï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¯èƒ½ï¼‰
ALTER TABLE journals
ADD COLUMN labels TEXT[] DEFAULT '{}';

-- GINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé«˜é€Ÿæ¤œç´¢ï¼‰
CREATE INDEX idx_journals_labels ON journals USING GIN(labels);
```

---

## ğŸ“– æœªèª­ãƒ»æ—¢èª­ç®¡ç†

### is_read ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|----|----|
| `is_read` | boolean | æœªèª­ï¼ˆfalseï¼‰/ æ—¢èª­ï¼ˆtrueï¼‰|
| `read_at` | timestamp | æ—¢èª­æ—¥æ™‚ |

### æ—¢èª­ã«ãªã‚‹æ¡ä»¶

ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ“ä½œã§è‡ªå‹•çš„ã«æ—¢èª­ã«ãªã‚‹:

1. **æ‰‹å‹•æ—¢èª­**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢èª­ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. **ç·¨é›†æ™‚**: ä»•è¨³ã‚’ç·¨é›†ã—ãŸæ™‚
3. **è©³ç´°ç”»é¢è¡¨ç¤ºæ™‚**: è©³ç´°ç”»é¢ã‚’é–‹ã„ãŸæ™‚

### UIè¡¨ç¤º

- å‡ºåŠ›æ¸ˆã¿: èƒŒæ™¯è‰²ãŒã‚°ãƒ¬ãƒ¼ï¼ˆ`bg-gray-200`ï¼‰â† **æœ€å„ªå…ˆ**
- æœªèª­: èƒŒæ™¯è‰²ãŒé»„è‰²ï¼ˆ`bg-yellow-100`ï¼‰
- æ—¢èª­: èƒŒæ™¯è‰²ãŒç™½ï¼ˆ`bg-white`ï¼‰

> **2026-02-20å®Ÿè£…**: exportedâ†’ç°ã‚’æœ€å„ªå…ˆã¨ã—ã€æœªèª­ï¼ˆé»„ï¼‰ã‚ˆã‚Šå„ªå…ˆã™ã‚‹3è‰²ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ¢ãƒƒã‚¯ã«å®Ÿè£…æ¸ˆã¿ã€‚

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®Ÿè£…

```sql
ALTER TABLE journals
ADD COLUMN is_read BOOLEAN NOT NULL DEFAULT FALSE,
ADD COLUMN read_at TIMESTAMP NULL;
```

---

## ğŸ”’ 3. readonlyå®šç¾©

### åŸºæœ¬å¼

```typescript
readonly = (status === 'exported')
```

### ç†ç”±

- **`exported` = CSVå‡ºåŠ›å®Œäº† = MFã¸å¼•ãæ¸¡ã—å®Œäº†**
- æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®è²¬ä»»ç¯„å›²å¤–
- ä¿®æ­£ã¯MFå´ã§å®Ÿæ–½

### Phase 5ã§ã®æ‹¡å¼µï¼ˆäºˆå®šï¼‰

```typescript
function isJournalEditable(
  journal: Journal, 
  context?: { periodClosed?: boolean; user?: User }
): boolean {
  if (journal.status === 'exported') return false;
  if (context?.periodClosed) return false;  // æœŸé–“ç· ã‚
  if (!context?.user?.hasPermission('edit')) return false;  // æ¨©é™
  return true;
}
```

---

## ğŸ“‹ 4. journals ãƒ†ãƒ¼ãƒ–ãƒ«å®Œå…¨ã‚¹ã‚­ãƒ¼ãƒ

### CREATE TABLEæ–‡

> **DDLã®å˜ä¸€ã‚½ãƒ¼ã‚¹**: [migration.sql](file:///C:/dev/receipt-app/docs/genzai/02_database_schema/journal/migration.sql) ã‚’å‚ç…§ã€‚
> æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã¯è¨­è¨ˆæ€æƒ³ã¨æ ¹æ‹ ã‚’è¨˜è¼‰ã™ã‚‹ã€‚DDLã®é‡è¤‡ç®¡ç†ã¯ãƒ‰ãƒªãƒ•ãƒˆã®åŸå› ã¨ãªã‚‹ãŸã‚è¡Œã‚ãªã„ã€‚

**ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆ**:
- `journals` â€” ä»•è¨³ãƒ˜ãƒƒãƒ€ï¼ˆstatus, labels, ãƒ¡ãƒ¢, å‡ºåŠ›ç®¡ç†, ã‚´ãƒŸç®±ï¼‰
- `journal_entries` â€” Nå¯¾Nè¤‡åˆä»•è¨³æ˜ç´°ï¼ˆå€Ÿæ–¹/è²¸æ–¹åˆ†é›¢ï¼‰
- `export_batches` â€” CSVå‡ºåŠ›å±¥æ­´
- `journal_exports` â€” ä»•è¨³ã¨ãƒãƒƒãƒã®ç´ä»˜ã‘ï¼ˆNå¯¾Nï¼‰

**CHECKåˆ¶ç´„4ã¤**: exportedåŒæœŸ, ãƒ¡ãƒ¢ä½œæˆè€…å¿…é ˆ, å‰Šé™¤è€…å¿…é ˆ, å‡ºåŠ›å¯¾è±¡å¤–ç†ç”±å¿…é ˆ

**ã‚«ãƒ©ãƒ è©³ç´°**: migration.sqlã®`journals`ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’å‚ç…§ã€‚

**åˆè¨ˆ**: ç´„25ã‚«ãƒ©ãƒ ï¼ˆjournalsï¼‰+ journal_entriesã§Nå¯¾Næ˜ç´°ç®¡ç†

---

## ğŸ“Š 5. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆï¼ˆ7å€‹ï¼‰

```sql
-- statusæ¤œç´¢ï¼ˆexported/æœªå‡ºåŠ›ã®åˆ¤åˆ¥ï¼‰
CREATE INDEX idx_journals_status ON journals(status);

-- æœªèª­ä¸€è¦§ï¼ˆé»„è‰²ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
CREATE INDEX idx_journals_is_read ON journals(is_read);

-- ã‚´ãƒŸç®±ä¸€è¦§
CREATE INDEX idx_journals_deleted_at ON journals(deleted_at);

-- labelsæ¤œç´¢ï¼ˆGINã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
CREATE INDEX idx_journals_labels ON journals USING GIN(labels);

-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆèƒŒæ™¯è‰²ãƒ­ã‚¸ãƒƒã‚¯é«˜é€ŸåŒ–ï¼‰
CREATE INDEX idx_journals_status_read ON journals(status, is_read);

-- å‡ºåŠ›å±¥æ­´æ¤œç´¢
CREATE INDEX idx_journals_exported_at ON journals(exported_at);

-- ä½œæˆæ—¥æ™‚é †ã‚½ãƒ¼ãƒˆ
CREATE INDEX idx_journals_created_at ON journals(created_at);
```

**è¨­è¨ˆåˆ¤æ–­**:
- éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å»ƒæ­¢ï¼ˆWHEREå¥ä¸è¦ï¼‰
- 200ç¤¾è¦æ¨¡ã§ã¯ç¶­æŒã‚³ã‚¹ãƒˆã¯ç„¡è¦–ã§ãã‚‹ï¼ˆç´„5ç§’/æ—¥ï¼‰
- ã™ã¹ã¦ã®ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ

---

## ğŸ¨ 6. èƒŒæ™¯è‰²ãƒ­ã‚¸ãƒƒã‚¯

### ä¸€è¦§UIï¼ˆ3è‰²ãƒ»å„ªå…ˆé †ä½åˆ¶ï¼‰

```typescript
function getRowBackground(journal: JournalPhase5Mock): string {
  // å„ªå…ˆåº¦1: å‡ºåŠ›æ¸ˆã¿ â†’ ã‚°ãƒ¬ãƒ¼ï¼ˆæœªèª­ã‚ˆã‚Šå„ªå…ˆï¼‰
  if (journal.status === 'exported') {
    return 'bg-gray-200';
  }
  // å„ªå…ˆåº¦2: æœªèª­ â†’ é»„è‰²
  if (!journal.is_read) {
    return 'bg-yellow-100';
  }
  // å„ªå…ˆåº¦3: æ—¢èª­ â†’ ç™½
  return 'bg-white';
}
```

- ğŸ”² ã‚°ãƒ¬ãƒ¼ï¼ˆå‡ºåŠ›æ¸ˆã¿ï¼‰ = ã€ŒCSVå‡ºåŠ›å®Œäº†ã€â†’ **æœ€å„ªå…ˆ**ï¼ˆæœªèª­ã‚ˆã‚Šå„ªå…ˆï¼‰
- ğŸŸ¨ é»„è‰²ï¼ˆæœªèª­ï¼‰ = ã€Œã¾ã èª°ã‚‚è¦‹ã¦ãªã„ï¼ã€â†’ æ¥­å‹™æœªç€æ‰‹
- â¬œ ç™½ï¼ˆæ—¢èª­ï¼‰ = ã€Œèª°ã‹ãŒè¦‹ãŸã€â†’ æ¥­å‹™ç€æ‰‹æ¸ˆã¿

> **2026-02-20å¤‰æ›´**: å„ªå…ˆé †ä½åˆ¶ã‚’æ¡ç”¨ã€‚exportedâ†’ç°ã‚’æœ€å„ªå…ˆã¨ã™ã‚‹ã“ã¨ã§ã€
> ã€Œæœªèª­ã‹ã¤æœªå‡ºåŠ›ã€ã®ç«¶åˆã‚’è§£æ¶ˆã€‚å‡ºåŠ›æ¸ˆã¿è¡Œã¯å¸¸ã«ã‚°ãƒ¬ãƒ¼ã§è¦–è¦šçš„ã«ç¢ºå®šçŠ¶æ…‹ã‚’ç¤ºã™ã€‚
> ãƒ¢ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿ï¼ˆJournalListLevel3Mock.vue `getRowBackground`é–¢æ•°ï¼‰ã€‚

### éå»ä»•è¨³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ3è‰²ï¼‰

| æ¡ä»¶ | èƒŒæ™¯è‰² | è‰²å€¤ |
|---|---|---|
| status = 'exported' | ç™½ | #FFFFFF |
| status = null, export_exclude = false | è–„ã„é’ | æœªå®š |
| export_exclude = true | è–„ã„èµ¤ | æœªå®š |

> is_readã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã¯ä½¿ç”¨ã—ãªã„ï¼ˆéå»ä»•è¨³å‚ç…§ã§æœªèª­/æ—¢èª­ã¯ç„¡é–¢ä¿‚ï¼‰ã€‚

---

## ğŸ“‹ 7. UIåˆ—æ§‹æˆï¼ˆ23åˆ—ï¼‰

> **åˆ—å®šç¾©ã®å˜ä¸€ã‚½ãƒ¼ã‚¹**: [journalColumns.ts](file:///C:/dev/receipt-app/src/mocks/columns/journalColumns.ts)ï¼ˆJournalColumnå‹å®šç¾©ä»˜ãã€sortKeyä»˜ã23åˆ—ï¼‰ã‚’å‚ç…§ã€‚

| åˆ— | key | type | ãƒ‡ãƒ¼ã‚¿ | æ“ä½œ |
|----|-----|------|--------|------|
| 1 | select | checkbox | â€” | ä¸€æ‹¬æ“ä½œ |
| 2 | no | index | display_order | â€” |
| 3 | photo | component | receipt_id | ãƒ›ãƒãƒ¼ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ |
| 4 | pastJournal | component | â€” | éå»ä»•è¨³æ¤œç´¢ |
| 5 | comment | component | status | ãƒ¡ãƒ¢ãƒ›ãƒãƒ¼ |
| 6 | needAction | component | labels (NEED_*) | ğŸ“„âœ…ğŸ’¬ãƒˆã‚°ãƒ« |
| 7 | labelType | component | labels (è¨¼ç¥¨) | è¨¼ç¥¨ç¨®é¡è¡¨ç¤º |
| 8 | warning | component | labels (äº‹æ•…) | è­¦å‘Šè¡¨ç¤º |
| 9 | rule | component | labels (RULE_*) | å­¦ç¿’çŠ¶æ…‹è¡¨ç¤º |
| 10 | taxRate | component | labels (MULTI_TAX_RATE) | è»½æ¸›ç¨ç‡è¡¨ç¤º |
| 11 | memo | component | labels (HAS_MEMO) | ãƒ¡ãƒ¢ãƒ›ãƒãƒ¼ |
| 12 | invoice | component | labels (INVOICE_*) | é©æ ¼åˆ¤å®šè¡¨ç¤º |
| 13 | transaction_date | text | transaction_date | â€” |
| 14 | description | text | description | â€” |
| 15 | debit.account | text | å€Ÿæ–¹å‹˜å®šç§‘ç›® | â€” |
| 16 | debit.sub_account | text | å€Ÿæ–¹è£œåŠ© | â€” |
| 17 | debit.tax_category | text | å€Ÿæ–¹ç¨åŒºåˆ† | â€” |
| 18 | debit.amount | amount | å€Ÿæ–¹é‡‘é¡ | â€” |
| 19 | credit.account | text | è²¸æ–¹å‹˜å®šç§‘ç›® | â€” |
| 20 | credit.sub_account | text | è²¸æ–¹è£œåŠ© | â€” |
| 21 | credit.tax_category | text | è²¸æ–¹ç¨åŒºåˆ† | â€” |
| 22 | credit.amount | amount | è²¸æ–¹é‡‘é¡ | â€” |
| 23 | trash | action | â€” | è«–ç†å‰Šé™¤ |

**ä¸€æ‹¬æ“ä½œ**:
- ã‚³ãƒ”ãƒ¼ â†’ ç›´ä¸‹ã«æœªèª­ã§æŒ¿å…¥
- æ—¢èª­ã«ã™ã‚‹ â†’ `is_read = TRUE`ï¼ˆé»„è‰²â†’ç™½ï¼‰
- æœªèª­ã«ã™ã‚‹ â†’ `is_read = FALSE`ï¼ˆå‚™å¿˜éŒ²ï¼‰
- å‡ºåŠ›å¯¾è±¡å¤– â†’ `export_exclude = TRUE`
- ã‚´ãƒŸç®± â†’ `deleted_at = NOW()`

---

## ğŸ“¦ 8. exportç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«

### export_batches ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE export_batches (
  id UUID PRIMARY KEY,
  client_id UUID NOT NULL,
  exported_at TIMESTAMP NOT NULL DEFAULT NOW(),
  exported_by UUID NOT NULL REFERENCES users(id),
  journal_count INTEGER NOT NULL,
  filename TEXT NOT NULL
);
```

**ç”¨é€”**: CSVå‡ºåŠ›ã®å±¥æ­´ç®¡ç†ï¼ˆã„ã¤ã€èª°ãŒã€ä½•ä»¶ï¼‰

### journal_exports ãƒ†ãƒ¼ãƒ–ãƒ«

```sql
CREATE TABLE journal_exports (
  id UUID PRIMARY KEY,
  journal_id UUID NOT NULL REFERENCES journals(id),
  export_batch_id UUID NOT NULL REFERENCES export_batches(id),
  exported_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(journal_id, export_batch_id)
);
```

**ç”¨é€”**: ä»•è¨³ã¨ãƒãƒƒãƒã®ç´ä»˜ã‘ï¼ˆNå¯¾Nï¼‰

---

## ğŸ”„ 9. CSVå‡ºåŠ›ãƒ•ãƒ­ãƒ¼

### å‡¦ç†æ‰‹é †

```typescript
async function exportToCSV(clientId: string, userId: string) {
  // 1. æœªå‡ºåŠ›ã®ã¿å–å¾—ï¼ˆexportedã¯å«ã¾ãªã„ï¼‰
  const journals = await db.journals.findMany({
    where: { 
      clientId,
      status: null,  // æœªå‡ºåŠ›ã®ã¿ï¼ˆexportedä»¥å¤–ï¼‰
      export_exclude: false  // å‡ºåŠ›å¯¾è±¡å¤–ã‚’é™¤å¤–
    }
  });
  
  // 2. CSVç”Ÿæˆ
  const csv = generateMFCSV(journals);
  
  // 3. ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ—¥æ™‚ã‚’å«ã‚€ï¼‰
  const timestamp = format(new Date(), 'yyyyMMdd_HHmmss');
  const filename = `${clientId}_${timestamp}_journals.csv`;
  
  // 4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  downloadFile(csv, filename);
  
  // 5. å³åº§ã« exported ã«é·ç§»
  await db.journals.updateMany(
    { id: { in: journals.map(j => j.id) } },
    { 
      status: 'exported',
      exported_at: new Date(),
      exported_by: userId
    }
  );
  
  // 6. ãƒãƒƒãƒè¨˜éŒ²
  await db.exportBatches.create({
    data: {
      clientId,
      exportedBy: userId,
      journalCount: journals.length,
      filename
    }
  });
  
  return { filename, count: journals.length };
}
```

### ãƒ•ã‚¡ã‚¤ãƒ«åè¦å‰‡

```
{client_id}_{yyyyMMdd_HHmmss}_journals.csv
ä¾‹: clientA_20261211_143022_journals.csv
```

---

## ğŸ›¡ï¸ 10. APIå±¤ã§ã®ã‚¬ãƒ¼ãƒ‰å¥ï¼ˆå¿…é ˆï¼‰

### ç·¨é›†é˜²æ­¢

```typescript
export async function updateJournal(
  journalId: string, 
  updates: Partial<Journal>,
  context: { userId: string }
): Promise<Journal> {
  const journal = await getJournal(journalId);
  
  // exported ã¯ç·¨é›†ä¸å¯
  if (journal.status === 'exported') {
    throw new BusinessRuleError(
      'CSVå‡ºåŠ›æ¸ˆã¿ã®ä»•è¨³ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚' +
      'MFå´ã§ä¿®æ­£ã™ã‚‹ã‹ã€ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã¦ãã ã•ã„ã€‚',
      'EXPORTED_JOURNAL_READONLY'
    );
  }
  
  // ã‚´ãƒŸç®±å¾©å…ƒ
  if (journal.deleted_at && !isRestoreRequest) {
    throw new Error('ã‚´ãƒŸç®±å†…ã®ä»•è¨³ã¯ç·¨é›†ä¸å¯');
  }
  
  return await db.journals.update(journalId, updates);
}
```

---

## ğŸ¨ 11. UIè¡¨ç¤ºä»•æ§˜

### statusè¡¨ç¤º

UIä¸Šã§ã¯`status`ã¯ç›´æ¥è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

| status | æ„å‘³ | UIä¸Šã®å½±éŸ¿ |
|--------|------|------------| 
| `null` | æœªå‡ºåŠ›ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ | ç·¨é›†å¯èƒ½ |
| `exported` | å‡ºåŠ›æ¸ˆã¿ | ç·¨é›†ä¸å¯ï¼ˆå‡ºåŠ›åˆ—ã§è¡¨ç¤ºã€‚ä¸€è¦§UIã®èƒŒæ™¯è‰²ã¯is_readã®ã¿ï¼‰ |

### Composableå®Ÿè£…

```typescript
// composables/useJournalStatus.ts
export function useJournalStatus(status: JournalStatus | null) {
  const isEditable = computed(() => status !== 'exported');
  const displayStatus = computed(() => status === 'exported' ? 'å‡ºåŠ›æ¸ˆã¿' : 'ç·¨é›†å¯èƒ½');
  
  return { isEditable, displayStatus };
}
```

---

## ğŸ“Š 12. Streamedã¨ã®æ¯”è¼ƒ

### Streamedã‹ã‚‰æ¡ç”¨ã—ãŸè¨­è¨ˆ

| é …ç›® | Streamedã®è¨­è¨ˆ | æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã®æ¡ç”¨ |
|------|---------------|--------------------|
| å‡ºåŠ›=å®Œäº† | å‡ºåŠ›ã—ãŸã‚‰ç·¨é›†ä¸å¯ | âœ… `status = 'exported'`ã§ç¢ºå®š |
| ã‚·ãƒ³ãƒ—ãƒ«UI | ãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ã›ãªã„ | âœ… è‡ªå‹•ä¿å­˜ã€æ˜ç¤ºçš„ãªå®Œäº†ãƒœã‚¿ãƒ³ãªã— |
| ã‚´ãƒŸç®±30æ—¥ | è«–ç†å‰Šé™¤â†’30æ—¥å¾Œç‰©ç†å‰Šé™¤ | âœ… `deleted_at` + ãƒãƒƒãƒå‡¦ç† |
| èƒŒæ™¯è‰²ç®¡ç† | æœªèª­/æ—¢èª­ã§è‰²åˆ†ã‘ | âœ… é»„è‰²/ç™½ï¼ˆ2è‰²ã€‚å‡ºåŠ›çŠ¶æ…‹ã¯å‡ºåŠ›åˆ—ã§è¡¨ç¤ºï¼‰ |
| ã‚³ãƒ”ãƒ¼æŒ™å‹• | æœªèª­ã§ç›´ä¸‹ã«æŒ¿å…¥ | âœ… `is_read = FALSE` |

### æœ¬ã‚·ã‚¹ãƒ†ãƒ ç‹¬è‡ªã®è¦ä»¶

| é …ç›® | æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®å¿…è¦æ€§ | å®Ÿè£…æ–¹æ³• |
|------|--------------------|----------|
| å”åŠ›å‹ãƒ•ãƒ­ãƒ¼ | è¤‡æ•°äººã§åŠ©ã‘åˆã† | âœ… labels (NEED_DOCUMENT, NEED_CONFIRM, NEED_CONSULT) |
| ãƒ¡ãƒ¢æ©Ÿèƒ½ | ã‚µãƒãƒ¼ãƒˆè¦è«‹æ™‚ã®è©³ç´°è¨˜éŒ² | âœ… memo, memo_author, memo_target |
| å‡ºåŠ›å¯¾è±¡å¤– | CSVå‡ºåŠ›ã—ãªã„æ„æ€è¡¨ç¤ºï¼ˆäººé–“ã®æ¥­å‹™åˆ¤æ–­ï¼‰ | âœ… export_excludeã‚«ãƒ©ãƒ ï¼ˆPhase Cã§ãƒ©ãƒ™ãƒ«å»ƒæ­¢ï¼‰ |

---

## â° 13. Phase 5 vs é ã„å°†æ¥ã®åˆ‡ã‚Šåˆ†ã‘

### Phase 5ï¼ˆä»Šã™ãå®Ÿè£…ï¼‰

| é …ç›® | å®Ÿè£… |
|------|------|
| status 1ã¤ã®å‹å®šç¾©ï¼ˆexported + nullï¼‰ | âœ… |
| label 21å€‹ã®å‹å®šç¾© | âœ… |
| ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ©ãƒ  | âœ… |
| æœªèª­/æ—¢èª­ã‚«ãƒ©ãƒ  | âœ… |
| ãƒ¡ãƒ¢æ©Ÿèƒ½ã‚«ãƒ©ãƒ  | âœ… |
| å‡ºåŠ›ç®¡ç†ã‚«ãƒ©ãƒ  | âœ… |
| exportç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ« | âœ… |
| readonly APIå±¤ã‚¬ãƒ¼ãƒ‰ | âœ… |
| CHECKåˆ¶ç´„4ã¤ | âœ… |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹7å€‹ | âœ… |

### é ã„å°†æ¥ï¼ˆMF APIé€£æºå¾Œï¼‰

| é …ç›® | å†…å®¹ |
|------|------|
| MFå·®åˆ†æ¤œçŸ¥ | APIé€£æºã€ãƒãƒƒã‚·ãƒ¥æ¯”è¼ƒ |
| åŒæ–¹å‘åŒæœŸ | MFå´ä¿®æ­£ã®è‡ªå‹•å–ã‚Šè¾¼ã¿ |

---

## ğŸš¨ 14. é‡è¦ãªè¨­è¨ˆåˆ¤æ–­

### âœ… ç¢ºå®šäº‹é …

1. **exported ã¯ç·¨é›†ä¸å¯**ï¼ˆPhase 5ã‹ã‚‰å³æ ¼ï¼‰
2. **MFãŒä¼šè¨ˆã®çœŸå®Ÿ**ï¼ˆæœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯æ¥­å‹™ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
3. **å®Œå…¨åŒæœŸã—ãªã„**ï¼ˆå·®åˆ†æ¤œçŸ¥ã®ã¿ï¼‰
4. **CSVå‡ºåŠ› = ãƒãƒƒãƒç®¡ç†**ï¼ˆ1ä»•è¨³ãšã¤ã§ã¯ãªã„ï¼‰
5. **ãƒ•ã‚¡ã‚¤ãƒ«åã«æ—¥æ™‚å«ã‚€**ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
6. **å”åŠ›å‹ãƒ•ãƒ­ãƒ¼**ï¼ˆéšå±¤å‹æ‰¿èªãƒ•ãƒ­ãƒ¼ã§ã¯ãªã„ï¼‰
7. **Streamedæº–æ‹ **ï¼ˆå‡ºåŠ›=å®Œäº†ã€èƒŒæ™¯è‰²ç®¡ç†ã€ã‚´ãƒŸç®±30æ—¥ï¼‰

### âŒ ã‚„ã‚‰ãªã„ã“ã¨

1. âŒ MFå´ã®ä¿®æ­£ã‚’è‡ªå‹•åŒæœŸ
2. âŒ exported ã®è‡ªå‹•å·»ãæˆ»ã—
3. âŒ ä»•è¨³ç•ªå·ã®å³å¯†ç®¡ç†
4. âŒ CSVå·®åˆ†ç®¡ç†
5. âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæ–¹å‘åŒæœŸ
6. âŒ éšå±¤å‹æ‰¿èªãƒ•ãƒ­ãƒ¼

---

## âœ… 15. å®Œæˆæ¡ä»¶

Phase 5å®Ÿè£…å®Œäº†ã®å®šç¾©ï¼š

- [ ] status 1ã¤ã®å‹å®šç¾©å®Ÿè£…ï¼ˆexported + nullï¼‰
- [ ] label 20å€‹ã®å‹å®šç¾©å®Ÿè£…ï¼ˆPhase Cã§EXPORT_EXCLUDEå»ƒæ­¢å¾Œï¼‰
- [ ] journals ãƒ†ãƒ¼ãƒ–ãƒ«ã«å…¨ã‚«ãƒ©ãƒ è¿½åŠ 
- [ ] export_batches / journal_exports ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] APIå±¤ã«exportedã‚¬ãƒ¼ãƒ‰å¥å®Ÿè£…
- [ ] CSVå‡ºåŠ›æ™‚ã®è‡ªå‹•é·ç§»å®Ÿè£…
- [ ] UIå±¤ã«statusè¡¨ç¤ºå®Ÿè£…
- [x] èƒŒæ™¯è‰²ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆ3è‰²å„ªå…ˆé †ä½åˆ¶: exportedâ†’ç° > æœªèª­â†’é»„ > æ—¢èª­â†’ç™½ã€‚ãƒ¢ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿ 2026-02-20ï¼‰
- [ ] CHECKåˆ¶ç´„4ã¤å®Ÿè£…
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹7å€‹å®Ÿè£…

---

**Status**: è¨­è¨ˆç¢ºå®š âœ…ï¼ˆå®šç¾©Bæº–æ‹ ï¼‰  
**Version**: v2.0  
**Next**: Phase 5å®Ÿè£…é–‹å§‹
