# Phase 5 完全スキーマ定義 v2.0（定義B準拠）

**作成日**: 2026-02-14  
**更新**: 定義B（2026-02-13夜）を正式採用  
**目的**: 協力型フロー + Streamed互換の完全なスキーマ定義  
**思想**: 業務効率SaaS、MF拡張レイヤー、Streamed準拠

---

## 🎯 設計思想

### 責任範囲の明確化

| システム | 責任範囲 | 境界線 |
|---------|---------|--------|
| **本システム** | 仕訳作成〜CSV出力まで | `exported` status |
| **マネーフォワード** | CSV取り込み後〜決算確定まで | インポート完了 |

**原則**:
- ✅ MFが会計の真実（Source of Truth）
- ✅ 本システムは業務効率・統制レイヤー
- ❌ 完全同期しない（差分検知のみ）

---

## 📊 1. status定義（1つ、シンプル）

### ENUM型定義

```sql
CREATE TYPE journal_status AS ENUM (
  'exported'   -- 出力済み（CSV出力完了、編集不可）
);
```

### 詳細定義

| status | 日本語 | 意味 | 編集可否 | 責任範囲 |
|--------|--------|------|----------|----------|
| `exported` | 出力済み | CSV出力完了 | ❌ 不可 | MFへ引き渡し完了 |
| `null` | 未出力 | 通常の仕訳（デフォルト）| ✅ 可能 | 本システム |

### 状態遷移図

```
null → exported
```

**特徴**:
- `null`: デフォルト状態、編集可能
- `exported`: 一方通行（出力後は編集不可）

### 設計判断の根拠

**旧ステータス廃止の理由**:
- 旧: `pending`, `help`, `soudan`, `kakunin` → 新: ラベルで表現
- 理由: ステータスは「出力済みかどうか」のみを管理すべき
- Streamed準拠: 出力=完了、ステータスはシンプルに

---

## 🏷️ 2. label定義（21個、非排他的）

### 事故フラグ（6個）

```typescript
'DEBIT_CREDIT_MISMATCH'    // 貸借不一致
'TAX_CALCULATION_ERROR'    // 税計算誤差
'DUPLICATE_SUSPECT'        // 重複疑い
'DATE_ANOMALY'             // 日付異常
'AMOUNT_ANOMALY'           // 金額異常
'MISSING_RECEIPT'          // 証憑欠落
```

### OCR関連（2個）

```typescript
'OCR_LOW_CONFIDENCE'       // OCR信頼度低
'OCR_FAILED'               // OCR完全失敗
```

### 証憑種類（5個）

```typescript
'RECEIPT'                  // レシート
'INVOICE'                  // 請求書
'TRANSPORT'                // 交通費
'CREDIT_CARD'              // クレジットカード
'BANK_STATEMENT'           // 銀行明細
```

### 制度系（3個）

```typescript
'INVOICE_QUALIFIED'        // 適格請求書
'INVOICE_NOT_QUALIFIED'    // 不適格請求書
'MULTI_TAX_RATE'           // 複数税率
```

### ルール（2個）

```typescript
'RULE_APPLIED'             // ルール適用済み
'RULE_AVAILABLE'           // ルール適用可能
```

### その他（1個）

```typescript
'HAS_MEMO'                 // メモあり
```

### 要対応（3個）

```typescript
'NEED_DOCUMENT'            // 資料が必要
'NEED_CONFIRM'             // 確認が必要
'NEED_CONSULT'             // 相談が必要
```

### 出力制御（0個 — 2026-02-20判断: カラム管理に移行）

> **⚠️ Phase C変更予定**: `EXPORT_EXCLUDE` はラベルから廃止し、`export_exclude` カラム（BOOLEAN + CHECK制約）のみで管理する。
> 理由: ラベルは「特性（何であるか）」、export_excludeは「制御（どうするか）」。レイヤーが違う。
> 判断の詳細: task_current.md「2026-02-20確定: export_exclude設計判断」参照。

用例:
- 個人的な支出で会計に含めない仕訳
- 一時的な仮入力で出力したくない仕訳

---

### PostgreSQL実装

```sql
-- TEXT配列（GINインデックス可能）
ALTER TABLE journals
ADD COLUMN labels TEXT[] DEFAULT '{}';

-- GINインデックス（高速検索）
CREATE INDEX idx_journals_labels ON journals USING GIN(labels);
```

---

## 📖 未読・既読管理

### is_read フィールド

| フィールド | 型 | 説明 |
|-----------|----|----|
| `is_read` | boolean | 未読（false）/ 既読（true）|
| `read_at` | timestamp | 既読日時 |

### 既読になる条件

以下のいずれかの操作で自動的に既読になる:

1. **手動既読**: ユーザーが既読ボタンをクリック
2. **編集時**: 仕訳を編集した時
3. **詳細画面表示時**: 詳細画面を開いた時

### UI表示

- 未読: 背景色が黄色（`bg-yellow-50`）
- 既読: 背景色が白（`bg-white`）

### データベース実装

```sql
ALTER TABLE journals
ADD COLUMN is_read BOOLEAN NOT NULL DEFAULT FALSE,
ADD COLUMN read_at TIMESTAMP NULL;
```

---

## 🔒 3. readonly定義

### 基本式

```typescript
readonly = (status === 'exported')
```

### 理由

- **`exported` = CSV出力完了 = MFへ引き渡し完了**
- 本システムの責任範囲外
- 修正はMF側で実施

### Phase 5での拡張（予定）

```typescript
function isJournalEditable(
  journal: Journal, 
  context?: { periodClosed?: boolean; user?: User }
): boolean {
  if (journal.status === 'exported') return false;
  if (context?.periodClosed) return false;  // 期間締め
  if (!context?.user?.hasPermission('edit')) return false;  // 権限
  return true;
}
```

---

## 📋 4. journals テーブル完全スキーマ

### CREATE TABLE文

> **DDLの単一ソース**: [migration.sql](file:///C:/dev/receipt-app/docs/genzai/02_database_schema/journal/migration.sql) を参照。
> 本ファイルは設計思想と根拠を記載する。DDLの重複管理はドリフトの原因となるため行わない。

**テーブル構成**:
- `journals` — 仕訳ヘッダ（status, labels, メモ, 出力管理, ゴミ箱）
- `journal_entries` — N対N複合仕訳明細（借方/貸方分離）
- `export_batches` — CSV出力履歴
- `journal_exports` — 仕訳とバッチの紐付け（N対N）

**CHECK制約4つ**: exported同期, メモ作成者必須, 削除者必須, 出力対象外理由必須

**カラム詳細**: migration.sqlの`journals`テーブル定義を参照。

**合計**: 約25カラム（journals）+ journal_entriesでN対N明細管理

---

## 📊 5. インデックス設計（7個）

```sql
-- status検索（exported/未出力の判別）
CREATE INDEX idx_journals_status ON journals(status);

-- 未読一覧（黄色ハイライト）
CREATE INDEX idx_journals_is_read ON journals(is_read);

-- ゴミ箱一覧
CREATE INDEX idx_journals_deleted_at ON journals(deleted_at);

-- labels検索（GINインデックス）
CREATE INDEX idx_journals_labels ON journals USING GIN(labels);

-- 複合インデックス（背景色ロジック高速化）
CREATE INDEX idx_journals_status_read ON journals(status, is_read);

-- 出力履歴検索
CREATE INDEX idx_journals_exported_at ON journals(exported_at);

-- 作成日時順ソート
CREATE INDEX idx_journals_created_at ON journals(created_at);
```

**設計判断**:
- 部分インデックス廃止（WHERE句不要）
- 200社規模では維持コストは無視できる（約5秒/日）
- すべてのクエリパターンにインデックス作成

---

## 🎨 6. 背景色ロジック

### 一覧UI（2色）

```typescript
function getRowBackgroundColor(journal: Journal): string {
  if (!journal.is_read) return '#FFF9C4'; // 黄色（未読）
  return '#FFFFFF'; // 白（既読）
}
```

- 🟨 黄色（未読） = 「まだ誰も見てない！」→ 業務未着手
- ⬜ 白（既読） = 「誰かが見た」→ 業務着手済み

> **2026-02-20変更**: exported→グレーを削除。出力状態は出力列で表示する。
> 理由: 「未読かつ未出力」が同時成立し、1行に2色を塗れないため背景色が競合する。

### 過去仕訳モーダル（3色）

| 条件 | 背景色 | 色値 |
|---|---|---|
| status = 'exported' | 白 | #FFFFFF |
| status = null, export_exclude = false | 薄い青 | 未定 |
| export_exclude = true | 薄い赤 | 未定 |

> is_readはモーダルでは使用しない（過去仕訳参照で未読/既読は無関係）。

---

## 📋 7. UI列構成（23列）

> **列定義の単一ソース**: [journalColumns.ts](file:///C:/dev/receipt-app/src/mocks/columns/journalColumns.ts)（JournalColumn型定義付き、sortKey付き23列）を参照。

| 列 | key | type | データ | 操作 |
|----|-----|------|--------|------|
| 1 | select | checkbox | — | 一括操作 |
| 2 | no | index | display_order | — |
| 3 | photo | component | receipt_id | ホバーでプレビュー |
| 4 | pastJournal | component | — | 過去仕訳検索 |
| 5 | comment | component | status | メモホバー |
| 6 | needAction | component | labels (NEED_*) | 📄✅💬トグル |
| 7 | labelType | component | labels (証票) | 証票種類表示 |
| 8 | warning | component | labels (事故) | 警告表示 |
| 9 | rule | component | labels (RULE_*) | 学習状態表示 |
| 10 | taxRate | component | labels (MULTI_TAX_RATE) | 軽減税率表示 |
| 11 | memo | component | labels (HAS_MEMO) | メモホバー |
| 12 | invoice | component | labels (INVOICE_*) | 適格判定表示 |
| 13 | transaction_date | text | transaction_date | — |
| 14 | description | text | description | — |
| 15 | debit.account | text | 借方勘定科目 | — |
| 16 | debit.sub_account | text | 借方補助 | — |
| 17 | debit.tax_category | text | 借方税区分 | — |
| 18 | debit.amount | amount | 借方金額 | — |
| 19 | credit.account | text | 貸方勘定科目 | — |
| 20 | credit.sub_account | text | 貸方補助 | — |
| 21 | credit.tax_category | text | 貸方税区分 | — |
| 22 | credit.amount | amount | 貸方金額 | — |
| 23 | trash | action | — | 論理削除 |

**一括操作**:
- コピー → 直下に未読で挿入
- 既読にする → `is_read = TRUE`（黄色→白）
- 未読にする → `is_read = FALSE`（備忘録）
- 出力対象外 → `export_exclude = TRUE`
- ゴミ箱 → `deleted_at = NOW()`

---

## 📦 8. export管理テーブル

### export_batches テーブル

```sql
CREATE TABLE export_batches (
  id UUID PRIMARY KEY,
  client_id UUID NOT NULL,
  exported_at TIMESTAMP NOT NULL DEFAULT NOW(),
  exported_by UUID NOT NULL REFERENCES users(id),
  journal_count INTEGER NOT NULL,
  filename TEXT NOT NULL
);
```

**用途**: CSV出力の履歴管理（いつ、誰が、何件）

### journal_exports テーブル

```sql
CREATE TABLE journal_exports (
  id UUID PRIMARY KEY,
  journal_id UUID NOT NULL REFERENCES journals(id),
  export_batch_id UUID NOT NULL REFERENCES export_batches(id),
  exported_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(journal_id, export_batch_id)
);
```

**用途**: 仕訳とバッチの紐付け（N対N）

---

## 🔄 9. CSV出力フロー

### 処理手順

```typescript
async function exportToCSV(clientId: string, userId: string) {
  // 1. 未出力のみ取得（exportedは含まない）
  const journals = await db.journals.findMany({
    where: { 
      clientId,
      status: null,  // 未出力のみ（exported以外）
      export_exclude: false  // 出力対象外を除外
    }
  });
  
  // 2. CSV生成
  const csv = generateMFCSV(journals);
  
  // 3. ファイル名（日時を含む）
  const timestamp = format(new Date(), 'yyyyMMdd_HHmmss');
  const filename = `${clientId}_${timestamp}_journals.csv`;
  
  // 4. ダウンロード
  downloadFile(csv, filename);
  
  // 5. 即座に exported に遷移
  await db.journals.updateMany(
    { id: { in: journals.map(j => j.id) } },
    { 
      status: 'exported',
      exported_at: new Date(),
      exported_by: userId
    }
  );
  
  // 6. バッチ記録
  await db.exportBatches.create({
    data: {
      clientId,
      exportedBy: userId,
      journalCount: journals.length,
      filename
    }
  });
  
  return { filename, count: journals.length };
}
```

### ファイル名規則

```
{client_id}_{yyyyMMdd_HHmmss}_journals.csv
例: clientA_20261211_143022_journals.csv
```

---

## 🛡️ 10. API層でのガード句（必須）

### 編集防止

```typescript
export async function updateJournal(
  journalId: string, 
  updates: Partial<Journal>,
  context: { userId: string }
): Promise<Journal> {
  const journal = await getJournal(journalId);
  
  // exported は編集不可
  if (journal.status === 'exported') {
    throw new BusinessRuleError(
      'CSV出力済みの仕訳は編集できません。' +
      'MF側で修正するか、管理者に問い合わせてください。',
      'EXPORTED_JOURNAL_READONLY'
    );
  }
  
  // ゴミ箱復元
  if (journal.deleted_at && !isRestoreRequest) {
    throw new Error('ゴミ箱内の仕訳は編集不可');
  }
  
  return await db.journals.update(journalId, updates);
}
```

---

## 🎨 11. UI表示仕様

### status表示

UI上では`status`は直接表示されません。

| status | 意味 | UI上の影響 |
|--------|------|------------| 
| `null` | 未出力（デフォルト） | 編集可能 |
| `exported` | 出力済み | 編集不可（出力列で表示。一覧UIの背景色はis_readのみ） |

### Composable実装

```typescript
// composables/useJournalStatus.ts
export function useJournalStatus(status: JournalStatus | null) {
  const isEditable = computed(() => status !== 'exported');
  const displayStatus = computed(() => status === 'exported' ? '出力済み' : '編集可能');
  
  return { isEditable, displayStatus };
}
```

---

## 📊 12. Streamedとの比較

### Streamedから採用した設計

| 項目 | Streamedの設計 | 本システムでの採用 |
|------|---------------|--------------------|
| 出力=完了 | 出力したら編集不可 | ✅ `status = 'exported'`で確定 |
| シンプルUI | ボタンを押させない | ✅ 自動保存、明示的な完了ボタンなし |
| ゴミ箱30日 | 論理削除→30日後物理削除 | ✅ `deleted_at` + バッチ処理 |
| 背景色管理 | 未読/既読で色分け | ✅ 黄色/白（2色。出力状態は出力列で表示） |
| コピー挙動 | 未読で直下に挿入 | ✅ `is_read = FALSE` |

### 本システム独自の要件

| 項目 | 本システムの必要性 | 実装方法 |
|------|--------------------|----------|
| 協力型フロー | 複数人で助け合う | ✅ labels (NEED_DOCUMENT, NEED_CONFIRM, NEED_CONSULT) |
| メモ機能 | サポート要請時の詳細記録 | ✅ memo, memo_author, memo_target |
| 出力対象外 | CSV出力しない意思表示（人間の業務判断） | ✅ export_excludeカラム（Phase Cでラベル廃止） |

---

## ⏰ 13. Phase 5 vs 遠い将来の切り分け

### Phase 5（今すぐ実装）

| 項目 | 実装 |
|------|------|
| status 1つの型定義（exported + null） | ✅ |
| label 21個の型定義 | ✅ |
| タイムスタンプカラム | ✅ |
| 未読/既読カラム | ✅ |
| メモ機能カラム | ✅ |
| 出力管理カラム | ✅ |
| export管理テーブル | ✅ |
| readonly API層ガード | ✅ |
| CHECK制約4つ | ✅ |
| インデックス7個 | ✅ |

### 遠い将来（MF API連携後）

| 項目 | 内容 |
|------|------|
| MF差分検知 | API連携、ハッシュ比較 |
| 双方向同期 | MF側修正の自動取り込み |

---

## 🚨 14. 重要な設計判断

### ✅ 確定事項

1. **exported は編集不可**（Phase 5から厳格）
2. **MFが会計の真実**（本システムは業務レイヤー）
3. **完全同期しない**（差分検知のみ）
4. **CSV出力 = バッチ管理**（1仕訳ずつではない）
5. **ファイル名に日時含む**（重複防止）
6. **協力型フロー**（階層型承認フローではない）
7. **Streamed準拠**（出力=完了、背景色管理、ゴミ箱30日）

### ❌ やらないこと

1. ❌ MF側の修正を自動同期
2. ❌ exported の自動巻き戻し
3. ❌ 仕訳番号の厳密管理
4. ❌ CSV差分管理
5. ❌ リアルタイム双方向同期
6. ❌ 階層型承認フロー

---

## ✅ 15. 完成条件

Phase 5実装完了の定義：

- [ ] status 1つの型定義実装（exported + null）
- [ ] label 20個の型定義実装（Phase CでEXPORT_EXCLUDE廃止後）
- [ ] journals テーブルに全カラム追加
- [ ] export_batches / journal_exports テーブル作成
- [ ] API層にexportedガード句実装
- [ ] CSV出力時の自動遷移実装
- [ ] UI層にstatus表示実装
- [ ] 背景色ロジック実装
- [ ] CHECK制約4つ実装
- [ ] インデックス7個実装

---

**Status**: 設計確定 ✅（定義B準拠）  
**Version**: v2.0  
**Next**: Phase 5実装開始
