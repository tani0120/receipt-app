# Phase 5 Supabaseå®Ÿè£…ãƒãƒ¼ãƒˆ

## ğŸ“‹ ç›®çš„

ãƒ¢ãƒƒã‚¯ï¼ˆUIãƒ†ã‚¹ãƒˆç”¨ï¼‰ã‹ã‚‰Supabaseï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰ã¸ã®ç§»è¡Œæ‰‹é †ã¨æ³¨æ„äº‹é …ã‚’è¨˜è¼‰

## ğŸ”„ ãƒ¢ãƒƒã‚¯ã¨æœ¬ç•ªã®å·®åˆ†

### ãƒ¢ãƒƒã‚¯å‹å®šç¾©ï¼ˆç¾åœ¨ï¼‰

[journal_phase5_mock.type.ts](file:///C:/dev/receipt-app/src/mocks/types/journal_phase5_mock.type.ts)

**çœç•¥ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰**:
- `client_id`ï¼ˆé¡§å•å…ˆIDï¼‰
- `status_updated_by`ï¼ˆä½œæ¥­è€…IDï¼‰
- `status_updated_at`ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ—¥æ™‚ï¼‰
- `created_at`ã€`updated_at`ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
- `read_at`ã€`exported_at`ã€`deleted_at`ï¼ˆå„ç¨®æ—¥æ™‚ï¼‰
- `exported_by`ã€`deleted_by`ï¼ˆä½œæ¥­è€…æƒ…å ±ï¼‰
- `export_exclude`ã€`export_exclude_reason`ï¼ˆå‡ºåŠ›åˆ¶å¾¡ï¼‰â† å‡ºåŠ›åˆ—å®Ÿè£…æ™‚ã«ãƒ¢ãƒƒã‚¯å‹ã«ã‚‚è¿½åŠ äºˆå®šï¼ˆtask_current Â§2å‚ç…§ï¼‰

### æœ¬ç•ªå‹å®šç¾©ï¼ˆSupabaseå®Ÿè£…æ™‚ï¼‰

**è¿½åŠ ãŒå¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰** â†’ [migration.sql](file:///C:/dev/receipt-app/docs/genzai/02_database_schema/journal/migration.sql)å‚ç…§

## ğŸ“ å®Ÿè£…æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: DDLå®Ÿè¡Œ

```bash
# Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > SQL Editor ã§å®Ÿè¡Œ
psql -h your-project.supabase.co -U postgres -d postgres -f migration.sql
```

ã¾ãŸã¯ã€Supabase CLIä½¿ç”¨:
```bash
supabase migration new phase5_journals
# ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã« migration.sql ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼
supabase db push
```

### ã‚¹ãƒ†ãƒƒãƒ—2: å‹å®šç¾©ã®ä½œæˆ

`src/types/journal.ts`ã‚’æ–°è¦ä½œæˆ:

```typescript
export interface Journal {
  // åŸºæœ¬æƒ…å ±
  id: string;
  client_id: string;                    // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„
  receipt_id: string | null;
  display_order: number;
  transaction_date: string;              // ISO 8601: YYYY-MM-DD
  description: string;

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†
  status: JournalStatus;
  status_updated_at: string;             // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„
  status_updated_by: string;             // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„

  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at: string;                    // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„
  updated_at: string;                    // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„

  // æœªèª­/æ—¢èª­
  is_read: boolean;
  read_at: string | null;                // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„

  // Nå¯¾Nè¤‡åˆä»•è¨³ï¼ˆåˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
  debit_entries: JournalEntry[];
  credit_entries: JournalEntry[];

  // ãƒ©ãƒ™ãƒ«
  labels: JournalLabel[];

  // ãƒ«ãƒ¼ãƒ«é–¢é€£
  rule_id: string | null;
  rule_confidence: number | null;

  // ã‚¤ãƒ³ãƒœã‚¤ã‚¹é–¢é€£
  invoice_status: 'qualified' | 'not_qualified' | null;
  invoice_number: string | null;

  // ãƒ¡ãƒ¢é–¢é€£
  memo: string | null;
  memo_author: string | null;
  memo_target: string | null;
  memo_created_at: string | null;

  // å‡ºåŠ›ç®¡ç†
  exported_at: string | null;            // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„
  exported_by: string | null;            // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„
  export_exclude: boolean;               // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„ï¼ˆå‡ºåŠ›åˆ—å®Ÿè£…æ™‚ã«è¿½åŠ äºˆå®šï¼‰
  export_exclude_reason: string | null;  // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„ï¼ˆå‡ºåŠ›åˆ—å®Ÿè£…æ™‚ã«è¿½åŠ äºˆå®šï¼‰

  // ã‚´ãƒŸç®±
  deleted_at: string | null;             // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„
  deleted_by: string | null;             // â† ãƒ¢ãƒƒã‚¯ã«ã¯ãªã„
}
```

```typescript
import type { Yen } from '@/shared/types/yen'

export interface JournalEntry {
  id: string;
  journal_id: string;
  entry_type: 'debit' | 'credit';
  line_number: number;
  account: string;
  sub_account: string | null;
  amount: Yen;
  tax_category: string | null;
  created_at: string;
}
```

### ã‚¹ãƒ†ãƒƒãƒ—3: Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®š

```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseKey);
```

### ã‚¹ãƒ†ãƒƒãƒ—4: APIå±¤ã®å®Ÿè£…

```typescript
// src/api/journals.ts
import { supabase } from '@/lib/supabase';
import type { Journal } from '@/types/journal';

export async function getJournals(clientId: string): Promise<Journal[]> {
  const { data, error } = await supabase
    .from('journals')
    .select(`
      *,
      debit_entries:journal_entries!journal_id(entry_type, line_number, account, sub_account, amount, tax_category),
      credit_entries:journal_entries!journal_id(entry_type, line_number, account, sub_account, amount, tax_category)
    `)
    .eq('client_id', clientId)
    .is('deleted_at', null)
    .order('display_order', { ascending: true });

  if (error) throw error;
  return data as Journal[];
}

export async function updateJournal(
  journalId: string,
  updates: Partial<Journal>,
  userId: string
): Promise<Journal> {
  // ã‚¬ãƒ¼ãƒ‰å¥: exportedã¯ç·¨é›†ä¸å¯
  const { data: current } = await supabase
    .from('journals')
    .select('status')
    .eq('id', journalId)
    .single();

  if (current?.status === 'exported') {
    throw new Error('CSVå‡ºåŠ›æ¸ˆã¿ã®ä»•è¨³ã¯ç·¨é›†ã§ãã¾ã›ã‚“');
  }

  const { data, error } = await supabase
    .from('journals')
    .update({
      ...updates,
      status_updated_by: userId,
      status_updated_at: new Date().toISOString()
    })
    .eq('id', journalId)
    .select()
    .single();

  if (error) throw error;
  return data as Journal;
}
```

### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥

```typescript
// scripts/seed-journals.ts
import { supabase } from '@/lib/supabase';
import { mockJournalsPhase5 } from '@/mocks/data/journal_test_fixture_30cases';

async function seedJournals() {
  const clientId = 'your-client-id';
  const userId = 'your-user-id';

  for (const mock of mockJournalsPhase5) {
    // journals ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥
    const { data: journal, error: journalError } = await supabase
      .from('journals')
      .insert({
        client_id: clientId,
        display_order: mock.display_order,
        transaction_date: mock.transaction_date,
        description: mock.description,
        receipt_id: mock.receipt_id,
        status: mock.status,
        status_updated_by: userId,
        is_read: mock.is_read,
        labels: mock.labels,
        rule_id: mock.rule_id,
        rule_confidence: mock.rule_confidence,
        invoice_status: mock.invoice_status,
        invoice_number: mock.invoice_number,
        memo: mock.memo,
        memo_author: mock.memo_author,
        memo_target: mock.memo_target,
        memo_created_at: mock.memo_created_at
      })
      .select()
      .single();

    if (journalError) throw journalError;

    // journal_entries ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ï¼ˆå€Ÿæ–¹ï¼‰
    for (let i = 0; i < mock.debit_entries.length; i++) {
      const entry = mock.debit_entries[i];
      await supabase.from('journal_entries').insert({
        journal_id: journal.id,
        entry_type: 'debit',
        line_number: i + 1,
        account: entry.account,
        sub_account: entry.sub_account,
        amount: entry.amount,
        tax_category: entry.tax_category
      });
    }

    // journal_entries ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ï¼ˆè²¸æ–¹ï¼‰
    for (let i = 0; i < mock.credit_entries.length; i++) {
      const entry = mock.credit_entries[i];
      await supabase.from('journal_entries').insert({
        journal_id: journal.id,
        entry_type: 'credit',
        line_number: i + 1,
        account: entry.account,
        sub_account: entry.sub_account,
        amount: entry.amount,
        tax_category: entry.tax_category
      });
    }
  }

  console.log('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ãŒå®Œäº†ã—ã¾ã—ãŸ');
}

seedJournals();
```

## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

### 1. exportedã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¬ãƒ¼ãƒ‰

**å¿…é ˆ**: APIå±¤ã§ä»¥ä¸‹ã®ã‚¬ãƒ¼ãƒ‰å¥ã‚’å®Ÿè£…

```typescript
if (journal.status === 'exported') {
  throw new BusinessRuleError(
    'CSVå‡ºåŠ›æ¸ˆã¿ã®ä»•è¨³ã¯ç·¨é›†ã§ãã¾ã›ã‚“ã€‚' +
    'MFå´ã§ä¿®æ­£ã™ã‚‹ã‹ã€ç®¡ç†è€…ã«å•ã„åˆã‚ã›ã¦ãã ã•ã„ã€‚',
    'EXPORTED_JOURNAL_READONLY'
  );
}
```

### 2. RLSï¼ˆRow Level Securityï¼‰

**å¿…é ˆ**: é¡§å•å…ˆIDã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚’è¨­å®š

```sql
CREATE POLICY journals_client_isolation ON journals
  FOR ALL
  USING (client_id = auth.uid()::uuid OR auth.jwt() ->> 'role' = 'admin');
```

### 3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†

CSVå‡ºåŠ›æ™‚ã¯å¿…ãšãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å‡¦ç†:

```typescript
async function exportToCSV(clientId: string, userId: string) {
  const { data, error } = await supabase.rpc('export_journals', {
    p_client_id: clientId,
    p_user_id: userId
  });

  if (error) throw error;
  return data;
}
```

å¯¾å¿œã™ã‚‹SQL Function:
```sql
CREATE OR REPLACE FUNCTION export_journals(
  p_client_id UUID,
  p_user_id UUID
) RETURNS TABLE(filename TEXT, count INTEGER) AS $$
DECLARE
  v_batch_id UUID;
  v_filename TEXT;
  v_count INTEGER;
BEGIN
  -- 1. ãƒãƒƒãƒä½œæˆ
  INSERT INTO export_batches (client_id, exported_by)
  VALUES (p_client_id, p_user_id)
  RETURNING id, filename INTO v_batch_id, v_filename;

  -- 2. ä»•è¨³ã‚’exportedã«æ›´æ–°
  UPDATE journals
  SET status = 'exported',
      exported_at = NOW(),
      exported_by = p_user_id
  WHERE client_id = p_client_id
    AND status IS NULL  -- æœªå‡ºåŠ›ã®ã¿å¯¾è±¡
    AND export_exclude = FALSE
  RETURNING id INTO v_count;

  RETURN QUERY SELECT v_filename, v_count;
END;
$$ LANGUAGE plpgsql;
```

## ğŸ§ª å‹•ä½œç¢ºèª

### 1. DDLç¢ºèª

```sql
\d journals
\d journal_entries
\d export_batches
\d journal_exports
```

### 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèª

```sql
\di journals*
```

### 3. CHECKåˆ¶ç´„ç¢ºèª

```sql
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conrelid = 'journals'::regclass
  AND contype = 'c';
```

### 4. RLSç¢ºèª

```sql
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename = 'journals';
```

## ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«é…ç½®

```
docs/genzai/02_database_schema/journal/
â”œâ”€â”€ journal_v2_20260214.md    # è¨­è¨ˆæ›¸ï¼ˆæ—¢å­˜ï¼‰
â”œâ”€â”€ migration.sql              # DDLï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”œâ”€â”€ å®Ÿè£…ãƒãƒ¼ãƒˆ.md              # æœ¬ãƒ•ã‚¡ã‚¤ãƒ«
â””â”€â”€ APIè¨­è¨ˆæ›¸.md               # æ¬¡ã«ä½œæˆ

src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ journal.ts             # æœ¬ç•ªå‹å®šç¾©ï¼ˆæ–°è¦ä½œæˆï¼‰
â”œâ”€â”€ api/
â”‚   â””â”€â”€ journals.ts            # APIå±¤ï¼ˆæ–°è¦ä½œæˆï¼‰
â””â”€â”€ lib/
    â””â”€â”€ supabase.ts            # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆæ–°è¦ä½œæˆï¼‰
```

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] migration.sqlå®Ÿè¡Œ
- [ ] å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆjournal.tsï¼‰
- [ ] Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
- [ ] APIå±¤å®Ÿè£…ï¼ˆjournals.tsï¼‰
- [ ] ã‚¬ãƒ¼ãƒ‰å¥å®Ÿè£…ï¼ˆexportedãƒã‚§ãƒƒã‚¯ï¼‰
- [ ] RLSè¨­å®š
- [ ] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŠ•å…¥
- [ ] å‹•ä½œç¢ºèªï¼ˆDDLã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€CHECKåˆ¶ç´„ã€RLSï¼‰
- [ ] ãƒ¢ãƒƒã‚¯ã‹ã‚‰ã®åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ

---

## ğŸ¨ ãƒ©ãƒ™ãƒ«æ“ä½œUIå®Ÿè£…æ‰‹é †

### 1. è¦å¯¾å¿œåˆ—ã®è¿½åŠ 

#### è¡¨ç¤ºä»•æ§˜

| ã‚¢ã‚¤ã‚³ãƒ³ | ãƒ©ãƒ™ãƒ« | æ„å‘³ | è‰²ï¼ˆéé¸æŠæ™‚ï¼‰| è‰²ï¼ˆé¸æŠæ™‚ï¼‰|
|---------|-------|------|------------|-----------|
| ğŸ“„ | `NEED_DOCUMENT` | è³‡æ–™ãŒå¿…è¦ | `text-gray-400` | `text-red-600` |
| âœ… | `NEED_CONFIRM` | ç¢ºèªãŒå¿…è¦ | `text-gray-400` | `text-red-600` |
| ğŸ’¬ | `NEED_CONSULT` | ç›¸è«‡ãŒå¿…è¦ | `text-gray-400` | `text-red-600` |

#### HTMLæ§‹é€ 

```vue
<!-- JournalListLevel3Mock.vue -->
<template>
  <td class="px-2 py-1 text-center">
    <div class="flex gap-1 justify-center">
      <!-- è³‡æ–™ã‚¢ã‚¤ã‚³ãƒ³ -->
      <button 
        @click="toggleNeed(journal.id, 'NEED_DOCUMENT')"
        :class="journal.labels.includes('NEED_DOCUMENT') 
          ? 'text-red-600' 
          : 'text-gray-400'"
        class="hover:scale-110 transition-transform"
        title="è³‡æ–™ãŒå¿…è¦"
      >
        ğŸ“„
      </button>
      
      <!-- ç¢ºèªã‚¢ã‚¤ã‚³ãƒ³ -->
      <button 
        @click="toggleNeed(journal.id, 'NEED_CONFIRM')"
        :class="journal.labels.includes('NEED_CONFIRM') 
          ? 'text-red-600' 
          : 'text-gray-400'"
        class="hover:scale-110 transition-transform"
        title="ç¢ºèªãŒå¿…è¦"
      >
        âœ…
      </button>
      
      <!-- ç›¸è«‡ã‚¢ã‚¤ã‚³ãƒ³ -->
      <button 
        @click="toggleNeed(journal.id, 'NEED_CONSULT')"
        :class="journal.labels.includes('NEED_CONSULT') 
          ? 'text-red-600' 
          : 'text-gray-400'"
        class="hover:scale-110 transition-transform"
        title="ç›¸è«‡ãŒå¿…è¦"
      >
        ğŸ’¬
      </button>
    </div>
  </td>
</template>
```

---

### 2. toggleNeedé–¢æ•°ã®å®Ÿè£…

```typescript
// JournalListLevel3Mock.vue <script setup>
function toggleNeed(
  journalId: string, 
  label: 'NEED_DOCUMENT' | 'NEED_CONFIRM' | 'NEED_CONSULT'
) {
  const journal = mockJournalsPhase5.value.find(j => j.id === journalId);
  if (!journal) {
    console.error(`Journal not found: ${journalId}`);
    return;
  }
  
  const index = journal.labels.indexOf(label);
  if (index > -1) {
    // å‰Šé™¤
    journal.labels.splice(index, 1);
    console.log(`Label removed: ${label} from ${journalId}`);
  } else {
    // è¿½åŠ 
    journal.labels.push(label);
    journal.is_read = false;  // è¦å¯¾å¿œãƒ•ãƒ©ã‚°ãŒç«‹ã£ãŸã‚‰æœªèª­ã«ã™ã‚‹
    console.log(`Label added: ${label} to ${journalId}, set to unread`);
  }
}
```

---

### 3. APIå®Ÿè£…ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

```typescript
// src/api/journals.ts
export async function toggleNeedLabel(
  journalId: string,
  label: 'NEED_DOCUMENT' | 'NEED_CONFIRM' | 'NEED_CONSULT',
  userId: string
): Promise<Journal> {
  // ã‚¬ãƒ¼ãƒ‰å¥: å‡ºåŠ›æ¸ˆã¿ãƒã‚§ãƒƒã‚¯
  const { data: current } = await supabase
    .from('journals')
    .select('status, labels, is_read')
    .eq('id', journalId)
    .single();
  
  if (!current) throw new NotFoundError('ä»•è¨³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  if (current.status === 'exported') {
    throw new BusinessRuleError('CSVå‡ºåŠ›æ¸ˆã¿ã®ä»•è¨³ã¯ç·¨é›†ã§ãã¾ã›ã‚“');
  }
  
  const labels = current.labels || [];
  const index = labels.indexOf(label);
  
  let newLabels: string[];
  let newIsRead: boolean;
  
  if (index > -1) {
    newLabels = labels.filter(l => l !== label);
    newIsRead = current.is_read;
  } else {
    newLabels = [...labels, label];
    newIsRead = false;
  }
  
  const { data, error } = await supabase
    .from('journals')
    .update({
      labels: newLabels,
      is_read: newIsRead,
      updated_at: new Date().toISOString()
    })
    .eq('id', journalId)
    .select()
    .single();
  
  if (error) throw error;
  return data as Journal;
}
```

---

### 4. ãƒ†ã‚¹ãƒˆé …ç›®

- [ ] å„ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è‰²ãŒå¤‰ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ©ãƒ™ãƒ«ãŒè¿½åŠ /å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ•ãƒ©ã‚°è¿½åŠ æ™‚ã«æœªèª­ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] è¤‡æ•°ã®ãƒ•ãƒ©ã‚°ã‚’åŒæ™‚ã«ç«‹ã¦ã‚‰ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] å‡ºåŠ›æ¸ˆã¿ä»•è¨³ã¯ç·¨é›†ä¸å¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
