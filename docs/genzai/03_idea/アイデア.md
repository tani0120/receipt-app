# 実装アイデア集

**作成日**: 2026-02-11  
**情報源**: Phase A概要、kakuninフォルダ、統合ロードマップ、会話ログ  
**目的**: 将来実装したい機能・改善アイデアの記録


---

## 📊 実装アイデア優先順位マトリックス

| 優先度 | アイデア | 説明 |
|---|---|---|
| **最高** | TD-001型定義修正 | 複数ファイルにわたる型定義の不一致を修正（src/types, domain, features） |
| **最高** | バックエンドAPI 404エラー修正 | Cloud Run APIの404エラー、Firestore権限エラーの解消 |
| **最高** | 3つの選択肢提示UI | 過去ルール／会計ルール／AI推論から選択して仕訳確定（核心機能） |
| **最高** | labelシステム（人間タスクサポート） | NEEDS_INFO時に「なぜ判断できないか」を可視化、タスク化、備忘録化 |
| **最高** | 完全ワークフローUI | Drive→バッチ→進捗管理→仕訳→承認→CSV出力の完全フロー |
| **最高** | 顧問先別進捗管理UI（Screen B） | 新規分と積み残しタスクを可視化、期限管理、タスク一覧表示 |
| **最高** | OCR最適化（傾き補正・正規化） | 必須5施策で85%→92%、金額ルール化でLLM禁止、コスト削減 |
| **高** | ルール学習機能（1回案） | ユーザーが明示的に「ルール化する」を選択してルール生成 |
| **高** | 過去仕訳検索機能 | 過去3-10回の仕訳を列挙、「あの時どうしたっけ？」確認 |
| **高** | PostgreSQL Trigger実装 | status変更時の自動監査ログ、approved後の編集防止 |
| **高** | 自動化率安全弁（85%上限） | 残り15%を強制的に人間レビュー、金額・重要度ブレーキ |
| **高** | 開発Firebase環境構築 | 本番データと分離したテスト環境 |
| **高** | Console警告12件修正 | Vue Devtools警告、未使用import、型エラー（Journal domain） |
| **高** | GAS実装（バックエンド自動化） | Drive監視、OCRバッチ、AI推論バッチ、結果通知 |
| **高** | タスク管理機能 | NEEDS_INFOの仕訳を自動タスクリスト化、期限管理、顧問先別レポート |
| **高** | コメント機能 | スタッフ・上席が協力的にコメントでコ ミュニケーション、履歴保存 |
| **高** | ベンダー名正規化辞書 | fuzzy matching（Levenshtein距離）で店名一致率向上 |
| **中** | 会計ルール選択肢のデータソース確定 | 税理士事前登録／業界標準DB／全顧問先統計のどれか |
| **中** | ルール劣化・破棄ロジック | decay_score計算、AUTO_RULE → SUGGEST_ONLY → DISABLED降格 |
| **中** | GA + AI正規化（最適化エンジン） | GA で重み探索、AIは境界判定のみ、15円/枚制約 |
| **中** | イベント駆動設計の完全実装 | Firestore（イベントログ）+ PostgreSQL（現在状態）完全分離 |
| **中** | AI Prompt設計改善 | プロンプトテンプレート標準化、顧問先マスタ組み込み、税計算明示化 |
| **中** | ルール化UI詳細化 | ルール名編集、適用範囲選択、有効期限設定 |
| **中** | label自動解除・履歴管理 | status変更時のlabel保持確認、audit_logs記録 |
| **低** | ルール管理画面 | 登録済みルール一覧、有効/無効切り替え、優先順位変更、decay_score可視化 |
| **低** | ルール学習機能（2回案） | 2回目の自動成功でルール化提案（代替案） |
| **低** | モバイル対応 | レスポンシブデザイン、モバイル専用UI |
| **低** | エクスポート機能強化 | 弥生・MF・freee以外への対応、カスタムCSV |
| **低** | レポート機能 | 月次レポート自動生成、グラフ表示、PDF出力 |
| **低** | マネーフォワードAPI連携 | 仕訳データの自動同期、勘定科目マッピング |
| **低** | 顧問先用資料共有アプリ | スマホから簡単アップロード、プッシュ通知 |

---

## 🎯 実装アイデア詳細

### 1. ルール学習機能（AI学習システム）

#### 概要
ユーザーの修正や承認に基づいて、自動的に仕訳ルールを学習・生成する機能。

#### 詳細
**学習の種3種**:
1. **制約失敗学習**: AIの提案がNGだった場合
2. **人修正学習**: ユーザーが手動修正した場合
3. **自動成功学習**: AIの提案がそのまま承認された場合

**顧問先ローカルルール生成条件（1回案採用）**:
- ユーザーが明示的に「ルール化する」を選択
- 全体ルールとの矛盾がない
- 信頼度スコアが閾値以上

**1回案（採用決定 2026-02-11）**:
- ユーザーが明示的に「ルール化する」を選択
- UI: RuleConfirmationModal.vue
- Phase A価値定義「変更や理由を人間が制御」に完全一致

**実装優先度**: 高  
**依存**: Phase 4完了  
**参照**: [verification_A04_comparison.md](file:///C:/Users/kazen/.gemini/antigravity/brain/b317fb3f-1c5a-46ab-9b80-d50923f2ae26/verification_A04_comparison.md)

---

### 2. ルール劣化・破棄ロジック

#### 概要
学習したル ールが時間経過や状況変化で不適切になった場合、自動的に劣化させる機能。

#### 劣化検知の3シグナル
1. **修正率の上昇**: ルール適用後に人間が修正する頻度
2. **confidence低下**: AIの信頼度スコアの低下
3. **時間経過**: 長期間使用されていないルール

#### decay_score計算式
```
decay_score = (修正率 × 0.5) + (1 - confidence) × 0.3 + (経過日数 / 365) × 0.2
```

#### 降格フロー
```
AUTO_RULE (自動適用)
  ↓ decay_score > 0.3
SUGGEST_ONLY (提案のみ、自動適用なし)
  ↓ decay_score > 0.6
DISABLED (完全無効化)
```

**実装優先度**: 中  
**依存**: ルール学習機能  
**参照**: [concept_phaseA_overview_260208.md](file:///C:/Users/kazen/.gemini/antigravity/brain/b317fb3f-1c5a-46ab-9b80-d50923f2ae26/concept_phaseA_overview_260208.md) 9章

---

### 3. GA + AI 正規化（最適化エンジン）

#### 概要
遺伝的アルゴリズム（GA）で重み探索、AIは境界判定のみ行う最適化システム。

#### 役割分担
- **GAの役割**: ルールの重み探索（どの条件を優先するか）
- **AIの役割**: 境界判定のみ（例: 類似度何%以上でルール適用か）
- **重要**: AIは「例外処理装置」であり、主処理系ではない

#### コスト配分
- 1枚あたり15円制約
- GA最適化により、AIコールを最小限に抑える

**実装優先度**: 中  
**依存**: ルール学習機能、大量データ蓄積  
**参照**: [concept_phaseA_overview_260208.md](file:///C:/Users/kazen/.gemini/antigravity/brain/b317fb3f-1c5a-46ab-9b80-d50923f2ae26/concept_phaseA_overview_260208.md) 10章

---

### 4. 自動化率安全弁

#### 概要
自動化率に上限を設け、全てが自動化されて人間がチェックしなくなるリスクを防ぐ。

#### 上限85%制限の根拠
- 残り15%は必ず人間がレビュー
- 「人間が見ていないとヤバい」案件を強制的に人間に回す

#### 金額・重要度ブレーキ
```
if (金額 > 100万円 || 重要度 == 'HIGH') {
  自動化率 = Math.min(自動化率, 70%);
}
```

#### 定期リセット
- 3ヶ月ごとにルールの再評価
- 自動化率を一時的に下げて、人間の目を入れる

**実装優先度**: 高  
**依存**: ルール学習機能  
**参照**: [concept_phaseA_overview_260208.md](file:///C:/Users/kazen/.gemini/antigravity/brain/b317fb3f-1c5a-46ab-9b80-d50923f2ae26/concept_phaseA_overview_260208.md) 11章

---

### 5. PostgreSQL Trigger実装

#### 概要
status変更時の自動監査ログ記録や、approved後の編集防止を実装。

#### trigger種類
1. **auto_audit_log**: status変更時の自動監査ログ
```sql
CREATE TRIGGER auto_audit_log
AFTER UPDATE OF status ON journals
FOR EACH ROW
EXECUTE FUNCTION log_status_change();
```

2. **no_edit_after_approval**: approved後の編集防止
```sql
ALTER TABLE journals
ADD CONSTRAINT no_edit_after_approval
CHECK (
  (status = 'approved' AND updated_at = created_at)
  OR (status != 'approved')
);
```

**実装優先度**: 高  
**依存**: Phase A完了  
**実装時期**: Phase 5  
**参照**: [integrated_roadmap Day 5-6](file:///C:/Users/kazen/.gemini/antigravity/brain/b317fb3f-1c5a-46ab-9b80-d50923f2ae26/integrated_roadmap_phaseA_phase4_260211.md)

---

### 6. イベント駆動設計の完全実装

#### 概要
Firestoreイベントログ + PostgreSQL現在状態の完全分離。

#### イベント種類
```
receipt.uploaded
receipt.preprocessed
receipt.ocr_done
journal.suggested
journal.needs_info
journal.approved（不可逆）
```

#### イベント → status マッピング
- `journal.suggested` → status: 'submitted'
- `journal.needs_info` → status: 'needs_info'
- `journal.approved` → status: 'approved'（不可逆）

#### Firestore vs PostgreSQL役割
| DB | 役割 | 用途 |
|---|---|---|
| **Firestore** | イベントログ（過程の記録） | 「いつ何が起きたか」の完全履歴 |
| **PostgreSQL** | 現在状態（単一の真実） | 「今どうなっているか」の確定状態 |

**実装優先度**: 中  
**依存**: Phase A完了  
**参照**: [integrated_roadmap Day 6](file:///C:/Users/kazen/.gemini/antigravity/brain/b317fb3f-1c5a-46ab-9b80-d50923f2ae26/integrated_roadmap_phaseA_phase4_260211.md)

---

## 🔧 技術的負債の解消

### TD-001: 型定義のミスマッチ修正

#### 概要
複数ファイルにわたる型定義の不一致を修正。

#### 影響ファイル
- `src/types/*.ts`
- `src/domain/*.ts`
- `src/features/*.ts`

**実装優先度**: 最高  
**実装時期**: Phase 5開始前  
**参照**: [TECH-DEBT.md](file:///C:/dev/receipt-app/docs/_archive_legacy/kakunin/TECH-DEBT.md)

---

### 開発Firebase プ

ロジェクト作成

#### 概要
本番データに影響を与えずにテストできる開発環境の構築。

#### 理由
- 現在は本番Firebaseのみ
- テストデータと本番データが混在するリスク

**実装優先度**: 高  
**依存**: 本番データが蓄積されてから  
**参照**: [PROJECT_STATUS.md](file:///C:/dev/receipt-app/docs/_archive_legacy/kakunin/PROJECT_STATUS.md)

---

## 🚀 UI/UX改善アイデア

### 1. ルール化UI（RuleConfirmationModal）の詳細化

#### 現状（Phase 4実装予定）
```
仕訳完了！次回この条件の取引を：
[ ルール化する（次回自動提示）]
[ 例外として扱う（毎回確認）]
```

#### 改善案（Phase 5以降）
- ルール適用条件のプレビュー
- ルール名の編集
- 適用範囲の選択（全社 or 顧問先限定）
- 有効期限の設定

---

### 2. ルール管理画面

#### 機能
- 登録済みルールの一覧表示
- ルールの有効/無効切り替え
- ルールの優先順位変更
- decay_scoreの可視化

---

### 3. Console警告12件の修正

#### Phase 2で残された警告
- Vue Devtools警告
- 未使用import
- TypeScript型エラー（Journal domain）

**実装優先度**: 高  
**実装時期**: Phase 4 Day 14

---

## 📊 バックエンド自動化（Phase 5）

### GAS（Google Apps Script）実装計画

#### 必要性
- Google Drive上のファイル操作
- 定期的なAI解析バッチ
- ファイル移動

#### 実装内容
1. Drive監視スクリプト
2. OCRバッチ処理
3. AI推論バッチ
4. 結果通知

**実装優先度**: 高  
**依存**: Phase 4完了  
**参照**: [system_design.md](file:///C:/dev/receipt-app/docs/_archive_legacy/kakunin/system_design.md)

---

### バックエンドAPI 404エラー修正

#### 現状
- Cloud Run APIで404エラー発生
- Firestore権限エラーが一部残存

**実装優先度**: 最高  
**実装時期**: Phase 5開始直後

---

## 🎨 AI Prompt設計改善

### 問題点
- 税計算の曖昧性
- 勘定科目選択の不明確性
- 顧問先情報の未反映

### 改善案
1. プロンプトテンプレートの標準化
2. 顧問先マスタデータの組み込み
3. 税計算ロジックの明示化

**実装優先度**: 中  
**依存**: Phase 5 GAS実装


---

## 💡 人間タスクサポートUI（labelシステム）

### 概要
仕訳判断が不可能な場合に、「なぜ判断できないか／何を待っているか」を可視化し、タスク化・備忘録化する機能。「資料依頼」「内容確認」などの人間のタスクをサポート。

### label（判断メモ / タグ）の定義

**役割**:
- 顧問先への確認事項の備忘
- 追加資料待ちの可視化
- 担当者自身の作業メモ

**特徴**:
- statusとは独立（複数付与可能）
- UI上はバッジ・タグ・メモとして表示
- label があるから status を増やさなくて済む

### 代表的なlabel例

| label | 説明 | 対応アクション |
|---|---|---|
| **領収書不足** | 領収書の提出待ち | 顧問先へ資料依頼 |
| **用途不明** | 取引の用途が不明 | 顧問先へ内容確認 |
| **取引先確認中** | 取引先名称の確認待ち | 顧問先へ問い合わせ |
| **課税区分未確定** | 課税/非課税の判断保留 | 税理士へ確認 |
| **後でまとめて判断** | 類似案件をまとめて処理 | 自分のタスク |
| **金額疑義** | 記載金額に疑義あり | 顧問先へ再確認 |
| **複数取引混在** | 1枚のレシートに複数取引 | 分割仕訳検討 |

### status との関係

#### NEEDS_INFO status
仕訳判断が不能な状態。必ず label を付与して「理由」を明示。

```
status = NEEDS_INFO
label = ["領収書不足", "用途不明"]
```

#### READY_FOR_WORK status
仕訳判断が可能だが、メモを残したい場合。

```
status = READY_FOR_WORK
label = ["後でまとめて判断"]
```

---

### UI設計案

#### 仕訳画面
```
┌─────────────────────────────────────┐
│ 仕訳ID: #12345                      │
│ status: NEEDS_INFO                  │
│                                      │
│ 🏷️ label:                           │
│   [ 領収書不足 ] [ 用途不明 ]       │
│                                      │
│ ┌─────────────────────────────────┐ │
│ │ 備考メモ:                         │ │
│ │ 顧問先へ領収書再発行を依頼中     │ │
│ │ 用途は交通費の可能性あり         │ │
│ └─────────────────────────────────┘ │
│                                      │
│ [ ラベル追加 ]  [ 仕訳保留 ]        │
└─────────────────────────────────────┘
```

#### ラベル追加モーダル
```
┌─────────────────────────────────────┐
│ ラベルを選択                         │
├─────────────────────────────────────┤
│ よく使うラベル:                     │
│ ☐ 領収書不足                        │
│ ☐ 用途不明                          │
│ ☐ 取引先確認中                      │
│ ☐課税区分未確定                    │
│                                      │
│ カスタムラベル:                     │
│ [ 新しいラベルを入力... ]           │
│                                      │
│ [ キャンセル ]  [ 追加 ]            │
└─────────────────────────────────────┘
```

---

### タスク管理機能（Phase 5以降）

#### タスク一覧画面
NEEDS_INFO の仕訳を自動的にタスクリスト化。

```
┌─────────────────────────────────────┐
│ 📋 未解決タスク (3件)                │
├─────────────────────────────────────┤
│ □ #12345: 領収書不足、用途不明      │
│   顧問先: ABC株式会社               │
│   期限: 2026-02-15                  │
│                                      │
│ □ #12346: 取引先確認中              │
│   顧問先: XYZ商事                   │
│   期限: 2026-02-18                  │
│                                      │
│ □ #12347: 課税区分未確定            │
│   顧問先: DEF工業                    │
│   期限: 2026-02-20                  │
└─────────────────────────────────────┘
```

---

### 顧問先別レポート機能

#### 確認事項リスト自動生成
顧問先ごとに確認事項を集約して、一括依頼メール生成。

```
【○○株式会社様 確認事項】

以下の取引について、追加資料・情報をご提供ください。

1. #12345 (2026-01-15)
   - 領収書不足: Amazon購入の領収書を再発行してください
   - 用途不明: 「オフィス用品」の具体的な内容を教えてください

2. #12348 (2026-01-20)
   - 取引先確認中: 「ABC商店」の正式名称を教えてください

お手数ですが、2026-02-15までにご回答ください。
```

---

### label のライフサイクル

#### 自動解除
```
status が NEEDS_INFO → READY_FOR_WORK に変更
→ label を保持するか確認
   [ ☑ ラベルを解除 ]
   [ ☐ ラベルを保持（備忘として残す）]
```

#### 履歴保存
```
label の付与・解除履歴を audit_logs に記録:
- 誰が
- いつ
- どのlabelを
- 付与/解除したか
```

---

### メリット

1. **タスク漏れ防止**
   - NEEDS_INFO の仕訳が「忘れられる」リスクを排除
   - label で理由が明確

2. **顧問先とのコミュニケーション効率化**
   - 確認事項を一括管理
   - 依頼メール自動生成

3. **作業の優先順位付け**
   - 期限付きタスク化
   - 重要度でフィルタリング

4. **監査証跡**
   - 「なぜ判断できなかったか」の記録
   - label 履歴で経緯が追跡可能

---

### 実装上の検討事項

1. **label の保存粒度**
   - entry単位？ line単位？
   - → entry単位（仕訳全体に対する判断）

2. **label のマスタ管理**
   - 自由入力 vs プリセット？
   - → プリセット + カスタム追加可能

3. **通知機能**
   - NEEDS_INFO が一定期間放置 → アラート
   - period_endまで残り3日 → 警告

4. **権限管理**
   - 誰がlabelを付与/解除できるか
   - → 担当者 + 上席のみ

---

## 💡 完全ワークフローUI（Drive → 進捗管理 → 仕訳 → 承認 → CSV出力）

### 概要
Google Driveへの資料保存から会計ソフトCSV出力までの完全なワークフロー。**顧問先別進捗管理UI**で積み残しタスクと新規分を可視化し、スタッフ・上席が協力してラベル・タスク管理を行う。

---

### 完全ワークフロー図

```
┌─────────────────────────────────────┐
│ 1. Google Drive                     │
│    顧問先が資料保存                 │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 2. 夜間バッチ処理（GAS）            │
│    - 過去ルールに基づく仕訳推論     │
│    - AI推論（ルールなしの場合）     │
│    - 仕訳UIへ送信                   │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 3. 顧問先別進捗管理UI（Screen B）  │
│    [仕訳可能: 5件]                  │
│    [積み残しタスク: 2件]            │
│      - 領収書不足（顧問先確認中）   │
│      - 用途不明（顧問先確認中）     │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 4. 仕訳UI（Screen E）               │
│    - 新規分（READY_FOR_WORK）       │
│    - 積み残し（NEEDS_INFO）         │
│      ※分離表示                      │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 5. 1次処理者（スタッフ）            │
│    a) 仕訳処理 → SUBMITTED          │
│    b) ラベル・タスク付与            │
│       → NEEDS_INFO + コメント       │
│    c) 積み残し処理                  │
│       → ラベル・タスク維持          │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 6. 上席                             │
│    a) 承認 → APPROVED               │
│    b) 修正 → SUBMITTED              │
│    c) ラベル・タスク付与            │
│       → NEEDS_INFO + コメント       │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 7. CSV出力                          │
│    ※APPROVED のみ出力               │
│    ※NEEDS_INFO は出力されない       │
└─────────────────────────────────────┘
```

---

### 顧問先別進捗管理UI（Screen B）

#### 画面構成
```
┌─────────────────────────────────────────┐
│ 顧問先: ABC株式会社                     │
│ 担当: 山田太郎                          │
├─────────────────────────────────────────┤
│ 📊 進捗状況                             │
│                                          │
│ ✅ 資料受領: 5件                        │
│ ✅ AI解析: 完了                         │
│ ⚠️ 1次仕訳:                             │
│    - 仕訳可能: 5件                      │
│    - 積み残しタスク: 2件                │
│                                          │
│ ┌─────────────────────────────────────┐ │
│ │ 📋 積み残しタスク (2件)              │ │
│ │                                      │ │
│ │ ❌ #12345: 領収書不足                │ │
│ │    期限: 2026-02-15                  │ │
│ │    コメント: 顧問先へ再発行依頼中   │ │
│ │                                      │ │
│ │ ❌ #12346: 用途不明                  │ │
│ │    期限: 2026-02-18                  │ │
│ │    コメント: 顧問先へ確認依頼送信済 │ │
│ └─────────────────────────────────────┘ │
│                                          │
│ [ 入力開始 ]  [ タスク一覧 ]            │
└─────────────────────────────────────────┘
```

---

### 仕訳UI（Screen E）

#### 新規分と積み残しの分離表示
```
┌─────────────────────────────────────────┐
│ 仕訳ワークベンチ                        │
├─────────────────────────────────────────┤
│ 📁 タブ選択:                            │
│   [ 新規分 (5) ]  [ 積み残し (2) ]     │
├─────────────────────────────────────────┤
│ ※現在: 新規分タブ                      │
│                                          │
│ 仕訳ID: #12347                          │
│ status: READY_FOR_WORK                  │
│                                          │
│ [画像プレビュー]  [仕訳データ]         │
│                                          │
│ [ 承認 ]  [ 情報不足 ]  [ 除外 ]       │
└─────────────────────────────────────────┘
```

#### 積み残しタブ
```
┌─────────────────────────────────────────┐
│ 仕訳ワークベンチ                        │
├─────────────────────────────────────────┤
│ 📁 タブ選択:                            │
│   [ 新規分 (5) ]  [ 積み残し (2) ]     │
├─────────────────────────────────────────┤
│ ※現在: 積み残しタブ                    │
│                                          │
│ 仕訳ID: #12345                          │
│ status: NEEDS_INFO                      │
│ 🏷️ label: [ 領収書不足 ]               │
│                                          │
│ 💬 コメント履歴:                        │
│   2026-02-10 山田: 顧問先へ再発行依頼  │
│   2026-02-11 顧問先: 再発行手配中      │
│                                          │
│ [画像プレビュー]  [仕訳データ]         │
│                                          │
│ [ タスク完了 ]  [ コメント追加 ]       │
└─────────────────────────────────────────┘
```

---

### スタッフ（1次処理者）の操作フロー

#### パターン1: 仕訳処理
```
1. 仕訳確認
2. 修正（必要に応じて）
3. [ 承認 ] ボタン押下
   → status = SUBMITTED（上席確認待ち）
```

#### パターン2: ラベル・タスク付与
```
1. 仕訳確認
2. 「情報不足で判断できない」と判断
3. [ 情報不足 ] ボタン押下
   ↓
   ┌─────────────────────────────┐
   │ ラベルを選択                │
   │ ☑ 領収書不足                │
   │ ☐ 用途不明                  │
   │                              │
   │ コメント:                   │
   │ ┌─────────────────────────┐ │
   │ │顧問先へ領収書再発行依頼 │ │
   │ └─────────────────────────┘ │
   │                              │
   │ [ 確定 ]                    │
   └─────────────────────────────┘
   ↓
   status = NEEDS_INFO
   自動的にタスク生成
```

#### パターン3: 積み残し処理
```
積み残しタブから選択
↓
顧問先から資料が届いた
↓
仕訳処理
↓
[ タスク完了 ] ボタン押下
   → status = SUBMITTED（上席確認待ち）
   → label自動解除（履歴は保存）
```

---

### 上席の操作フロー

#### パターン1: 承認
```
1. SUBMITTED の仕訳を確認
2. 問題なし
3. [ 承認 ] ボタン押下
   → status = APPROVED（不可逆）
   → CSV出力対象に追加
```

#### パターン2: 修正
```
1. SUBMITTED の仕訳を確認
2. 軽微な修正が必要
3. 直接修正
4. [ 承認 ] ボタン押下
   → status = APPROVED
```

#### パターン3: ラベル・タスク付与
```
1. SUBMITTED の仕訳を確認
2. 「情報不足で判断できない」と判断
3. [ 情報不足 ] ボタン押下
   ↓
   ┌─────────────────────────────┐
   │ ラベルを選択                │
   │ ☐ 領収書不足                │
   │ ☑ 用途不明                  │
   │                              │
   │ コメント:                   │
   │ ┌─────────────────────────┐ │
   │ │この領収書、何の購入か？ │ │
   │ │顧問先へ確認してください │ │
   │ └─────────────────────────┘ │
   │                              │
   │ [ 確定 ]                    │
   └─────────────────────────────┘
   ↓
   status = NEEDS_INFO
   スタッフのタスクリストに追加
```

---

### コメント機能

#### コメント履歴の表示
```
💬 コメント履歴:
┌─────────────────────────────────┐
│ 2026-02-10 10:30 山田（スタッフ）│
│ 顧問先へ領収書再発行依頼        │
│                                  │
│ 2026-02-11 09:15 佐藤（上席）    │
│ いつまでに届く予定？            │
│                                  │
│ 2026-02-11 14:00 山田（スタッフ）│
│ 顧問先から連絡あり、明日発送予定│
└─────────────────────────────────┘

[ コメント追加 ]
```

---

### CSV出力の仕様

#### 出力対象
```
status = APPROVED のみ
```

#### 出力対象外
```
- READY_FOR_WORK（未処理）
- SUBMITTED（上席確認待ち）
- NEEDS_INFO（情報不足、積み残し）
```

#### CSV出力画面（Screen G）
```
┌─────────────────────────────────────┐
│ CSV出力                             │
├─────────────────────────────────────┤
│ 顧問先: ABC株式会社                 │
│ 対象月: 2026年2月                   │
│                                      │
│ ✅ 承認済み仕訳: 18件               │
│ ⚠️ 積み残しタスク: 2件              │
│    ※CSV出力対象外                  │
│                                      │
│ 会計ソフト: MFクラウド              │
│                                      │
│ [ CSVダウンロード ]                 │
└─────────────────────────────────────┘
```

---

### メリット

1. **積み残しタスクの可視化**
   - 顧問先別進捗管理UIで一目瞭然
   - 期限管理で漏れ防止

2. **スタッフ・上席の協力関係**
   - 「差戻し」ではなく「協力してタスク解決」
   - コメント機能で情報共有

3. **CSV出力の品質保証**
   - APPROVED のみ出力
   - NEEDS_INFO は出力されない（データ品質担保）

4. **顧問先別の進捗管理**
   - 新規分と積み残しを分離表示
   - タスク一覧で未解決事項を把握

---

## 💡 3つの選択肢提示UI（核心機能案）

### 概要
仕訳確定時に3つの候補を提示し、ユーザーが選択するだけで仕訳完了。Phase Aの価値定義「人間が選択するだけで完了」を体現する核心機能。

### 3つの選択肢（優先度順）

#### 選択肢1: 過去作成したルールに基づく仕訳
**データソース**: 顧問先別ルールテーブル（PostgreSQL）

**表示内容**:
```
[ 選択肢1: 過去ルール適用 ]
借方: 消耗品費 10,000円
貸方: 未払金 10,000円
根拠: 「Amazon購入」ルール（適用3回、信頼度95%）
最終適用: 2026-02-05
```

**特徴**:
- 最も確実性が高い（fact基盤）
- ルール名、適用回数、信頼度を表示
- 既にルール登録済みなら「ルール化しない」選択肢も表示

---

#### 選択肢2: 会計ルールに基づく一般的な仕訳
**データソース**: 
- 税理士が事前登録した「テンプレート仕訳」
- 業界標準データベース（要検討）
- 全顧問先の統計データ（プライバシー配慮）

**表示内容**:
```
[ 選択肢2: 会計ルール ]
借方: 通信費 10,000円
貸方: 現金 10,000円
根拠: 「携帯電話料金」の一般的な仕訳
参考: 業界標準テンプレート
```

**特徴**:
- ベストプラクティスに基づく
- ルールがない場合の参考候補
- 税理士の知見を反映

**未解決課題**:
- データソースの確定
- 「会計ルール」と「過去ルール」の境界定義

---

#### 選択肢3: AI推論
**データソース**: Vertex AI（OCR + 類似取引解析）

**表示内容**:
```
[ 選択肢3: AI推論 ]
借方: 備品費 10,000円
貸方: 現金 10,000円
根拠: OCR「オフィス用品」+ 類似取引3件
信頼度: 72%
```

**特徴**:
- イレギュラー取引の対応
- あくまで「参考程度」の位置づけ
- AIは「候補提示」のみ、決定は人間

---

### UI設計案

#### メイン画面
```
┌─────────────────────────────────┐
│ 仕訳候補を選択してください      │
├─────────────────────────────────┤
│ ○ 選択肢1: 過去ルール適用       │
│   借方: 消耗品費 10,000円        │
│   貸方: 未払金 10,000円          │
│   根拠: Amazon購入ルール         │
│                                  │
│ ○ 選択肢2: 会計ルール           │
│   借方: 通信費 10,000円          │
│   貸方: 現金 10,000円            │
│   根拠: 業界標準テンプレート     │
│                                  │
│ ○ 選択肢3: AI推論               │
│   借方: 備品費 10,000円          │
│   貸方: 現金 10,000円            │
│   根拠: OCR解析 (信頼度72%)      │
├─────────────────────────────────┤
│ [ 過去仕訳を検索 ]  [ 確定 ]    │
└─────────────────────────────────┘
```

#### 過去仕訳検索ボタン
クリックすると、過去3-10回の仕訳を列挙:
```
┌─────────────────────────────────┐
│ 過去の同様取引 (10件)            │
├─────────────────────────────────┤
│ 2026-02-05: 消耗品費 / 未払金   │
│ 2026-01-20: 消耗品費 / 未払金   │
│ 2026-01-10: 備品費 / 現金       │
│ ...                              │
├─────────────────────────────────┤
│ [ この仕訳を使う ]  [ 閉じる ]  │
└─────────────────────────────────┘
```

**表示件数の調整**:
- デフォルト: 3件
- 最大: 10件
- ユーザーが設定で変更可能

---

### ルール化フロー

#### 仕訳確定後
```
┌─────────────────────────────────┐
│ 仕訳が確定しました！            │
├─────────────────────────────────┤
│ 次回この条件の取引を：          │
│                                  │
│ [ ルール化する ]                │
│   → 次回自動で候補提示          │
│                                  │
│ [ ルール化しない ]              │
│   → 毎回手動選択                │
├─────────────────────────────────┤
│ ※既にルール登録済みの場合      │
│   「ルール化しない」のみ表示    │
└─────────────────────────────────┘
```

---

### 実装上の検討事項

#### 1. ルール重複防止
- 同一条件のルールが既に存在する場合、「ルール化する」ボタンを非表示
- 「既にルール登録済み」の表示

#### 2. 選択肢の優先順位表示
- 選択肢1（過去ルール）を最上位に配置
- 信頼度スコアで並び替え

#### 3. 「会計ルール」のデータソース確定
- 税理士事前登録？
- 業界標準DB？
- 要決定

#### 4. UI煩雑さの回避
- 3つの選択肢 + 過去仕訳検索で複雑にならないか
- モーダル vs サイドパネル

---

### メリット

1. **Phase Aの価値定義に完全合致**
   - 「選択するだけで仕訳完了」を実現
   - AIは「候補提示」のみ、決定は人間

2. **段階的な学習**
   - ルールなし → 会計ルール/AI推論
   - ルール蓄積 → 過去ルール優先

3. **透明性の確保**
   - 各選択肢に「根拠」を表示
   - ユーザーが理解した上で選択可能

4. **柔軟性**
   - 過去仕訳検索で「あの時どうしたっけ？」を確認
   - ルール化の可否を毎回選択

---

## 🔍 OCR最適化（精度向上施策）

### 概要
画像前処理とテキスト正規化により、OCR一致率を85%→92%まで向上させる。月2万枚規模での実装を想定した現実的な最適化施策。

---

### 画像前処理（5つの施策）

#### 1. 傾き補正（必須）
**課題**: レシートはほぼ必ず斜め

**実装方法**:
- Hough変換
- minAreaRect
- OCR内蔵の角度補正

**効果**: 一致率 **+2〜4%**

---

#### 2. グレースケール化
**理由**: 色情報は不要、ノイズになるだけ

**実装**:
```
RGB → Grayscale
```

**効果**: ノイズ削減

---

#### 3. コントラスト強調（CLAHE推奨）
**目的**: 薄い印字対策

**実装**:
- CLAHE（適応ヒストグラム平坦化）

**効果**: 手書き以外は安定

---

#### 4. ノイズ除去
**実装**:
- Gaussian blur（弱め）
- Bilateral filter（やりすぎ注意）

**効果**: テキスト認識の安定化

---

#### 5. 解像度統一
**基準**: 300dpi相当目安

**処理**: 小さすぎる画像は拡大

---

### テキスト正規化（超重要）

OCRの揺れを吸収する層。

#### 1. 全角半角統一
**実装**:
```python
unicodedata.normalize("NFKC", text)
```

**変換例**:
```
Ａ → A
１ → 1
￥ → ¥
```

**効果**: 一致率 **+3〜6%**

---

#### 2. 空白・改行圧縮
**処理**:
- 連続空白 → 1個
- 改行 → 統一

---

#### 3. 数値補正
**よくある誤認識**:

| 誤 | 正 |
|---|---|
| O | 0 |
| l | 1 |
| I | 1 |
| S | 5 |

**実装**: 金額行だけ限定補正が安全

---

#### 4. 日付正規化
**統一形式**: `YYYY-MM-DD`

**変換例**:
```
2025/2/1      → 2025-02-01
25-02-01      → 2025-02-01
2025年2月1日  → 2025-02-01
```

---

#### 5. 金額抽出の決定論化
**重要**: **LLM禁止**（コスト・精度の理由）

**ルール**:
1. 「合計」「TOTAL」「税込」優先
2. 最大値ロジック
3. 税率と整合性チェック

**効果**: 金額一致率 **98%**、一致率 **+2〜3%**

---

#### 6. ベンダー名正規化辞書
**実装**:
- 辞書 + fuzzy matching（Levenshtein距離）

**変換例**:
```
AMAZON.CO.JP      → Amazon
アマゾンジャパン  → Amazon
```

**効果**: 店名一致率が跳ね上がる、一致率 **+3〜5%**

---

### 一致率への影響（体感値）

| 改善施策 | 上昇幅 |
|---|---|
| 傾き補正 | +2〜4% |
| 正規化 | +3〜6% |
| 金額ルール化 | +2〜3% |
| ベンダー辞書 | +3〜5% |
| **合計** | **+10%近く** |

**実績**: 85% → 92%は射程

---

### 月2万枚規模での現実設計

#### 必須施策（5つ）
1. ✅ 傾き補正
2. ✅ NFKC正規化
3. ✅ 日付統一
4. ✅ 金額ルール抽出
5. ✅ ベンダー辞書

**期待効果**: 85% → 92%

---

### 実装優先度

| 施策 | 優先度 | 理由 |
|---|---|---|
| 傾き補正 | 最高 | 必須、効果大 |
| NFKC正規化 | 最高 | 必須、効果大 |
| 金額ルール化 | 最高 | LLM禁止、コスト削減 |
| ベンダー辞書 | 高 | 店名一致率向上 |
| 日付正規化 | 高 | データ品質向上 |
| CLAHE | 中 | 薄い印字対策 |
| ノイズ除去 | 中 | やりすぎ注意 |

---

## 🔗 外部API連携・アプリ拡張

### マネーフォワードAPI連携

#### 概要
マネーフォワードクラウドとのAPI連携により、仕訳データの自動同期を実現。

#### 機能
- 仕訳データの自動送信（APPROVED のみ）
- 勘定科目マッピング
- エラーハンドリング

#### 優先度
**低**（現行はCSV出力で対応可能）

---

### 顧問先用資料共有アプリ

#### 概要
顧問先が領収書・請求書を簡単にアップロードできる専用アプリ。

#### 機能
- スマホカメラで撮影 → 自動アップロード
- Google Drive連携
- アップロード履歴確認
- プッシュ通知（「資料を送ってください」等）

#### メリット
- 顧問先の利便性向上
- Google Driveの使い方が分からない顧問先対応
- アップロード漏れ防止

#### 優先度
**低**（現行はGoogle Drive共有で対応可能）

---


**最終更新**: 2026-02-12

---

## 📊 Streamed互換：仕訳一覧UI深掘り（Phase 5以降）

### 概要
Streamedの仕訳一覧画面は「事故監視」が核心。ユーザーは一覧で**事故フラグだけを見て、事故がなければ適当にOK出せる**設計。一覧性を徹底的に追求し、詳細画面に入る前に仕訳完了できる要素を配置。

### Streamedの実装（実際の使用経験に基づく）

#### ① 出力管理が強い
**特徴**：
- **出力済みはグレー表示**（視覚的に区別）
- **出力対象外の制御**（出力しない仕訳を明示的にマーク）
- **出力単位の管理**（バッチ単位で出力履歴）
- **会計ソフト連携前提の設計**（MF/freee等）

**現在の設計**：
- `status === 'exported'` で出力済み判定
- `export_batches` テーブルでバッチ管理
- ✅ **基本構造は既に実装済み**

**追加が必要な要素**：
```typescript
// journals テーブル追加カラム
export_exclude BOOLEAN DEFAULT false  // 出力対象外フラグ
export_batch_id UUID REFERENCES export_batches(id)  // 出力バッチID
```

**UI表示**：
```
┌─────────────────────────────────────────────────┐
│ 仕訳一覧 (20件)                                 │
├─────────────────────────────────────────────────┤
│ [出力済] #001 Amazon消耗品 ¥10,000 (グレー)    │ ← exported
│ [ 確認待 ] #002 ENEOS給油 ¥5,000               │ ← approved
│ [対象外] #003 私的利用 ¥3,000 (薄字)           │ ← export_exclude = true
└─────────────────────────────────────────────────┘
```

---

#### ② 制度系フラグが明示的
**特徴**：
- **適格請求書判定**（インボイス制度対応）
- **インボイス登録番号状況**（T+13桁）
- **税区分**（10%、8%軽減、非課税、不課税）
- **税務事故防止UI**（税区分×科目の矛盾検知）

**現在の設計**：
- `labels` TEXT[] で一部対応（`MULTI_TAX`等）
- ✅ **基礎は実装済みだが、制度系フラグが不足**

**追加が必要な要素**：
```typescript
// journals テーブル追加カラム
invoice_number VARCHAR(14) NULL  // 適格請求書番号（T+13桁）
invoice_status ENUM('qualified', 'not_qualified', 'exempt', 'unknown')  // 適格判定
tax_category ENUM('standard_10', 'reduced_8', 'non_taxable', 'tax_exempt', 'unknown')  // 税区分

// receipts テーブル（OCR結果）
ocr_invoice_number VARCHAR(14) NULL  // OCR読み取りインボイス番号
ocr_confidence_invoice NUMERIC(3, 2)  // インボイス番号の信頼度
```

**UI表示**：
```
┌─────────────────────────────────────────────────┐
│ [✓適格] #002 ENEOS給油 ¥5,000 [10%]            │ ← invoice_status='qualified'
│ [❌未登録] #003 個人商店 ¥3,000 [8%軽減]        │ ← invoice_status='not_qualified'
│ [⚠️矛盾] #004 交際費 ¥10,000 [非課税]           │ ← 科目×税区分矛盾
└─────────────────────────────────────────────────┘
```

---

#### ③ 学習・補助機能表示
**特徴**：
- **AI学習アイコン**（このルールで自動化されている）
- **重複チェック**（同一ハッシュ検知）
- **入力補助**（過去仕訳からの提案表示）
- **ルールの見える化**（半透明で、ルール適用結果を表示）

**現在の設計**：
- ルール学習機能はアイデアレベル（未実装）
- ❌ **ルールの見える化が不足**

**追加が必要な要素**：
```typescript
// journals テーブル追加カラム
rule_id UUID REFERENCES journal_rules(id) NULL  // 適用されたルールのID
rule_applied_at TIMESTAMP NULL  // ルール適用日時
rule_confidence NUMERIC(3, 2) NULL  // ルール適用の信頼度
is_auto_suggested BOOLEAN DEFAULT false  // AI/ルールで自動提案されたか
duplicate_hash VARCHAR(64) NULL  // 重複検知用ハッシュ（取引日+金額+取引先）

// journal_rules テーブル（新規）
CREATE TABLE journal_rules (
  id UUID PRIMARY KEY,
  client_id UUID NOT NULL,
  rule_name VARCHAR(100) NOT NULL,  -- 「Amazon購入ルール」等
  vendor_pattern VARCHAR(100),
  amount_min NUMERIC NULL,
  amount_max NUMERIC NULL,
  debit_account VARCHAR(50),
  credit_account VARCHAR(50),
  confidence NUMERIC(3, 2) DEFAULT 0.5,
  apply_count INTEGER DEFAULT 0,  -- 適用回数
  success_count INTEGER DEFAULT 0,  -- 成功回数（人間がOKした回数）
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  status ENUM('active', 'suggest_only', 'disabled') DEFAULT 'active'
);
```

**UI表示（半透明＋ルール表示）**：
```
┌─────────────────────────────────────────────────┐
│ [🤖ルール] #002 ENEOS給油 ¥5,000                │
│   └ 「ENEOS給油ルール」適用 (信頼度95%, 適用3回)│ ← 半透明グレー表示
│                                                  │
│ [👤手動] #003 個人商店 ¥3,000                   │
│   └ ルールなし                                  │
└─────────────────────────────────────────────────┘
```

---

#### ④ 事故フラグ（最重要：一覧で仕訳完了できる核心）
**特徴**：
- **事故監視が核心**（事故ってなければ適当にOK出せる）
- **事故フラグだけを見る**（詳細に入らずに判断）
- **4大事故フラグ**：
  1. **貸借不一致**（借方合計 ≠ 貸方合計）
  2. **金額不自然**（小数点ミス、桁違い、負数）
  3. **同一ハッシュ重複**（取引日+金額+取引先が完全一致）
  4. **科目×税区分矛盾**（交際費で非課税等のあり得ない組み合わせ）

**現在の設計**：
- `labels` TEXT[] で一部対応可能
- ❌ **事故検知ロジックが不足**

**追加が必要な要素**：
```typescript
// journals テーブル追加カラム
anomaly_flags TEXT[] DEFAULT '{}'  // 事故フラグ配列

// 事故フラグENUM
type AnomalyFlag = 
  | 'DEBIT_CREDIT_MISMATCH'      // 貸借不一致
  | 'AMOUNT_UNNATURAL'            // 金額不自然
  | 'DUPLICATE_HASH'              // 重複疑い
  | 'ACCOUNT_TAX_CONFLICT'        // 科目×税区分矛盾
  | 'OCR_LOW_CONFIDENCE'          // OCR信頼度低（既存のLOW_OCR_CONFと統合）
  | 'AMOUNT_MISSING'              // 金額読み取り失敗
  | 'VENDOR_UNKNOWN'              // 取引先不明
  | 'DATE_OUT_OF_PERIOD';         // 期間外

// 事故検知関数（API層）
function detectAnomalies(journal: Journal): AnomalyFlag[] {
  const flags: AnomalyFlag[] = [];
  
  // 1. 貸借不一致
  if (journal.debit_total !== journal.credit_total) {
    flags.push('DEBIT_CREDIT_MISMATCH');
  }
  
  // 2. 金額不自然
  if (journal.amount < 0 || journal.amount > 10000000 || !Number.isInteger(journal.amount)) {
    flags.push('AMOUNT_UNNATURAL');
  }
  
  // 3. 重複疑い
  const hash = generateDuplicateHash(journal);
  if (await checkDuplicateExists(hash)) {
    flags.push('DUPLICATE_HASH');
  }
  
  // 4. 科目×税区分矛盾
  if (isAccountTaxConflict(journal.debit_account, journal.tax_category)) {
    flags.push('ACCOUNT_TAX_CONFLICT');
  }
  
  return flags;
}
```

**UI表示（事故フラグ強調）**：
```
┌─────────────────────────────────────────────────┐
│ 仕訳一覧 (事故フラグ優先表示)                   │
├─────────────────────────────────────────────────┤
│ [🚨貸借不一致] #005 Amazon ¥10,000              │ ← 赤背景
│ [⚠️金額疑義] #006 コンビニ ¥12345.67           │ ← 黄背景
│ [⚠️重複?] #007 ENEOS ¥5,000 (2026-02-10)       │ ← 黄背景
│ [⚠️税矛盾] #008 交際費¥10,000 [非課税]         │ ← 黄背景
│                                                  │
│ [✅正常] #001 Amazon ¥10,000                    │ ← 通常表示
│ [✅正常] #002 ENEOS ¥5,000                      │
│ [✅正常] #003 コンビニ ¥1,500                   │
└─────────────────────────────────────────────────┘
```

**ソート順**：
```
1. 事故フラグあり（赤・黄）を最上位
2. ルール適用済み（緑）
3. 手動入力（通常）
4. 出力済み（グレー）を最下位
```

---

#### ⑤ OCR事故の表示
**Streamedの実装**：
- **OCR信頼度を明示表示**（例: 金額85%、取引先92%）
- **読み取り失敗箇所を赤枠表示**（証票画像上に重畳）
- **「想像しない」原則の徹底**
  - 金額が読めない → `amount = NULL` + フラグ `AMOUNT_MISSING`
  - 取引先が読めない → `vendor = NULL` + フラグ `VENDOR_UNKNOWN`
  - **絶対に推測値を入れない**

**追加が必要な要素**：
```typescript
// receipts テーブル追加カラム
ocr_confidence_amount NUMERIC(3, 2) NULL  // 金額の信頼度
ocr_confidence_vendor NUMERIC(3, 2) NULL  // 取引先の信頼度
ocr_confidence_date NUMERIC(3, 2) NULL    // 日付の信頼度
ocr_failed_fields TEXT[] DEFAULT '{}'     // 読み取り失敗フィールド

// journals テーブル（NULL許容）
amount NUMERIC NULL  // 金額読み取り失敗時はNULL
vendor_name VARCHAR(100) NULL  // 取引先読み取り失敗時はNULL
transaction_date DATE NULL  // 日付読み取り失敗時はNULL
```

**UI表示（OCR信頼度表示）**：
```
┌─────────────────────────────────────────────────┐
│ [⚠️OCR低] #009 ???商店 ¥??,??? [取引先45%]     │
│   └ 金額: 読み取り失敗、取引先: 信頼度45%       │
│                                                  │
│ [✅OCR高] #010 ENEOS ¥5,000 [金額98%]           │
│   └ すべて高信頼度                              │
└─────────────────────────────────────────────────┘
```

---

#### ⑥ ルール学習の見える化
**Streamedの実装（実際の使用経験）**：
- **1回でルール確定**（初めての取引でも仕訳処理したらルール化）
- **ルール自体が見える**（ルール名、適用条件、信頼度）
- **ルール適用結果も見える**（半透明で「このルールで自動化」）
- **会社単位がベスト**（顧問先別ルール）

**なぜ1回確定が危険ではないか？**：
- Streamedは**人間が見る以外に選択肢はない**前提
- 1回確定 = 「次回自動提案」であり「次回自動確定」ではない
- **人間が最終判断**するから安全
- **ルールが見える化**しているから人間が安心
- **ルール適用結果も見える化**しているから人間が制御を感じる

**現在の設計との統合**：
- Phase A「1回案（明示的制御）」と**完全に一致**
- ユーザーが「ルール化する」を明示的に選択
- **ルールの見える化が不足**している（追加実装必要）

**追加UI要素**：
```
┌─────────────────────────────────────────────────┐
│ 仕訳完了！次回この条件の取引を：                │
├─────────────────────────────────────────────────┤
│ ルール名: _______________________               │ ← 編集可能
│          （例: Amazon購入ルール）               │
│                                                  │
│ 適用条件:                                       │
│   - 取引先: Amazon を含む                       │
│   - 金額: ¥3,000 〜 ¥50,000                     │
│   - 勘定科目: 消耗品費                          │
│                                                  │
│ [ ルール化する（次回自動提案）]                 │
│ [ ルール化しない（毎回手動）]                   │
└─────────────────────────────────────────────────┘
```

**ルール一覧画面（見える化）**：
```
┌─────────────────────────────────────────────────┐
│ ルール一覧 (ABC株式会社)    [ + 新規ルール ]   │
├─────────────────────────────────────────────────┤
│ [有効] Amazon購入ルール                         │
│   適用: 3回 / 成功: 3回 / 信頼度: 100%          │
│   条件: Amazon, ¥3,000-50,000 → 消耗品費        │
│   [ 編集 ] [ 無効化 ] [ 削除 ]                 │
│                                                  │
│ [有効] ENEOS給油ルール                          │
│   適用: 10回 / 成功: 10回 / 信頼度: 100%        │
│   条件: ENEOS → 旅費交通費/ガソリン代           │
│   [ 編集 ] [ 無効化 ] [ 削除 ]                 │
│                                                  │
│ [無効] 古いルール                               │
│   適用: 5回 / 成功: 2回 / 信頼度: 40%           │
│   ※信頼度低下のため無効化済み                  │
│   [ 有効化 ] [ 削除 ]                          │
└─────────────────────────────────────────────────┘
```

---

### 現在の設計との相違点まとめ

| 要素 | Streamed | 現在の設計 | 追加実装必要度 |
|------|----------|------------|---------------|
| **出力管理** | 出力済みグレー、出力対象外制御 | `exported` status実装済み | 中（`export_exclude`フラグ追加） |
| **制度系フラグ** | 適格判定、インボイス番号、税区分 | `labels`で一部対応 | 高（専用カラム追加） |
| **学習表示** | AI学習アイコン、ルール見える化 | 未実装 | 最高（Phase 5の核心機能） |
| **事故フラグ** | 貸借不一致、金額疑義、重複、税矛盾 | `labels`で一部対応 | 最高（一覧性の核心） |
| **OCR事故** | 信頼度表示、読み取り失敗明示 | 未実装 | 高（OCR精度可視化） |
| **ルール学習** | 1回確定、ルール一覧、見える化 | アイデアレベル | 最高（Phase 5の核心機能） |

---

### 実装優先度（Phase 5以降）

#### Tier 1（最高優先度：一覧性の核心）
1. **事故フラグシステム**
   - `anomaly_flags` TEXT[] カラム追加
   - 事故検知関数実装（4大事故フラグ）
   - UI: 事故フラグ優先表示、ソート順変更
   - 実装目的: **「事故ってなければ適当にOK」を実現**

2. **ルール学習・見える化**
   - `journal_rules` テーブル作成
   - `rule_id`, `rule_applied_at` カラム追加
   - UI: ルール一覧画面、ルール適用結果の半透明表示
   - 実装目的: **「人間が安心、人間が制御を感じる」を実現**

#### Tier 2（高優先度：制度対応）
3. **制度系フラグ**
   - `invoice_number`, `invoice_status`, `tax_category` カラム追加
   - UI: 適格判定アイコン、税区分表示
   - 実装目的: **税務事故防止**

4. **OCR信頼度表示**
   - `ocr_confidence_*` カラム追加（receiptsテーブル）
   - UI: 信頼度パーセント表示、失敗フィールド明示
   - 実装目的: **OCR事故の可視化**

#### Tier 3（中優先度：利便性向上）
5. **出力管理強化**
   - `export_exclude` フラグ追加
   - UI: 出力対象外マーク、出力済みグレー表示
   - 実装目的: **CSV出力の柔軟性**

---

### 仕訳スキーマ再設計の必要性

#### 現在の `journal_v1_20260211.md` の問題点
- Phase 4でとりあえず22カラム定義したが、**一覧性を考慮していない**
- MF連携カラムは定義したが、**事故フラグ・ルール管理カラムが不足**
- Streamedの「事故監視」「ルール見える化」の核心要素が欠落

#### 再設計の方針
**Phase 4（現在）**: 基本構造のみ実装
- status 5つ、label 9つ、export管理
- ✅ **これは継続（破壊的変更なし）**

**Phase 5（再設計）**: Streamed互換の核心要素を追加
- 事故フラグシステム（`anomaly_flags`）
- ルール学習・見える化（`journal_rules`テーブル、`rule_id`）
- 制度系フラグ（`invoice_*`, `tax_category`）
- OCR信頼度（`ocr_confidence_*`）

**Phase 6以降（将来）**: API連携・高度な学習

---

### 次のアクション提案

1. **アイデア.mdに追記完了** ← 今
2. **Phase 5計画書作成**
   - `plan_phase5_streamed_list_ui_260212.md`
   - スキーマ拡張DDL定義
   - UI設計詳細
3. **統合ロードマップ更新**
   - Phase 4 → Phase 5へのマイルストーン明確化
