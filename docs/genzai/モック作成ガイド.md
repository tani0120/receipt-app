# モック作成・実装移行ガイド

作成日: 2026-02-16（v2）
更新日: 2026-02-19（矛盾修正: Phase体系統一、unsafe/使い分け追加）
対象プロジェクト: 仕訳作成システム（Vue3 + Hono + Supabase）
目的: Antigravityへの指示テンプレート／型安全ルール／実装移行手順の一元管理

> **上位規範**: `docs/genzai/00_モック実装時のルール.md` がPhase体系・暴走防止の正式定義。
> 本ガイドはその手順書・テンプレート集であり、矛盾がある場合はルール文書が優先される。

---

## 現状の防御壁（設定済み）

| 層 | anyルール | 意味 |
|---|---|---|
| database/ shared/ stores/ | **error** | 物理的に侵入不可 |
| api/ components/ composables/ | warn | 警告のみ・作業継続可 |
| mocks/ | warn | モック作成中のため緩和 |

> **重要**: Domain層（database/shared/stores）へのany追加はESLintエラーで即座にブロックされる。

---

## Yen型（金額型）

金額フィールドは必ず Yen 型を使用する。

```typescript
import type { Yen } from '@/shared/types/yen'
// type Yen = number（Phase BでBranded Type化予定）
```

- amount: number → amount: Yen に変更済み（2026-02-16）
- src/scripts/compare_models.ts は対象外（Vertex AI関連・Phase B以降）
- ドキュメント内のコード例は変更不要（説明用のため）

---

## ファイル配置ルール

### 拡張型の配置場所

```
src/mocks/types/journal_extensions.ts  ← 拡張型はここに集約（新規作成）
src/mocks/types/journal_phase5_mock.type.ts  ← 既存（触らない）
src/mocks/types/receipt_mock.type.ts  ← 既存（触らない）
src/mocks/unsafe/  ← any許可の実験場（Phase A-0で作成。ルール文書§1参照）
```

理由: Phase A完了後の統合時に `journal_extensions.ts` を削除するだけで済む。

### unsafe/ と extensions.ts の使い分け

| 状況 | 使うもの | 例 |
|---|---|---|
| 型設計が未定のプロトタイプ | `unsafe/` | 新しい列の実験的実装 |
| 既存型にプロパティが足りない | `extensions.ts` | JournalEntryにmetadata追加 |
| as any が必要 | `unsafe/`内のみ許可 | 型が未確定のAPI応答 |

**禁止**: unsafe/以外でのas any使用。extensions.tsで拡張型を定義すること。

### モック生成関数の配置場所

```
src/mocks/factories/journalFactory.ts  ← 生成ロジックはここ（新規作成）
src/mocks/data/  ← テストデータはここ（既存）
```

理由: テストデータ（data/）と生成ロジック（factories/）を分離することで、
Phase C（Backend接続）時にfactories/だけを差し替えればよくなる。

---

## モック作成時の型安全ルール

### ルール1: as anyは使わない。拡張型を使う。

NG
```typescript
} as any,
```

OK
```typescript
// src/mocks/types/journal_extensions.ts に拡張型を定義する
export type JournalEntryWithMetadata = JournalEntry & {
  metadata?: {
    hasTNumber: boolean
  }
}

// 使用側
} as JournalEntryWithMetadata,
```

### ルール2: 型定義外のプロパティが必要になったら拡張型に追加する

```typescript
// src/mocks/types/journal_extensions.ts
// Phase A完了後にJournalEntryへ統合予定・このファイルごと削除する

export type JournalEntryWithMetadata = JournalEntry & {
  metadata?: {
    hasTNumber: boolean
    // 必要なプロパティをここに追加していく
  }
}
```

### ルール3: モックは必ずDomain型を通す

NG
```typescript
const mock = {
  amount: 1000
}
```

OK
```typescript
const mock: JournalEntry = createMockJournal()
```

### ルール4: モックは生成関数化する

```typescript
// src/mocks/factories/journalFactory.ts
export function createMockJournal(): JournalEntry {
  return {
    id: crypto.randomUUID(),
    lines: [
      {
        account: '旅費交通費',
        amount: 1000,
        tax_category: null,
      }
    ]
  }
}
```

### ルール5: Domain層は絶対に触らない

以下のフォルダはいかなる理由があっても修正しない。

```
src/database/types/   ← DB型定義
src/shared/           ← 共有型定義
src/stores/           ← Pinia Store
```

理由: 型安全性の基礎。汚染されると全体が連鎖的に崩壊する。

---

## Antigravityへの指示テンプレート

### 【基本テンプレート】モック修正時

```
【作業前に必ず実行】
git add . && git commit -m "作業前スナップショット" && git push

【修正対象】
[対象ファイルを1つだけ明記する]

【作業内容】
[やることを1つだけ明記する]

【制約】
- 指定ファイル以外は一切触らないこと
- as any は使わない
  型定義外のプロパティが必要な場合は
  src/mocks/types/journal_extensions.ts の拡張型に追加すること
- Domain層（src/database/ src/shared/ src/stores/）は絶対に触らないこと
- 型エラーが出た場合はas anyで解決せず、そのまま報告すること

【完了後に必ず実行】
npm run lint 2>&1 | findstr "mocks"

【コミット前セキュリティチェック】
git add [修正したファイル]
git diff --cached | findstr /i "key\|secret\|token\|password\|apikey\|api_key\|supabase_key\|service_role\|anon_key\|project_id\|VITE_"
→ 何も出力されなければコミットしてよい
→ 何か出力された場合は即座に停止して報告する

git commit -m "[内容]" && git push

【報告内容】
- 修正内容の説明
- lintの結果
- セキュリティチェック結果
- commitハッシュ
```

### 【拡張型追加】型定義外プロパティが必要な場合

```
【作業前に必ず実行】
git add . && git commit -m "作業前スナップショット" && git push

【修正対象】
src/mocks/types/journal_extensions.ts のみ
（存在しない場合は新規作成）

【作業内容】
以下のプロパティを JournalEntryWithMetadata 型に追加してください：
[追加するプロパティを明記する]

// Phase A完了後にJournalEntryへ統合予定・このファイルごと削除する
export type JournalEntryWithMetadata = JournalEntry & {
  metadata?: {
    hasTNumber: boolean
    // ここに追加
  }
}

【制約】
- このファイル以外は一切触らないこと
- as any は使わない

【完了後に必ず実行】
npm run lint 2>&1 | findstr "error"

【コミット前セキュリティチェック】
git add src/mocks/types/journal_extensions.ts
git diff --cached | findstr /i "key\|secret\|token\|password\|apikey\|api_key\|supabase_key\|service_role\|anon_key\|project_id\|VITE_"
→ 何も出力されなければコミットしてよい
→ 何か出力された場合は即座に停止して報告する

git commit -m "fix: 拡張型に[プロパティ名]追加" && git push
```

### 【ステータス・ラベル修正】Phase A作業中

```
【作業前に必ず実行】
git add . && git commit -m "作業前スナップショット" && git push

【修正対象】
src/mocks/types/journal_phase5_mock.type.ts のみ

【作業内容】
[ステータス/ラベルの変更内容を明記する]

【制約】
- このファイル以外は一切触らないこと
- Domain層（src/database/ src/shared/ src/stores/）は絶対に触らないこと
- 型エラーが出た場合はas anyで解決せず、そのまま報告すること

【完了後に必ず実行】
npm run type-check

【コミット前セキュリティチェック】
git add src/mocks/types/journal_phase5_mock.type.ts
git diff --cached | findstr /i "key\|secret\|token\|password\|apikey\|api_key\|supabase_key\|service_role\|anon_key\|project_id\|VITE_"
→ 何も出力されなければコミットしてよい
→ 何か出力された場合は即座に停止して報告する

git commit -m "fix: [変更内容]" && git push
```

### 【生成関数追加】モックファクトリー作成時

```
【作業前に必ず実行】
git add . && git commit -m "作業前スナップショット" && git push

【修正対象】
src/mocks/factories/journalFactory.ts
（存在しない場合は新規作成）

【作業内容】
[追加する生成関数の仕様を明記する]

【制約】
- このファイル以外は一切触らないこと
- 戻り値の型は必ずDomain型（JournalEntry等）を明示すること
- as any は使わない

【完了後に必ず実行】
npm run type-check

【コミット前セキュリティチェック】
git add src/mocks/factories/journalFactory.ts
git diff --cached | findstr /i "key\|secret\|token\|password\|apikey\|api_key\|supabase_key\|service_role\|anon_key\|project_id\|VITE_"
→ 何も出力されなければコミットしてよい
→ 何か出力された場合は即座に停止して報告する

git commit -m "feat: [関数名]追加" && git push
```

---

## 緊急ロールバック手順

> [!CAUTION]
> ロールバック前に必ずセキュリティチェックを実行してください。
> 機密情報（API key等）が含まれるコミットがある場合、ロールバックではなくGit履歴の書き換えが必要です。

Antigravityが意図しないファイルを削除・破壊した場合：

```bash
# Step1: 直前のコミット履歴を確認
git log --oneline -10

# Step2: 安全な状態のコミットハッシュを特定する

# Step3: ロールバック実行
git reset --hard [コミットハッシュ]

# Step4: リモートに強制プッシュ
git push --force origin main

# Step5: 状況をClaude等のLLMに報告して次の指示を待つ
```

注意: `git push --force` は取り消せない。Step2で正しいハッシュを確認してから実行すること。

---

## Phase A完了後の統合手順

Phase Aでステータス・ラベルが確定した後に実施する。

### Step 1: 拡張型をDomain型に統合

```typescript
// Before: src/mocks/types/journal_extensions.ts
export type JournalEntryWithMetadata = JournalEntry & {
  metadata?: { hasTNumber: boolean }
}

// After: src/shared/ または src/database/types/ のJournalEntry型に統合
export type JournalEntry = {
  // 既存フィールド...
  metadata?: { hasTNumber: boolean }  // ← 統合
}
```

### Step 2: 拡張型の参照を削除

```bash
# 拡張型の使用箇所を確認
grep -R "JournalEntryWithMetadata" src

# 全て JournalEntry に置き換えてから journal_extensions.ts を削除する
```

### Step 3: lint・型チェック確認

```bash
npm run lint 2>&1 | findstr "error"
npm run type-check
```

### Step 4: tsconfigの厳格化（Phase A完了後に追加）

```json
{
  "compilerOptions": {
    "noUncheckedIndexedAccess": true,
    "exactOptionalPropertyTypes": true,
    "noPropertyAccessFromIndexSignature": true
  }
}
```

注意: 既存コードへの後付けは連鎖エラーのリスクあり。新規コードが安定してから追加する。

---

## モック完了後の実装移行手順

### モック完了の定義

以下がすべて満たされたらPhase A完了（`00_モック実装時のルール.md` §1 Phase B移行条件も参照）：

```
□ ステータス定義が確定
□ ラベル定義が確定
□ any増加ゼロ（新規anyの追加がない）
□ 全22列がブラウザで正しく表示
□ ソート・モーダル・トグル全動作確認
□ npm run type-check / npm run lint 通過
□ ユーザーが「UX固定」と宣言
□ ドキュメント（journal_v2_20260214.md等）が最終版
```

### Phase C-1: Supabase型の生成（※旧Phase B。ルール文書のPhase C = Backend接続に対応）

```bash
# project-idは.env.localを直接確認してから手動で指定する
supabase gen types typescript --project-id [project-id] \
  > src/database/types/generated/supabase.ts
```

生成した型は `src/database/types/generated/supabase.ts` に配置。
この型を直接UIに流さない。必ずマッピング層を通す。

### Phase C-2: マッピング層の作成

```typescript
// src/database/repositories/ にマッピング関数を作成
function mapRowToDomain(
  row: Database['public']['Tables']['journals']['Row']
): JournalEntry {
  // DB型 → Domain型の変換をここで吸収する
  // UIはこの関数の戻り値（JournalEntry）だけを見る
  return {
    id: row.id,
    // ...
  }
}
```

### Phase C-3: モックとの差し替え

```typescript
// Before: モックを直接使用
import { createMockJournal } from '@/mocks/factories/journalFactory'

// After: リポジトリ経由
import { journalRepository } from '@/database/repositories/journalRepository'
```

### Phase C-4: mocksフォルダの整理

```bash
# mocksフォルダの参照がテストファイルのみであることを確認
grep -R "from.*mocks" src --include="*.ts" --include="*.vue"

# 確認後に削除
```

---

## 作業ログ（随時更新）

| 日付 | 作業内容 | 状態 |
|---|---|---|
| 2026-02-16 | Domain層ESLint保護追加（database/shared/stores） | ✅ 完了 |
| 2026-02-16 | git push 20コミット分 | ✅ 完了 |
| 2026-02-16 | エラー内訳把握（279件: any160件、unused69件、他） | ✅ 完了 |
| 2026-02-16 | mocks/as any確認（1件・test_scenarios.ts:128行目） | ✅ 確認済 |
| - | journal_extensions.ts作成・as any置き換え | ⬜ 未着手 |
| Phase A完了後 | 拡張型のDomain型統合・journal_extensions.ts削除 | ⬜ 未着手 |
| Phase A完了後 | unused-vars 69件の修正（削除。@ts-expect-errorは使わない） | ⬜ 未着手 |
| Phase A完了後 | tsconfigの厳格化オプション追加 | ⬜ 未着手 |
| Phase C | Supabase型生成・マッピング層作成 | ⬜ 未着手 |

---

## 重要な判断ログ

2026-02-16時点の判断：

- `noUncheckedIndexedAccess` / `exactOptionalPropertyTypes` はPhase A完了後に追加
- api/components/composablesの160件anyはPhase A完了後に段階的修正
- unused-vars 69件はPhase A完了後に削除（@ts-expect-errorでの隠蔽はしない）
- flat config（eslint.config.js）への移行はPhase B以降
- Supabaseのproject-idはコマンドで自動取得しない（セキュリティリスク）
