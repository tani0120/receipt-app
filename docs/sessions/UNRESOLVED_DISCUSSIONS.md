# 未解決議論・中断した議論（2026-01-21）

**作成日**: 2026-01-21  
**最終更新**: 2026-01-21  
**ステータス**: Active  
**目的**: セッション中に中断・保留した議論を明示的に記録し、次回セッションで再開可能にする

---

## 📋 中断した議論

### 1. 開発用Firebaseプロジェクト作成

**議論の経緯**:
- 本番データ保護のため、開発用Firebaseプロジェクト（`sugu-suru-dev`）作成を提案
- `implementation_plan.md`に詳細な手順を作成
- ユーザーから「本番データがまだないので不要」との判断
- → **中断**

**理由**:
本番データがまだ存在しないため、環境分離の必要性がない

**再開条件**:
- 本番環境に顧問先の実際のデータが追加されたとき
- 機密情報（領収書等）を扱い始めたとき

**記録先**:
- `brain/implementation_plan.md`（セッション固有）
- → 削除または「不要と判断」を明記して保持

**次のアクション**:
- 本番データ追加時に再検討
- 必要になったら、`implementation_plan.md`を参照して実施

---

### 2. バックエンドアーキテクチャ実装計画

**議論の経緯**:
- 当初「Firestore直接アクセスで問題ない」と判断
- ユーザーから以下の指摘：
  - AI処理が必要（Gemini API呼び出し）
  - 複雑な集計処理が必要
  - バッチ処理が必要
  - 機密情報を扱う（顧問先の領収書等）
- SYSTEM_PHILOSOPHY.mdを確認：
  - **GAS (Google Apps Script)**: Google Driveファイル操作 + AI解析バッチ + ファイル移動
  - **現状**: VueアプリのMock/Service層でシミュレーション中
- → **結論**: GASが必要だが、実装計画は未定

**問題点**:
- GASをいつ、どのように実装するか未定義
- `src/server.ts`、`src/api/`の扱いが曖昧（Mockなのか、本番用なのか）

**再開条件**:
- AI解析バッチ実装が必要になったとき
- Google Driveのファイル操作が必要になったとき

**記録先**:
- SYSTEM_PHILOSOPHY.md（GASの役割は既に明記済み）
- 実装計画: 将来作成すべき

**次のアクション**:
- ADR-008: バックエンドアーキテクチャ戦略（GAS vs Node.js）を作成すべきか検討
- または、TASK_MASTER.mdに「GAS実装」タスクを追加

---

### 3. 本番環境の認証・API問題（2026-01-23追加）

**議論の経緯**:
- 本番環境でログインできない問題を調査
- `.env.local`のパスワード（`0120tani`）が本番環境と異なることを発見
- JavaScriptバンドル解析により正しいパスワード（`pass1234`）を特定
- Firestoreセキュリティルールを再デプロイ
- **新たな問題発見**: バックエンドAPI（Cloud Run）が404エラー
  - `/api/clients` → 404 Not Found
  - `/api/journal-status` → 404 Not Found
  - データが一切読み込めない状態

**中断理由**:
- 本番環境のバックエンド（Cloud Run）がデプロイされていない、または設定不備
- フロントエンドのみが存在し、バックエンドが未実装
- Phase 1（Step 2-9）では**ローカル環境**で開発を進める方針に決定

**完了した対応**:
- ✅ Firebase CLI再ログイン
- ✅ 本番環境ユーザー確認（`admin@sugu-suru.com`が存在）
- ✅ Firestoreセキュリティルールデプロイ
- ✅ `.env.local`修正（パスワード→`pass1234`）

**保留した問題**:
- ❌ バックエンドAPI（Cloud Run）の404エラー
- ❌ Firebase権限エラー（一部残存）

**再開条件**:
- Phase 2「バックエンド実装」フェーズで対応
- Cloud Runへのバックエンドデプロイ時

**記録先**:
- [production_issues_report.md](file:///C:/Users/kazen/.gemini/antigravity/brain/2826535e-a1b5-4cf1-899e-d11b8801f16d/production_issues_report.md)

**次のアクション**:
- ローカル環境（localhost:5173）で開発を継続
- バックエンド実装フェーズ時に本番環境問題を解決

---

## 📋 保留した判断

### 3. セッション管理プロトコル改善

**議論の経緯**:
- セッション開始・終了のファイル更新にブレがある問題を指摘
- 改善案A/B/Cを提示：
  - **改善案A（推奨）**: 最小セット + 段階的拡張
  - **改善案B（保守的）**: 完全チェックリスト方式
  - **改善案C**: ハ イブリッド方式
- → **承認待ち**

**提案ドキュメント**:
- `brain/session-protocol-improvement.md`（作成済み）

**問題点**:
- 承認されていないため、まだ適用されていない
- 今回のセッション終了時にどのプロトコルで進めるか未定

**再開条件**:
- ユーザー承認後

**次のアクション**:
- 次回セッション開始時に再確認
- 承認されたら、session-management-protocol-complete.mdを更新

---

## 📋 ADR作成検討（結論: 不要）

### Firebase認証戦略

**議論**:
ADR-008: Firebase認証戦略を作成すべきか？

**判定**:
```
判定チェック:
- アーキテクチャの根本的変更？
  → No（認証層追加だが、既存アーキテクチャの延長）
  
- 開発原則の確立？
  → No（既存の原則に従っているだけ）
  
- 技術選定の重要判断？
  → Yes（Firebase Authを採用）
  → しかし、Firebaseは既に採用済み（Firestore使用中）
  → 追加機能の利用なので、ADRレベルではない
  
結論: SYSTEM_PHILOSOPHY.mdに記録（ADR不要）
```

**対応**:
- SYSTEM_PHILOSOPHY.md + CHANGELOG_SYSTEM_PHILOSOPHY.mdに記録
- ADR作成は不要

---

## ✅ 解決済み（Resolved）

### #3. セッション管理プロトコル改善

**記録日**: 2026-01-21  
**解決日**: 2026-01-21  
**優先度**: 中

**内容**: セッション管理プロトコルの実効性向上

**解決方法**:
- session-management-protocol-complete.mdを更新
- セッション開始プロトコルにUNRESOLVED_DISCUSSIONS.md確認を追加
- セッション終了プロトコルに未解決議論の確認を追加

**成果物**:
- session-management-protocol-complete.md（更新版）
- SESSION_CHECKLIST.md（新規作成）

---

### #4. セッション開始プロトコル修正

**記録日**: 2026-01-21  
**解決日**: 2026-01-21  
**優先度**: 中

**内容**: SESSION_CHECKLIST.md作成が抜けていた

**解決方法**:
- session-management-protocol-complete.mdのステップ1にSESSION_CHECKLIST.md作成を追加

**成果物**:
- session-management-protocol-complete.md（修正版）

---

### #5. 小さく開発への方針転換

**記録日**: 2026-01-22  
**解決日**: 2026-01-22  
**優先度**: 高

**内容**: Penta-Shield（L4/L5）とLayer A/B/Cは過剰設計だった

**解決方法**:
1. ✅ 既存コード動作確認テスト実施（6項目）
   - テスト結果: パターンA（完全動作） ✅✅✅✅✅✅
   - 判定: 選択肢B（そのまま使う）を採用
2. ✅ ADR-009作成（シンプルアーキテクチャへの回帰）
   - テスト内容、3つの選択肢、選択理由を詳細に記録
3. ✅ ADR-004/005/006/008のStatusを「Superseded by ADR-009」に更新
4. ✅ READING_INDEX.mdにADR-009追加

**今後の方針**:
- 既存コード（Receipt, Client, Job, Staff）: そのまま使う
- 新機能（仕訳入力等）: シンプル版（3層構成）で実装
- L4/L5: 永久に不採用
- Layer A/B/C: 永久に不採用

**成果物**:
- ADR-009-simple-architecture.md
- ADR-004/005/006/008（Status更新）
- READING_INDEX.md（更新）
- investigateExistingCode.ts（テスト実施後削除）

---

### #6. 開発の優先順序（AI API vs L1-3定義）

**記録日**: 2026-01-22  
**解決日**: 2026-01-22  
**優先度**: 高

**内容**: 開発の順序（AI API実装 vs L1-3定義）

**議論の経緯**:
- AI API実装を先にすべきか？
- L1-3定義を先にすべきか？
- ユーザーの指摘:「人間が必要とするプロパティやスキーマにAIを合わせさせるためにL1-3があるのでは？」

**誤ったアプローチ**:
1. ❌ AI API実装（先）→ AIの出力形式に合わせる
2. ❌ L1-3定義（後）→ AIの出力に合わせてスキーマを作る

**問題点**:
- AIが主、人間が従になる
- AIの出力形式に振り回される
- L1-3の本質（人間が定義する防御層）を無視

**正しいアプローチ**:
1. ✅ **L1-3定義（先）** → 人間が必要とするデータ構造を決める
2. ✅ **AI API実装（後）** → L1（Zodスキーマ）に合わせてAIの出力を整形

**原則**:
- **人間が主、AIが従**
- L1（Zodスキーマ）が真実の情報源
- AIはL1に従って出力を整形する

**決定した順序**:
1. MVP定義（1-2時間）
2. **L1-3定義**（3-4時間） - 人間が主導
3. **AI API実装**（2-3時間） - L1に従う
4. UIモック（4-6時間）

**成果物**:
- 開発順序の明確化（次回セッションから適用）

---

### #7. 小さく開発のスコープ決定

**記録日**: 2026-01-22  
**解決日**: 2026-01-22  
**優先度**: 最高

**内容**: Phase 1（テスト環境）で実装する機能のスコープ決定

**ユーザー提示の要件**:
1. 領収書→仕訳→CSV出力
2. 顧問先登録・編集UI
3. スタッフ登録・修正UI + 設定管理

**決定内容**:

**Phase 1（テスト環境・7-8日）**:
- 環境: Gemini API（無料版）、Firebase Spark Plan（無料版）、手動アップロード
- コスト: $0
- 実装する機能:
  1. 領収書手動アップロード → AI仕訳 → CSV出力
  2. 顧問先CRUD（既存Client L1-3活用）
  3. スタッフCRUD（既存Staff L1-3活用）

**Phase 2（本番環境・1-2週間）**:
- 環境: Vertex AI（有料版）、Firebase Blaze Plan（有料版）、GAS自動監視
- コスト: 約$12/月
- 追加機能:
  1. Google Drive自動監視（GAS）
  2. Vertex AI Batch API実装
  3. 設定管理UI（Admin画面）
  4. ジョブ管理・履歴

**Step 1-9のスケジュール**:
1. Step 1: スコープ決定（1-2時間）✅ 完了
2. Step 2: L1-3定義（3-4時間）
3. Step 3: AI API実装（2-3時間）
4. Step 4: UIモック（4-6時間）
5. Step 5-6: 顧問先/スタッフCRUD（2日）
6. Step 7: 仕訳入力実装（2日）
7. Step 8: CSV出力実装（1日）
8. Step 9: E2Eテスト（1日）

**成果物**:
- implementation_plan.md（Brain）
- TASK_MASTER.md更新（タスクG追加）

---

### #8. Milestone導入の検討

**記録日**: 2026-01-23  
**解決日**: 2026-01-23（既に2026-01-22に決定済み）  
**優先度**: 中

**内容**: Phase 1実装計画の詳細化

**解決方法**:
- ✅ **既にimplementation_plan.mdで決定済み**（2026-01-22）
- Milestone 1.1-1.4が定義済み
  - Milestone 1.1: OCR→仕訳表示（2-3日）
  - Milestone 1.2: マスターデータ管理（2-3日）
  - Milestone 1.3: 仕訳編集（2-3日）
  - Milestone 1.4: CSV出力＋E2Eテスト（1-2日）

**誤り**:
- 既に決定済みなのに「未解決議論」として扱ってしまった

**成果物**:
- implementation_plan.md（L19-23、L69以降にMilestone定義済み）

---

### #9. ADR-009の制約の再検討（段階的実装）

**記録日**: 2026-01-23  
**解決日**: 2026-01-23（既に2026-01-22に決定済み）  
**優先度**: 中

**内容**: L1/L2/L3の段階的実装を許可すべきか

**解決方法**:
- ✅ **既にimplementation_plan.mdで決定済み**（2026-01-22）
- 「簡易版 vs 将来の拡張」セクション（L390-430）で明記

**決定内容**:
- **Phase 1（簡易版・最小限）**:
  - ✅ 型チェック（Zod）
  - ✅ 借方=貸方検証のみ
  - ❌ State Machine（Phase 2で追加）
  - ❌ 詳細な業務ルール検証（Phase 2で追加）

- **Phase 2（将来の拡張）**:
  - State Machine完全版
  - 詳細な業務ルール（日付、金額、勘定科目等）
  - エラーハンドリング完全版

- **ADR-009との整合性**:
  - ✅ L1/L2/L3のみ（L4/L5は永久に不採用）
  - ✅ シンプルな3層構成
  - ✅ 段階的実装は許可（簡易版→完全版）

**誤り**:
- 既に決定済みなのに「未解決議論」として扱ってしまった

**成果物**:
- implementation_plan.md（L390-432に詳細記載）

---

## 更新履歴

### #8. Milestone導入の検討

**記録日**: 2026-01-23  
**優先度**: 中

**内容**: Phase 1実装計画の詳細化

**背景**:
- 現在のPhase 1（7-8日）が粗すぎる
- 「領収書→仕訳→CSV」の中に複数の機能が混在
- 途中で調整しづらい

**提案**:
- **選択肢A（推奨）**: Milestone導入
  - Milestone 1.1: OCR→仕訳表示（簡易版、2-3日）
  - Milestone 1.2: マスターデータ管理（2-3日）
  - Milestone 1.3: 仕訳編集（2-3日）
  - Milestone 1.4: CSV出力＋E2Eテスト（1-2日）
- **選択肢B**: Phase細分化（Phase 1.1〜1.4）
- **選択肢C**: Step細分化（Step 1-30）

**メリット（選択肢A）**:
- 各Milestoneで価値提供
- 途中で方向転換しやすい
- 進捗が見やすい

**再開条件**: ユーザー承認

**次のアクション**: 選択肢を選択後、implementation_plan.md更新

---

### #9. ADR-009の制約の再検討

**記録日**: 2026-01-23  
**優先度**: 中

**内容**: 「永久に不採用」という表現が制約しすぎている可能性

**背景**:
- ADR-009で「L4/L5永久に不採用」「Layer A/B/C永久に不採用」と記載
- Layer A/B/Cという**用語**は確かに不要 ✅
- しかし**段階的実装という手法**は有用かもしれない ⚠️

**問題点**:
- L1/L2/L3を最初から完全版で実装すると認知負荷が高い
- 価値提供が遅れる

**提案**:
- **アプローチA**: ADR-009に厳密に準拠（最初から完全版）
- **アプローチB（推奨）**: ADR-009の精神を守りつつ、段階的実装
  - L4/L5は永久に不採用 ← ADR-009に従う ✅
  - L1/L2/L3は段階的に実装 ← 柔軟性 ✅
  - Layer A/B/Cという用語は使わない ← ADR-009に従う ✅
  - Phase 1: L1/L2/L3の簡易版（型チェック＋借方=貸方のみ）
  - Phase 2: L1/L2/L3の完全版（State Machine追加）
- **アプローチC**: ADR-009を修正（ADR-012作成）

**再開条件**: ユーザー承認

**次のアクション**: 
- アプローチB採用の場合: implementation_plan.mdに「L1/L2/L3の段階的実装戦略」を明記
- アプローチC採用の場合: ADR-012作成

---

## 更新履歴

- **2026-01-23 10:05**: 8件目・9件目追加（Milestone導入、ADR-009制約の再検討）
- **2026-01-22 21:48**: 7件目追加（小さく開発のスコープ決定：Phase 1実装計画）
- **2026-01-22 21:22**: 6件目追加（開発の優先順序：人間が主、AIが従）
- **2026-01-22 00:26**: 5件目追加（小さく開発への方針転換）
- **2026-01-21 23:40**: 4件目を解決済みに更新（セッション開始プロトコル修正完了）
- **2026-01-21 23:33**: 4件目追加（セッション開始プロトコル修正未完了）
- **2026-01-21**: 初版作成（Firebase認証設定セッション）



1. **必須**: ADR-005, ADR-006を読む（1時間）
2. **必須**: ADR-008作成（1時間）
3. **必須**: implementation_plan.md作成（2時間）
4. **推奨**: UseCaseの絞り込み（207件 → 10件程度）
5. **推奨**: Mapping Tableテンプレート作成

**優先度**: **高**（Phase 3-Bの代わりに実施）

**次回対応**: ✅ **次回セッションで対応予定**（2026-01-22承認）

**議論の重要性**:
- L4/L5の本質理解（「意味と画面の束縛」「意味の不変性保証」）
- 過去の失敗（表示されない、デバッグ不能）の根本原因理解
- Layer A/B/Cの組み合わせによる段階的実装戦略

---

### #10. Step 2（L1-3定義）での設計決定 ✅ **解決**（2026-01-23）

**記録日**: 2026-01-23  
**優先度**: 高

**議論の経緯**:
- JournalEntry/JournalLine のスキーマ定義
- 税額判定戦略の選択（A/B/C）
- UI表示方針（Streamed調査）
- Phase 2延期の判断

**解決内容**:

1. **データ構造の確定**
   - JournalEntry: 19プロパティ
   - JournalLine: 16プロパティ
   - 税額の三重構造（証憑値/計算値/最終値）

2. **税額判定戦略C採用**
   - デフォルト: OCR抽出値を採用
   - 検証: 計算値とのズレを検出
   - ユーザー判定: OK / WARNING / ERROR

3. **UI表示方針（Streamed調査結果）**
   - 仕訳一覧: 税額非表示（情報量削減）
   - ズレ検出: ⚠️ アラート表示
   - 詳細モーダル: 証憑画像+仕訳の並列表示
   - CSV出力: 税額を含める

4. **Phase 2延期の判断**
   - approvedBy/approvedAt: Phase 1では1名のため不要
   - exportHistory: Phase 1では初回のみのため不要
   - aiConfidenceBreakdown: Phase 1では全体の信頼度で十分

**記録先**:
- [step2_l1-3_definition.md](file:///C:/Users/kazen/.gemini/antigravity/brain/2826535e-a1b5-4cf1-899e-d11b8801f16d/step2_l1-3_definition.md)

**解決日**: 2026-01-23

---

## 更新履歴

- **2026-01-23 18:05**: 10件目追加（Step 2の設計決定：税額判定戦略C、UI表示方針、Phase 2延期判断）
- **2026-01-23 17:36**: Step 2（L1-3定義）開始。JournalEntry/JournalLineのプロパティ確定（19+16プロパティ）
- **2026-01-23 12:35**: 3件目追加（本番環境の認証・API問題、Phase 2で解決予定）
- **2026-01-23 10:12**: 8件目・9件目を解決済みに移動（既にimplementation_plan.mdで決定済みだった）
- **2026-01-23 10:05**: 8件目・9件目追加（Milestone導入、ADR-009制約の再検討）→ 誤り、削除
- **2026-01-22 21:48**: 7件目追加（小さく開発のスコープ決定：Phase 1実装計画）
- **2026-01-22 21:22**: 6件目追加（開発の優先順序：人間が主、AIが従）
- **2026-01-22 00:26**: 5件目追加（小さく開発への方針転換）
- **2026-01-21 23:40**: 4件目を解決済みに更新（セッション開始プロトコル修正完了）
- **2026-01-21 23:33**: 4件目追加（セッション開始プロトコル修正未完了）
- **2026-01-21**: 初版作成（Firebase認証設定セッション）
