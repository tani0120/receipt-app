# 旧Firebase APIキーの安全な削除手順

**実施日**: 2026-01-24  
**対象キー**: Browser key (auto created by Firebase)  
**理由**: GitHubに漏洩したため、セキュリティ上の理由で削除

---

## ✅ 事前確認（完了）

| 項目 | 状態 |
|------|------|
| 新しいAPIキーの作成 | ✅ 完了（`***REMOVED***`） |
| `.env.local`の更新 | ✅ 完了 |
| ローカル環境での動作確認 | ✅ 完了（ブラウザ検証済み） |
| 新キーの使用確認 | ✅ 完了（実行中のアプリで確認済み） |

---

## 📋 安全な削除手順（5ステップ）

### Step 1: コード内で旧キーの使用を検索（所要時間: 2分）

**目的**: 旧キーがコード内にハードコードされていないか確認

**実行コマンド**:
```powershell
Select-String -Pattern "AIzaSyCCBUrc" -Path "C:\Users\kazen\OneDrive\デスクトップ\ai_gogleanti\*" -Recurse -ErrorAction SilentlyContinue
```

**期待される結果**: 
- ❌ **検出なし**（既にGit履歴から削除済み）
- ✅ 検出された場合は、該当ファイルを修正

**実施状況**: 🔄 **実行中**

---

### Step 2: 旧キーのバックアップ作成（所要時間: 1分）

**目的**: 万が一の場合に備えて、旧キーを一時的に保存

**手順**:
1. Google Cloud Console を開く: https://console.cloud.google.com/apis/credentials?project=sugu-suru
2. 「**Browser key (auto created by Firebase)**」をクリック
3. APIキーの文字列を**コピー**
4. 一時的なテキストファイルに保存（例: デスクトップの`old_api_key_backup.txt`）
5. ⚠️ **重要**: このファイルは削除テスト完了後、即座に削除すること

**バックアップ先**（例）:
```
C:\Users\kazen\Desktop\old_api_key_backup.txt
```

**バックアップ内容（例）**:
```
# Firebase Browser Key - 一時バックアップ
# 作成日: 2026-01-24
# 削除テスト完了後、このファイルを削除すること

AIzaSy... （旧キー）
```

**実施状況**: ⏳ **待機中**（ユーザーが実施）

---

### Step 3: 旧キーの削除実行（所要時間: 1分）

**目的**: 漏洩したAPIキーを削除し、セキュリティリスクを除去

**手順**:
1. Google Cloud Console で「**Browser key (auto created by Firebase)**」の横にある **「︙」（3点メニュー）** をクリック
2. **「削除」** を選択
3. 確認ダイアログで **「削除」** をクリック
4. 削除完了を確認

**削除対象のキー**:
- 名前: **Browser key (auto created by Firebase)**
- 作成日: 2025/12/25
- 制限: 24個のAPI

**実施状況**: ⏳ **待機中**（Step 2完了後）

---

### Step 4: 即座にテスト実行（所要時間: 3分）

**目的**: 削除後もアプリケーションが正常に動作することを確認

#### 4-1. ローカル環境のテスト

1. ブラウザで http://localhost:5173 を開く
2. ログイン画面が表示されるか確認
3. `***REMOVED***` / `***REMOVED***` でログイン
4. ✅ ログイン成功 → OK
5. ✅ データが正常に読み込まれる → OK
6. ❌ エラーが表示される → **Step 5（ロールバック）へ**

#### 4-2. 本番環境のテスト（オプション）

1. https://receipt-api-8339700410.asia-northeast1.run.app を開く
2. 同じ手順でログインテスト
3. ⚠️ **注意**: 本番環境は別の認証問題があるため、失敗しても旧キーとは無関係

**テスト結果の記録**:

| 環境 | ログイン | データ読み込み | エラー有無 | 結果 |
|------|---------|---------------|-----------|------|
| ローカル | ⏳ | ⏳ | ⏳ | ⏳ |
| 本番 | ⏳ | ⏳ | ⏳ | ⏳ |

**実施状況**: ⏳ **待機中**（Step 3完了後）

---

### Step 5: ロールバック手順（問題発生時のみ）

**実行条件**: Step 4のテストで問題が発生した場合のみ

#### 5-1. 新しいAPIキーとして旧キーを再作成

1. Google Cloud Console で「+ 認証情報を作成」→「APIキー」
2. バックアップファイル（`old_api_key_backup.txt`）から旧キーをコピー
3. ⚠️ **注意**: Google Cloud Consoleでは同じキー文字列を再作成できないため、この方法は使用不可
4. 代わりに、**新しいキーを作成し、制限を「なし」に設定**

#### 5-2. `.env.local`を旧キーに戻す

```bash
# .env.localを編集
VITE_FIREBASE_API_KEY=（バックアップから復元）
```

#### 5-3. 開発サーバーを再起動

```bash
# 再起動
npm run dev
```

#### 5-4. 再テスト

- ローカル環境でログイン確認
- 正常動作を確認

**実施状況**: ⏳ **待機中**（問題発生時のみ）

---

### Step 6: バックアップファイルの削除（所要時間: 1分）

**実行条件**: Step 4のテストが成功した場合

**手順**:
1. デスクトップの `old_api_key_backup.txt` を開く
2. 内容を確認（念のため）
3. ファイルを削除
4. ゴミ箱を空にする

**実施状況**: ⏳ **待機中**（Step 4完了後）

---

## 📊 チェックリスト

作業完了後、以下を確認してください：

- [ ] **Step 1**: コード内で旧キーが検出されない
- [ ] **Step 2**: 旧キーをバックアップした
- [ ] **Step 3**: Browser key を削除した
- [ ] **Step 4-1**: ローカル環境でログイン成功
- [ ] **Step 4-2**: 本番環境でログイン成功（オプション）
- [ ] **Step 6**: バックアップファイルを削除した

---

## ⚠️ 重要な注意事項

1. **削除前に必ずバックアップを作成**してください
2. **テストは削除後、即座に実施**してください（時間を空けない）
3. **問題が発生したら、すぐにロールバック**してください
4. **バックアップファイルは、テスト完了後すぐに削除**してください

---

## 🎯 期待される結果

| 項目 | 期待値 |
|------|--------|
| ローカル環境のログイン | ✅ 成功 |
| データの読み込み | ✅ 正常 |
| エラーの発生 | ❌ なし |
| 旧キーの使用 | ❌ なし（新キーのみ） |

---

**準備ができたら、Step 1 の結果を確認してから、Step 2 に進んでください。**
