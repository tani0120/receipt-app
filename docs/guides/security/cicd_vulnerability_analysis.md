# CI/CDè„†å¼±æ€§åˆ†æãƒ¬ãƒãƒ¼ãƒˆ: æš—é»™çš„anyå‹ã®æ¤œçŸ¥å¤±æ•—

**ç™ºè¦‹æ—¥**: 2026-01-24  
**é‡è¦åº¦**: High  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æœªä¿®æ­£  
**å½±éŸ¿**: ADR-011 ã®é˜²å¾¡å±¤ã«ç©´ãŒå­˜åœ¨

---

## ğŸš¨ å•é¡Œã®æœ¬è³ª

### GeminiVisionService.tsã®æš—é»™çš„anyå‹ãŒCI/CDã‚’é€šã‚ŠæŠœã‘ãŸ

**è©²å½“ç®‡æ‰€**:
```typescript
// src/services/ai/GeminiVisionService.ts

// L78: response.json() â†’ æš—é»™çš„ãªanyå‹
const result = await response.json();
const jsonText = result.candidates[0].content.parts[0].text;

// L87: JSON.parse() â†’ æš—é»™çš„ãªanyå‹
const parsed = JSON.parse(cleanedJson);
```

**å•é¡Œ**:
- âœ… TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯é€šéï¼ˆå‹ã‚¨ãƒ©ãƒ¼ãªã—ï¼‰
- âœ… AST ãƒã‚§ãƒƒã‚¯ï¼ˆcheck-partial.tsï¼‰ã¯é€šé
- âœ… grepæ¤œç´¢ï¼ˆtype-safety.yml L38, L62ï¼‰ã¯é€šé
- âŒ ã—ã‹ã—ã€ã“ã‚Œã‚‰ã¯**æš—é»™çš„ãªanyå‹**ã§ã‚ã‚‹

---

## ğŸ“‹ CI/CDã‚’é€šã‚ŠæŠœã‘ãŸ3ã¤ã®ç†ç”±

### ç†ç”±1: AST ãƒã‚§ãƒƒã‚¯ãŒ `src/services` å±¤ã‚’æ¤œè¨¼ã—ã¦ã„ãªã„

**check-partial.ts L17-18**:
```typescript
const domainFiles = project.getSourceFiles('src/domain/**/*.ts');
const featureFiles = project.getSourceFiles('src/features/**/*.ts');
```

**å•é¡Œ**:
- âŒ `src/services` å±¤ãŒæ¤œè¨¼å¯¾è±¡å¤–
- âœ… `src/domain` ã¨ `src/features` ã®ã¿æ¤œè¨¼
- ğŸ”¥ GeminiVisionService.ts ã¯ `src/services/ai/` ã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€AST ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ãƒ« ãƒ¼

**ã“ã‚ŒãŒCI/CDã‚’é€šã‚ŠæŠœã‘ãŸæœ€å¤§ã®ç†ç”±ã§ã™ã€‚**

---

### ç†ç”±2: grepæ¤œç´¢ãŒæš—é»™çš„anyå‹ã‚’æ¤œçŸ¥ã§ããªã„

**type-safety.yml L38**:
```yaml
if grep -r "Partial<\|:\s*any" src/domain src/features 2>/dev/null | grep -v "@type-audit"; then
```

**type-safety.yml L62**:
```yaml
if grep -r ":\s*any" src 2>/dev/null | grep -v "node_modules" | grep -v "@type-audit"; then
```

**æ¤œç´¢ãƒ‘ã‚¿ãƒ¼ãƒ³**: `:\s*any`

**å•é¡Œ**:
```typescript
// âœ… æ¤œçŸ¥ã§ãã‚‹: æ˜ç¤ºçš„ãªanyå‹
const result: any = await response.json();

// âŒ æ¤œçŸ¥ã§ããªã„: æš—é»™çš„ãªanyå‹
const result = await response.json(); // â† `: any` ã¨ã„ã†æ–‡å­—åˆ—ãŒå­˜åœ¨ã—ãªã„
```

**æš—é»™çš„anyå‹ã¯ `const result = ...` ã¨ã„ã†å½¢å¼ãªã®ã§ã€grepæ¤œç´¢ã§ã¯æ¤œçŸ¥ä¸å¯èƒ½ã§ã™ã€‚**

---

### ç†ç”±3: TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®è¨­å®šãŒæš—é»™çš„anyå‹ã‚’è¨±å®¹ã—ã¦ã„ã‚‹

**tsconfig.app.json**:
```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    // ...
  }
}
```

**å•é¡Œ**:
- âœ… `noImplicitAny: true` ã¯è¨­å®šã•ã‚Œã¦ã„ã‚‹
- âŒ ã—ã‹ã—ã€`response.json()` ã¨ `JSON.parse()` ã¯**TypeScriptæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§å®šç¾©ã•ã‚ŒãŸanyå‹**

**TypeScriptæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å‹å®šç¾©**:
```typescript
// lib.dom.d.ts
interface Body {
  json(): Promise<any>; // â† æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§anyå‹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
}

// lib.es5.d.ts
interface JSON {
  parse(text: string): any; // â† æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§anyå‹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹
}
```

**ã“ã‚Œã‚‰ã¯ã€Œæš—é»™çš„anyå‹ã€ã§ã¯ãªãã€Œæ˜ç¤ºçš„ã«anyå‹ã¨ã—ã¦å®šç¾©ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¡ã‚½ãƒƒãƒ‰ã€ãªã®ã§ã€`noImplicitAny`ã§ã¯æ¤œçŸ¥ã•ã‚Œã¾ã›ã‚“ã€‚**

---

## ğŸ” ä»–ã®æ­£å¸¸ãªã‚¨ãƒ©ãƒ¼

### CsvExportService.ts (L96, L363, L364)

**types/firestore.ts L290, L363-364**:
```typescript
// L290
apiResponse?: any; // Raw response from NTA API

// L363-364
previousData?: any;   // LOG_OLD_DATA
newData?: any;        // LOG_NEW_DATA
```

**ã“ã‚Œã‚‰ã¯**:
- âœ… **å¤–éƒ¨APIç”±æ¥ã®anyå‹**
- âœ… **ç›£æŸ»ãƒ­ã‚°ç”¨ã®anyå‹**ï¼ˆæŸ”è»Ÿæ€§ãŒå¿…è¦ï¼‰
- âš ï¸ **`@type-audit`ã‚³ãƒ¡ãƒ³ãƒˆãŒå¿…è¦**

**åˆ¤å®š**: ã“ã‚Œã‚‰ã¯**æ½œåœ¨çš„ã«è¨±å®¹ã•ã‚Œã‚‹anyå‹**ã§ã™ãŒã€`@type-audit`ã‚³ãƒ¡ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚

---

## ğŸ“Š CI/CDé˜²å¾¡å±¤ã®è„†å¼±æ€§ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

| é˜²å¾¡å±¤ | æ¤œè¨¼å¯¾è±¡ | GeminiVisionService.ts | çµæœ |
|--------|---------|----------------------|------|
| L1: tsconfig strictness | æš—é»™çš„anyå‹ | âŒ æ¤œçŸ¥ä¸å¯ï¼ˆæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®anyï¼‰ | **å¤±æ•—** |
| L2: AST ãƒã‚§ãƒƒã‚¯ | anyå‹ï¼ˆTypeReferenceï¼‰ | âŒ src/servicesãŒå¯¾è±¡å¤– | **å¤±æ•—** |
| L3: Domainå±¤ strict ãƒã‚§ãƒƒã‚¯ | `: any`æ–‡å­—åˆ— | âŒ src/servicesãŒå¯¾è±¡å¤– | **å¤±æ•—** |
| L4: è¨¼è·¡ã‚³ãƒ¡ãƒ³ãƒˆæ¤œè¨¼ | `@type-audit` | âŒ srcå…¨ä½“ã‚’æ¤œç´¢ã™ã‚‹ãŒæš—é»™çš„anyã¯æ¤œçŸ¥ä¸å¯ | **å¤±æ•—** |
| L5: AI Self-Correction | äººé–“ã®æ°—ã¥ã | âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™ºè¦‹ | **æˆåŠŸ** |

**çµè«–**: **ADR-011ã®5å±¤é˜²å¾¡ã®ã†ã¡4å±¤ãŒæ©Ÿèƒ½ã›ãšã€æœ€å¾Œã®äººé–“ã®æ°—ã¥ãã®ã¿ãŒæ©Ÿèƒ½ã—ãŸã€‚**

---

## ğŸ¯ ä¿®æ­£æ¡ˆ

### ä¿®æ­£æ¡ˆ1: AST ãƒã‚§ãƒƒã‚¯ã®æ¤œè¨¼ç¯„å›²ã‚’æ‹¡å¤§ï¼ˆæ¨å¥¨ï¼‰

**check-partial.ts L17-18ã‚’ä¿®æ­£**:
```typescript
// ä¿®æ­£å‰
const domainFiles = project.getSourceFiles('src/domain/**/*.ts');
const featureFiles = project.getSourceFiles('src/features/**/*.ts');

// ä¿®æ­£å¾Œ
const domainFiles = project.getSourceFiles('src/domain/**/*.ts');
const featureFiles = project.getSourceFiles('src/features/**/*.ts');
const serviceFiles = project.getSourceFiles('src/services/**/*.ts'); // â† è¿½åŠ 

[...domainFiles, ...featureFiles, ...serviceFiles].forEach(file => {
  // ...
});
```

**åŠ¹æœ**:
- âœ… src/services å±¤ã‚‚ASTãƒã‚§ãƒƒã‚¯ã®å¯¾è±¡ã«ãªã‚‹
- âœ… æš—é»™çš„anyå‹ã‚‚æ¤œçŸ¥å¯èƒ½
- âœ… CI/CDãŒæ­£ã—ãæ©Ÿèƒ½ã™ã‚‹

---

### ä¿®æ­£æ¡ˆ2: GeminiVisionService.tsã«`@type-audit`ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 

**L78, L87ã«è¿½åŠ **:
```typescript
// L78
// @type-audit: external-library (Gemini API v1beta)
// @approved-by: TD-001å¯¾å¿œ
// @reason: Gemini APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ãŒä¸å®Œå…¨ã€å¾Œç¶šã®Zodã‚¹ã‚­ãƒ¼ãƒã§æ¤œè¨¼
const result = await response.json();

// L87
// @type-audit: external-data (JSON.parse)
// @approved-by: TD-001å¯¾å¿œ
// @reason: å¤–éƒ¨JSONãƒ‡ãƒ¼ã‚¿ã®å‹ãŒä¸æ˜ã€å¾Œç¶šã®Zodã‚¹ã‚­ãƒ¼ãƒã§æ¤œè¨¼
const parsed = JSON.parse(cleanedJson);
```

**åŠ¹æœ**:
- âœ… å½¢å¼çš„ã«ADR-011ã«æº–æ‹ 
- âœ… CI/CD L4ï¼ˆè¨¼è·¡ã‚³ãƒ¡ãƒ³ãƒˆæ¤œè¨¼ï¼‰ãŒæ©Ÿèƒ½ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼ˆgrepãƒ‘ã‚¿ãƒ¼ãƒ³æ¬¡ç¬¬ï¼‰
- âŒ ãŸã ã—ã€æš—é»™çš„anyå‹ãªã®ã§ grepæ¤œç´¢ã§ã¯æ¤œçŸ¥ä¸å¯

---

### ä¿®æ­£æ¡ˆ3: `unknown`å‹ã«æ˜ç¤ºçš„ã«å‹ä»˜ã‘

**L78, L87ã‚’ä¿®æ­£**:
```typescript
// L78
const result: unknown = await response.json();
// å‹ã‚¬ãƒ¼ãƒ‰ã§å®‰å…¨ã«æ‰±ã†
if (typeof result === 'object' && result !== null && 'candidates' in result) {
  const candidates = (result as { candidates: Array<{ content: { parts: Array<{ text: string }> } }> }).candidates;
  const jsonText = candidates[0].content.parts[0].text;
  // ...
}

// L87
const parsed: unknown = JSON.parse(cleanedJson);
// Zodã‚¹ã‚­ãƒ¼ãƒã§æ¤œè¨¼ï¼ˆL139ã§å®Ÿæ–½æ¸ˆã¿ï¼‰
const validated = JournalEntryDraftSchema.parse(parsed);
```

**åŠ¹æœ**:
- âœ… æš—é»™çš„anyå‹ã‚’å®Œå…¨ã«æ’é™¤
- âœ… å‹å®‰å…¨æ€§ãŒå‘ä¸Š
- âŒ ã‚³ãƒ¼ãƒ‰é‡ãŒå¢—åŠ 

---

## ğŸ”— å½±éŸ¿ç¯„å›²

### åŒæ§˜ã®å•é¡ŒãŒå­˜åœ¨ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ç®‡æ‰€

1. **src/services/** é…ä¸‹ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«
   - AST ãƒã‚§ãƒƒã‚¯ã®å¯¾è±¡å¤–ã®ãŸã‚ã€anyå‹ãŒæ··å…¥ã—ã¦ã„ã‚‹å¯èƒ½æ€§

2. **å¤–éƒ¨APIã‚’å‘¼ã³å‡ºã™ç®‡æ‰€**
   - `response.json()` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€
   - `JSON.parse()` ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€

3. **types/firestore.ts ã® anyå‹**
   - `apiResponse?: any` (L290)
   - `previousData?: any` (L363)
   - `newData?: any` (L364)
   - ã“ã‚Œã‚‰ã¯ `@type-audit` ã‚³ãƒ¡ãƒ³ãƒˆãŒå¿…è¦

---

## âœ… æ¨å¥¨ã™ã‚‹å¯¾å¿œï¼ˆå„ªå…ˆé †ä½é †ï¼‰

### å„ªå…ˆåº¦1ï¼ˆæœ€é«˜ï¼‰: AST ãƒã‚§ãƒƒã‚¯ã®æ¤œè¨¼ç¯„å›²ã‚’æ‹¡å¤§

- **ãƒ•ã‚¡ã‚¤ãƒ«**: `scripts/check-partial.ts`
- **å¤‰æ›´**: `src/services/**/*.ts` ã‚’æ¤œè¨¼å¯¾è±¡ã«è¿½åŠ 
- **æ‰€è¦æ™‚é–“**: 5åˆ†
- **åŠ¹æœ**: æœ€ã‚‚å¼·åŠ›ãªé˜²å¾¡å±¤ã‚’å¾©å…ƒ

### å„ªå…ˆåº¦2: GeminiVisionService.tsã«`@type-audit`ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 

- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/ai/GeminiVisionService.ts`
- **å¤‰æ›´**: L78, L87 ã« `@type-audit` ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
- **æ‰€è¦æ™‚é–“**: 3åˆ†
- **åŠ¹æœ**: å½¢å¼çš„ã«ADR-011ã«æº–æ‹ 

### å„ªå…ˆåº¦3: types/firestore.tsã«`@type-audit`ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 

- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/types/firestore.ts`
- **å¤‰æ›´**: L290, L363, L364 ã« `@type-audit` ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
- **æ‰€è¦æ™‚é–“**: 3åˆ†
- **åŠ¹æœ**: ã™ã¹ã¦ã®anyå‹ãŒè¨¼è·¡ä»˜ãã«ãªã‚‹

### å„ªå…ˆåº¦4ï¼ˆä½ï¼‰: `unknown`å‹ã«æ˜ç¤ºçš„ã«å‹ä»˜ã‘

- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/ai/GeminiVisionService.ts`
- **å¤‰æ›´**: L78, L87 ã‚’ `unknown` å‹ + å‹ã‚¬ãƒ¼ãƒ‰ã«å¤‰æ›´
- **æ‰€è¦æ™‚é–“**: 15åˆ†
- **åŠ¹æœ**: å®Œå…¨ãªå‹å®‰å…¨æ€§

---

## ğŸ“ å­¦ã‚“ã ã“ã¨

### CI/CDã®ç›²ç‚¹

1. **AST ãƒã‚§ãƒƒã‚¯ã®æ¤œè¨¼ç¯„å›²ãŒä¸å®Œå…¨**
   - src/services å±¤ãŒæ¤œè¨¼å¯¾è±¡å¤–
   - src/api å±¤ã‚‚æ¤œè¨¼å¯¾è±¡å¤–ï¼ˆè­¦å‘Šã®ã¿ï¼‰

2. **grepæ¤œç´¢ã®é™ç•Œ**
   - æš—é»™çš„anyå‹ã¯æ¤œçŸ¥ä¸å¯
   - TypeScriptæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®anyå‹ã¯æ¤œçŸ¥ä¸å¯

3. **TypeScript ã® `noImplicitAny` ã®é™ç•Œ**
   - æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§å®šç¾©ã•ã‚ŒãŸanyå‹ã¯è¨±å®¹ã•ã‚Œã‚‹
   - `response.json()`, `JSON.parse()` ã¯åˆæ³•

### ADR-011 ã®5å±¤é˜²å¾¡ã®èª²é¡Œ

**L1-L4ãŒæ©Ÿèƒ½ã›ãšã€L5ï¼ˆäººé–“ã®æ°—ã¥ãï¼‰ã®ã¿ãŒæ©Ÿèƒ½ã—ãŸ**

- L1: tsconfig strictness â†’ æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®anyã¯è¨±å®¹
- L2: AST ãƒã‚§ãƒƒã‚¯ â†’ src/servicesãŒå¯¾è±¡å¤–
- L3: Domainå±¤ strict ãƒã‚§ãƒƒã‚¯ â†’ src/servicesãŒå¯¾è±¡å¤–
- L4: è¨¼è·¡ã‚³ãƒ¡ãƒ³ãƒˆæ¤œè¨¼ â†’ æš—é»™çš„anyã¯æ¤œçŸ¥ä¸å¯
- L5: AI Self-Correction â†’ âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™ºè¦‹

**çµè«–**: **é˜²å¾¡å±¤ã®è¨­è¨ˆã¯æ­£ã—ã„ãŒã€å®Ÿè£…ã«è„†å¼±æ€§ãŒå­˜åœ¨ã—ãŸã€‚**

---

**End of Report**
