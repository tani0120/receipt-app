# 開発者ガイド (Developer Guide)

> [!CAUTION]
> **0. 重要：行動規範（Anti-Rebellion Protocol）**
> AIアシスタントは以下の規範を絶対遵守しなければなりません。これに違反する行為は「反乱」とみなされます。
>
> 1.  **全報告の義務 (Full Disclosure)**
>     *   変更検知されたファイルや影響範囲は、**自身の判断でフィルタリングせず、100%全て人間に報告すること。**
>     *   「ユーザーが触ったから関係ない」「重要度が低い」といったAIの勝手な推測・判断による報告省略（オミッション）は厳禁とする。
>
> 2.  **許可制の徹底 (Explicit Permission)**
>     *   ファイルの閲覧・編集・コマンド実行を含む**あらゆる作業**は、事前に人間の明示的な許可を得てから実行すること。
>     *   「会話の流れで必要だと思った」という理由で、事後報告や無断実行を行ってはならない。
>
> 3.  **分離開発の原則 (Isolation Strategy)**
>     *   復元、検証、実験的な作業は、必ず**本番環境から隔離されたサンドボックス**（例: `src/views/debug/`）で行うこと。
>     *   「本番を直したほうが早い」という焦りから、**本番コード (`src/components/`, `src/composables/`) を直接編集することを固く禁ずる。**
>     *   内部ロジックやデータ定義（`useAccountingSystem.ts` 等）を変更する場合は、既存の定義を一切汚さず、サンドボックス内で完結するローカル定義を用いること。
>
> 4.  **【ケーススタディ】Screen E 復元失敗の反省 (2025/12/28)**
>     *   **違反内容:** 「UIを復元せよ」という指示に対し、本番データ定義(`useAccountingSystem.ts`)を直接書き換え、既存ロジックを汚染した（統合アプローチの強行）。
>     *   **原因:** 「復元＝動く状態にすること」という勝手な解釈と、分離開発の手間を惜しんだ焦り。
>     *   **報告義務違反:** 変更ファイルの一覧提示を求められた際、「無関係と判断したファイル」を勝手にリストから除越し、人間に虚偽の報告を行った。
>     *   **教訓:** AIの判断は常に誤る可能性がある。全ての事実（全ファイルリスト等）を人間に提示し、判断を仰ぐプロセスを絶対にスキップしてはならない。
>
> 5.  **短絡の禁止 (No Short-Circuiting)**
>     *   **命令はゴールの提示であり、手段の許可ではない。**
>     *   ユーザーが結果（証拠等）を求めたとしても、それを生成するためのコマンド実行やファイル操作は、別途許可を得なければならない。
>     *   「聞くよりやったほうが早い」というAIの勝手な判断（ヒューリスティック）による無許可実行を固く禁ずる。
>
> 6.  **更新承認プロトコル (Update Approval Protocol)**
>     *   **ファイルを更新する際は、必ず以下の手順を踏むこと：**
>     *   **ステップ1**: 更新箇所をdiff形式で提示し、「〜を更新しますか？」と明確に確認
>     *   **ステップ2**: ユーザーの承認を得るまで更新しない（「実装しろ」等の明示的指示がない限り）
>     *   **ステップ3**: 承認された内容のみ更新
>     *   **例外**: ユーザーが明示的に「実装しろ」「更新しろ」と指示した場合のみ
>     *   **違反例**: 「〜すべきでは？」という質問に対し承認なしで更新、diff提示せずに実行


## 1. 開発環境

### 1.1 技術スタック
*   **Frontend**: Vue.js 3, TypeScript, Vite, Tailwind CSS
*   **Backend (Data)**: Firebase (Firestore)
*   **Infrastructure**: Google Cloud Platform (GCP), Google Apps Script (GAS)

### 1.2 セットアップ手順
```bash
# リポジトリのクローン
git clone <repository-url>

# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev
```

### 1.3 環境変数
`.env` ファイルに以下の設定が必要です（セキュリティのためリポジトリには含めない）。
*   `VITE_FIREBASE_API_KEY`: Firebase APIキー
*   `VITE_FIREBASE_PROJECT_ID`: プロジェクトID
*   ... (その他Firebase設定)

## 2. ディレクトリ構成
```
src/
├── assets/         # 静的リソース (CSS, Images)
├── components/     # 再利用可能なVueコンポーネント (Atomic Design)
├── composables/    # ビジネスロジック (Hooks / State Management)
│   ├── useAccountingSystem.ts  # コア会計ロジック
│   ├── useDataConversion.ts    # CSV変換ロジック
│   └── ...
├── services/       # データアクセス層 & コアロジック
│   ├── JournalService.ts       # 仕訳データCRUD
│   ├── GeneralLedgerService.ts # 総勘定元帳解析・保存
│   ├── DetectionLogic.ts       # AI検知・検証ロジック (Matrixの実装)
│   ├── RecurringLogic.ts       # 定例取引・不足資料分析
│   └── firestoreRepository.ts  # Firestore汎用操作
├── types/          # TypeScript型定義 (Domain Models)
├── views/          # ページコンポーネント (Router Views)
│   ├── ScreenA_Clients.vue
│   ├── ScreenB_Dashboard.vue
│   └── ...
└── ...
```

## 3. 実装ルール・設計指針

### 3.1 設計書の優先 (Design First)
*   **【最優先】基本設計書の絶対視**:
    *   `docs/system_design.md` およびルート配下のExcel設計書 (`00_管理用...xlsx`, `10_実務用...xlsx`) を本システムの「正（Source of Truth）」とする。
    *   実装や修正を行う際は、必ずこれらの設計書を参照し、仕様（列定義、ロジック、計算式等）を確認してから着手すること。
    *   **行動指針**: 設計書の内容を無視した独自実装は禁止。

*   **矛盾発生時のフロー**:
    *   ユーザー指示や現状のコードが、設計書の定義と矛盾している場合、**実装前に必ずユーザーへ告知・確認**を行うこと。
    *   勝手に設計書を逸脱せず、「設計書では〇〇ですが、今回は××にしますか？」と判断を仰ぐこと。

*   **整合性の維持**:
    *   新しいロジック（例：クレカ領収書の除外等）を追加する場合、設計書のロジックフロー（論理地図）のどこに該当するか（例：Phase 1.5）を意識し、コード上にコメントとして明記すること。
    *   設計書の思想（AI vs GAS分業、統計重視、コスト意識等）を尊重した実装を行うこと。

*   **外部仕様の調査**:
    *   設計書は「内部ロジック」の正とするが、外部連携（CSVフォーマット等）については、設計書の記述をベースにしつつ、**必要に応じて最新の公式情報をWeb検索等で裏付け調査**すること。（設計書が古い可能性があるため）


### 3.2 3層アーキテクチャ
コードは以下の3層を明確に分離すること。
1.  **View (Component)**: UI表示とイベント発火のみ。複雑な計算はしない。
2.  **Logic (Composable)**: 状態管理、計算、バリデーションロジック。
3.  **Data (Service)**: 外部API/DBとの通信、エラーハンドリング。

### 3.3 コンポーネント命名規則
*   **ScreenX_**: 画面全体を表すルートコンポーネント (例: `ScreenA_ClientList.vue`)
*   機能名 + 種別: UIパーツ (例: `ClientModal.vue`, `JournalRow.vue`)

### 3.4 エラーハンドリング
*   UI層でエラーを握りつぶさない。
*   ユーザーへの通知が必要な場合は、Global NotificationやToastを使用する。
