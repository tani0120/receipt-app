
# 設計書(Excel)と現状コードの乖離分析レポート

**Source of Truth**: `00_管理用_AI会計システム本体.xlsx` (extracted text)
**Current Implementation**: `useAccountingSystem.ts`, `JobService.ts`

## 1. フォルダ構成・ID管理 (Folder Structure)

| 項目 | Excel定義 (Source of Truth) | 現状コード (`Client` Interface) | 乖離・対応方針 |
| :--- | :--- | :--- | :--- |
| **入口** | `共有用フォルダID` | `sharedFolderId` | 名称不一致 (許容範囲だが合わせるべき) |
| **一時保管** | `001_原本（聖域）ID` | `originalFolderId` | 名称不一致 |
| **保管** | `002_仕訳済原本ID` | **未定義** | **不足**。プロパティ追加が必要。 |
| **除外 (論理)** | `03_除外フォルダID` | **未定義** | **不足**。合意に基づき `excludedFolderId` を追加。 |
| **除外 (物理)** | `09_対象外フォルダID` | **未定義** | 合意に基づき `03` と統合するため実装不要 (廃止)。 |
| **CSV出力** | `04_共通CSV出力ID` | **未定義** | **不足**。プロパティ追加が必要。 |
| **学習用** | `05`, `06`, `99` (ID群) | **未定義** | **不足**。将来実装だが枠は必要。 |

**結論**: `Client` インターフェースに多数のフォルダIDフィールドが欠落している。

## 2. 顧問先マスタ定義 (Client Master Schema)

| 項目 | Excel定義 | 現状コード | 乖離・重要度 |
| :--- | :--- | :--- | :--- |
| **申告区分** | `青色／白色` | 未定義 | **高**: 税務処理に影響。 |
| **消費税** | `消費税申告区分` (簡易/本則) | `taxType` (簡易的) | **高**: 文言を合わせるべき。 |
| **端数処理** | `端数処理` | `rounding` | 一致 (名称のみ) |
| **インボイス** | `インボイス登録` | 未定義 | **高**: 消費税計算に必須。 |
| **3コード** | `3コード` | `clientCode` | 一致 (概念) |
| **AI設定** | `知識プロンプト` 等 | 未定義 | **中**: AIロジック実装時に必要。 |

**結論**: 税務計算に必要な「インボイス登録有無」「消費税申告区分（詳細）」がコード側で定義されていない。

## 3. ロジック / フェーズ定義 (Logic Phases)

現状の `determineAccountItem` 関数はモック実装であり、Excelの定義を完全には反映していない。

| フェーズ | Excel定義 | 現状コード (Mock) | 差異内容 |
| :--- | :--- | :--- | :--- |
| **Phase 1** | 重複(*)、期間外(*)チェック | `// Already handled by OCR` | 実装なし。要ロジック追加。 |
| **Phase 2** | BS判定 (資金移動、未払金消込) | `振替`, `移動` キーワードのみ | クレカ引落、未払金判定が未実装。 |
| **Phase 3** | 免税/リバチャ (輸出、AWS等) | `免税`, `切手` のみ | **リバースチャージ判定**が欠落。 |
| **Phase 4** | 人事/政策 (役員報酬、社保) | `給与`, `役員報酬` | 概ね一致だが、源泉徴収判定が不足。 |
| **Phase 5** | 特定リスク (>10万資産) | `>100000`, `Amazon > 50000` | Amazon特例はコード独自。Excel定義に合わせる必要あり。 |
| **Phase 6** | 一般推論 (学習/辞書) | キーワード分岐 (タクシー等) | 本来はAIモデルまたは辞書DB参照が必要。 |

## 4. その他 (Other)

*   **削除ルール**: ユーザー指示により「40日自動削除」は採用とするが、Excelには記載なし（運用ルールとしての乖離）。
*   **除外統合**: ユーザー指示により `03` と `09` を統合するが、Excel定義とは異なる（意図的乖離）。

## アクションプラン

1.  **データモデル修正**: `Client` および `Job` インターフェースをExcel定義に合わせて拡張する。
2.  **ロジック実装**: `determineAccountItem` をExcelの「論理地図」に厳密に従った分岐に書き換える（モックからの脱却）。
3.  **フォルダID連携**: `SystemSettings` または `Client` オブジェクトに正しいフォルダIDを持たせ、ファイル移動ロジック（Screen H/G）で参照するようにする。
