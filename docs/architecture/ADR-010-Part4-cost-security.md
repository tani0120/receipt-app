# ADR-010-Part4: コストとセキュリティ

**親ドキュメント**: [ADR-010](./ADR-010-ai-api-migration.md)

---

## コスト詳細

### テスト環境（無料版）

| 項目 | 無料枠 | 超過時の料金 | 想定使用量 | 実際のコスト |
|------|--------|------------|-----------|-------------|
| Firebase Hosting | 10GB/月 | $0.026/GB | 0.5GB/月 | **$0** |
| Firestore | 1GB, 50k読取, 20k書込 | 読取$0.06/10万, 書込$0.18/10万 | 5k読取, 1k書込 | **$0** |
| Authentication | 無制限 | 無料 | 10ユーザー | **$0** |
| Gemini API | 月1,500リクエスト | $0.00035/1000トークン | 100リクエスト | **$0** |
| **合計** | - | - | - | **$0** |

### 本番環境（有料版）

| 項目 | 無料枠 | 超過時の料金 | 想定使用量（月） | 実際のコスト |
|------|--------|------------|--------------|-------------|
| Hosting | 10GB/月 | $0.026/GB | 2GB/月 | $0（無料枠内） |
| Firestore | 1GB, 50k読取, 20k書込 | 読取$0.06/10万, 書込$0.18/10万 | 100k読取, 10k書込 | $0.06 |
| Authentication | 無制限 | 無料 | 50ユーザー | $0 |
| Cloud Functions | 200万呼び出し, 40万GB秒 | 呼び出し$0.40/100万, GB秒$0.0000025 | 5万呼び出し | $0（無料枠内） |
| Vertex AI | なし | 入力$0.00035/1000トークン | 50リクエスト | $0.035 |
| **合計** | - | - | - | **約$0.10（約15円）** |

### 実際の運用コスト想定

| 規模 | 月間リクエスト数 | 推定コスト |
|------|----------------|-----------|
| 小規模（開発・テスト） | 50件 | **$0.10〜$1** |
| 中規模（実運用開始） | 500件 | **$5〜$12** |
| 大規模（複数顧問先） | 5,000件 | **$50〜$100** |

---

## セキュリティチェックリスト

### テスト環境

- [ ] **API Key管理**
  - [ ] `.env.local`に保存（Git除外）
  - [ ] `.gitignore`に`.env.local`追加
  - [ ] API Keyを公開リポジトリにコミットしない

- [ ] **データ保護**
  - [ ] テストデータのみ使用
  - [ ] 実データ・個人情報を使用しない
  - [ ] 顧問先データの使用禁止ルール徹底

- [ ] **許容されるリスク**
  - [ ] ⚠️ API Keyがブラウザで露出（許容）
  - [ ] ⚠️ Googleがデータを学習に使用する可能性（許容）

### 本番環境

- [ ] **認証**
  - [ ] Firebase Authentication必須
  - [ ] 未認証ユーザーによるFunctions呼び出しを禁止
  - [ ] Service Account認証設定

- [ ] **権限管理（IAM）**
  - [ ] Service Accountに最小権限のみ付与
  - [ ] `roles/aiplatform.user`のみ
  - [ ] 不要な権限がないか確認
  - [ ] 定期的な権限レビュー

- [ ] **ネットワークセキュリティ**
  - [ ] HTTPS通信のみ許可
  - [ ] CORS設定確認
  - [ ] VPC検討（将来）

- [ ] **ログ・監視**
  - [ ] Cloud Loggingで全リクエスト記録
  - [ ] 異常なアクセスパターンの検知
  - [ ] 予算超過アラート設定
  - [ ] エラー率監視

- [ ] **データ保護**
  - [ ] Vertex AIの学習不使用保証確認
  - [ ] Firestore自動暗号化確認
  - [ ] バックアップ設定
  - [ ] データ保持期間設定

---

## セキュリティリスク比較

| リスク | テスト環境 | 本番環境 |
|--------|----------|---------|
| **API Key露出** | ⚠️ 露出（許容） | ✅ 隠蔽（Cloud Functions） |
| **データ学習** | ⚠️ 可能性あり（許容） | ✅ 使用しない保証 |
| **守秘義務** | ❌ 保証なし | ✅ 保証あり |
| **不正アクセス** | ⚠️ API Keyのみ | ✅ Firebase Auth + IAM |
| **ログ記録** | ⚠️ ブラウザのみ | ✅ Cloud Logging |
| **権限管理** | ❌ なし | ✅ IAM詳細管理 |
| **データ暗号化** | ✅ Firestore自動 | ✅ Firestore自動 |

---

## 守秘義務の保証（本番環境のみ）

### Vertex AIの保証内容

| 項目 | 内容 |
|------|------|
| **データ学習** | ✅ Googleが顧客データを学習に使用しない |
| **データ保持** | ✅ リクエスト完了後、即座に削除 |
| **データ共有** | ✅ 第三者と共有しない |
| **VPC** | ✅ VPC内にデータを閉じ込め可能 |
| **コンプライアンス** | ✅ GDPR, HIPAA準拠 |

### Gemini APIのリスク（テスト環境のみ）

| 項目 | リスク |
|------|------|
| **データ学習** | ⚠️ Googleが学習に使用する可能性 |
| **データ保持** | ⚠️ 一定期間保持される可能性 |
| **データ共有** | ⚠️ 明示的な保証なし |
| **VPC** | ❌ 不可 |

**重要**: **テスト環境では実データを絶対に使用しない**

---

## コスト最適化

### Batch API（将来検討）

| 項目 | 通常API | Batch API |
|------|---------|----------|
| **処理時間** | リアルタイム | 数分〜24時間 |
| **料金** | 100% | **50%（半額）** |
| **適用例** | リアルタイム解析 | 夜間バッチ処理 |

**実装例**:
- 夜間に一括OCR処理
- 月次レポート生成
- 学習データの一括解析

### コスト監視

- [ ] **Firebase Console → 使用量と請求額**
  - [ ] 週次で確認
  - [ ] 予算アラート設定

- [ ] **Google Cloud Console → 課金**
  - [ ] Vertex AI使用量確認
  - [ ] Cloud Functions実行回数確認

- [ ] **予算アラート設定**
  - [ ] $10/月: 警告
  - [ ] $20/月: 重要
  - [ ] $50/月: 緊急

---

## まとめ

### テスト環境（開発段階）

✅ **コスト**: 0円  
⚠️ **セキュリティ**: 低（実データ禁止）  
✅ **目的**: 機能検証

### 本番環境（運用開始後）

💰 **コスト**: 約$12/月（約1,800円）  
✅ **セキュリティ**: 高（守秘義務保証）  
✅ **目的**: 実運用

---

## 次のアクション

1. ✅ [ADR-010-Part3: チェックリスト](./ADR-010-Part3-checklist.md)のPhase 1実施（今すぐ）
2. ⏳ MVP完成後、Phase 2実施（本番移行）
3. ⏳ Firebase Blaze Planへアップグレード（本番移行時）
