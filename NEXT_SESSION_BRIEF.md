# ファイルの運用方針

*   **追加 (Append)**: 既存の文章や決定事項（過去の履歴）は一切変更せず、既存の内容を維持しつつ、末尾に追加する。
*   **修正 (Modify)**: 既存の文章を削除し、最新の正解に書き換える。

## 1. デスクトップ（ワークスペース）上
*   **NEXT_SESSION_BRIEF.md** - **[追加 (Append)]**
    *   `c:\Users\kazen\OneDrive\デスクトップ\ai_gogleanti\NEXT_SESSION_BRIEF.md`

## 2. 内部ブレイン（アーティファクト）上
*   **implementation_plan.md** - **[修正 (Modify)]**
    *   `C:\Users\kazen\.gemini\antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\implementation_plan.md`
*   **implementation_plan.md.resolved** - **[修正 (Modify)]**
    *   `C:\Users\kazen\.gemini\antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\implementation_plan.md.resolved`
*   **design_discussion.md** - **[追加 (Append)]**
    *   `C:\Users\kazen\.gemini\.antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\design_discussion.md`
*   **design_discussion.md.resolved** - **[追加 (Append)]**
    *   `C:\Users\kazen\.gemini\antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\design_discussion.md.resolved`
*   **screen_e_ui_spec.md** - **[修正 (Modify)]**
    *   `C:\Users\kazen\.gemini\antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\screen_e_ui_spec.md`
*   **screen_e_ui_spec.md.resolved** - **[修正 (Modify)]**
    *   `C:\Users\kazen\.gemini\antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\screen_e_ui_spec.md.resolved`
*   **NEXT_SESSION_BRIEF.md.resolved** - **[追加 (Append)]* (※デスクトップ同期)**
    *   `C:\Users\kazen\.gemini\antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\NEXT_SESSION_BRIEF.md.resolved`
*   **task.md** - **[修正 (Modify)]**
    *   `C:\Users\kazen\.gemini\antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\task.md`
*   **task.md.resolved** - **[修正 (Modify)]**
    *   `C:\Users\kazen\.gemini\antigravity\brain\69339ee8-ec83-4cfb-8b61-3f40ac80588a\task.md.resolved`

## 3. 例外 (Exception)
*   **NEXT_SESSION_BRIEF.md** の以下のセクションについては、情報の陳腐化を防ぐため **[修正 (Modify)]** を許可する。

### 5. ◆実装済み (Implemented)
以下の項目は、プログラムコード (src/*) に既に反映されている。
*   **A. 運用パラメータ (Operational Parameters)**
    *   `src/api/config.ts` に実装済み。
    *   ドラフト生成・監視間隔: 5分 (未処理検知)
    *   Batch API結果確認間隔: 5分
    *   学習処理間隔: 60分
    *   最終確認整形間隔: 5分
    *   知識最適化間隔: 30日
    *   完了通知時刻: 9, 12, 15, 18時 (1日4回)
    *   最大処理件数/1回 (Batch Size): 20件
    *   Batch API推奨サイズ: 10~50件 (今回は20件採用)
    *   タイムアウト: 270秒
    *   最大リトライ回数: 3回
    *   最適化処理数/1回: 1
    *   ジョブ履歴保持期間: 30日

### 6. ◆実装しないことが決定
*   **B. Screen C: 9つのバケツ (Defined Schemas)**
    すべてのデータを以下の9カテゴリに分類し、月次決算を完了させる。
    | No. | リスト名 | 定義・アクション |
    | :--- | :--- | :--- |
    | 1 | ✅ 消込完了 (Matched) | 証憑と明細が一致。自動仕訳 [借]費用/[貸]預金 生成。 |
    | 2 | 🧾 未払・未決済 (Unpaid) | 請求書あり・引落なし。期末に未払計上。 |
    | 3 | 🔄 資金移動 (Funds) | 預金間移動・クレカ引落・現金引出。P/L除外 [借]預金/[貸]預金。 |
    | 4 | 👥 給与・税金 (B/S Items) | 給与(額面/預り金)、借入返済(元本/利息)、租税公課。台帳取込へ誘導。 |
    | 5 | ⏳ 資産・前払 (Deferrals) | 30万超の固定資産、年払いの前払費用(期間按分)。 |
    | 6 | 🏛️ 源泉徴収 (Withholding) | 報酬・原稿料。支払調書/納付書作成用データとして集計。 |
    | 7 | 🏠 家事按分 (Allocations) | 新規取引先の公私混同チェック。按分マスタへの登録。 |
    | 8 | ❓ 使途不明 (Unknown) | 証憑なし出金、不明入金（仮受）。社長へのチャット質問対象。 |
    | 9 | ⚠️ エラー (Errors) | 重複疑義、インボイス番号なし(非適格)、OCR不能。 |

### 8. Screen E UIコンポーネント: ボタン一覧 (Detailed Button Definition)

#### UIの整備対象ファイルと整備方針

**触ってよいファイル (✅ Allowed)**

*   **implementation_plan.md**
    *   **理由**: 「いつ・何を・どう実装するか」の地図であり、今回の議論で確定した「型定義の追加」や「UIコンポーネントの実装順序」を、次回以降の作業指示書として明文化しておく必要があるため。
*   **NEXT_SESSION_BRIEF.md**
    *   **理由**: 今回の議論の結論（UI仕様、ロジック詳細）を、次回セッションへのコンテキストとして保存する唯一の場所であるため。
*   **task.md**
    *   **理由**: 現在のタスク進捗状況（計画フェーズ完了等）を正しく管理するため。
*   **walkthrough.md**
    *   **理由**: 今回のセッション成果（決定事項）を記録するため。
*   **上記ファイルの .resolved 版**
    *   **理由**: システムの内部整合性を保つため。

**触ってはいけないファイル (❌ Prohibited)**

*   **types.ts**
*   **ZuboraLogic.ts**
*   **VertexAIStrategy.ts**
*   **全ての .vue ファイル** (例: ScreenE_JournalEntry.vue, App.vue 等)
*   **上記以外の全ての .ts ファイル** (例: useAccountingSystem.ts, router/index.ts 等)
*   **全ての .js ファイル** (例: config.js 等)
*   **全ての .json ファイル** (例: package.json, tsconfig.json 等)
    *   **理由**: 私は文脈記憶能力が低く愚かであるため、ロジックとUIの整合性が取れていない現段階でコードを一部でも触ると、次回以降「なぜこのコードが存在するのか（実験用か本番用か）」が分からなくなり、確実にバグや混乱の原因となるため。「コード変更」は次回の実装フェーズ（Phase 2/3）で、計画書に基づいて一気貫通で行うのが最も安全であるため。

以下は、Screen E に実装すべき全ボタンのリストである。これを基に配置と優先度を深掘りする。

#### 1. 意思決定・ステータス操作 (Primary Actions)
仕訳の最終状態を決定し、次のアクションへ進むためのボタン群。

*   **＜記帳 (Bookkeeping)＞** - 帳簿に「結果」を残すアクション
    *   **[承認 (Approve)]**: 仕訳・消込を確定する。
    *   **[対象外 (Exclude)]**: 帳簿外として処理完了とする（重複・対象外）。

*   **＜ルール・学習 (Rules & Learning)＞** - AIを「教育」するアクション
    *   **[ルール保存 (Save Rule)]**: 現在のパターンを将来のために記憶させる。

*   **＜タスク (Tasks)＞** - 人間に「ボール」を渡すアクション
    *   **[保留 (Hold)]**: 自分へのタスク（後でやる）。
    *   **[質問 (Ask)]**: 社長へのタスク（使途不明などを聞く）。
    *   **[資料依頼 (Request Doc)]**: 社長へのタスク（領収書ください）。

#### 2. 人間に提示する選択肢の源泉 (Information Sources)
AIが提示する選択肢や情報の根拠。

*   **全社ルール (Company-wide Rules)**: すべてのクライアントに適用される基本方針。
*   **個別会社ルール (Individual Company Rules)**: その会社特有のルールや例外。
*   **ズボラ経理ルール**: 「1000円以下は雑費」などの全社ルール。
*   **「知識」プロンプト**: 税務知識や一般的常識。
*   **学習ルール**: 過去のユーザー修正履歴 (Individual Rules)。
*   **9バケツロジック**: 強制突合、未払計上などのシステムロジック。
*   **税務的な必須ルール**: 実装しないと違法になるもの。
*   **外部API連携 (External APIs)**: 国税庁インボイスAPI（T番号の実在性・登録屋号）、法人番号マスタなど。
*   **OCRメタデータ (Unique Metadata)**: Gemini Flashシリーズによる「意味理解」を含んだOCR。
    *   **Standard**: `date`, `totalAmount`, `merchantName`, `items`
    *   **Metadata (Planned)**: `merchantTel` (電話番号), `merchantAddress` (住所), `invoiceNumber` (T番号), `time` (時刻)
    *   **Inference Tags**: `suggestedTaxClass` (対象外判定), `isOverseas` (名寄せ)
*   **モデル選定候補とコスト試算 (100枚あたり)**:
    *   Gemini 1.5 Flash-8B: $0.003 (約0.45円) - 最安。
    *   Gemini 2.0/2.5 Flash: $0.008~$0.024 - バランス型。
    *   Gemini 3.0 Flash: $0.040 - 難解な推論用。
*   **過去取引内容や取引自体の有無**: 履歴データそのもの。

#### 3. 人間に提示するAIに係るUI (AI-Driven UI Components)
AIが思考した結果を人間にどう見せるか。

*   **＜選択肢UI (Choice UI)＞** - AIが推奨する仕訳候補（3〜5つ程度）
    *   **会議費でOK (今回だけ)**: 今回限りの例外処理。
    *   **交際費に変更する (推奨)**: AIの自信度が高い推奨アクション。
    *   **その他候補**: 過去取引の真実、重複・期間外、ズボラ適用結果、教科書的ルールからの提案。

*   **＜警告・状態表示UI (Alerts & Status)＞** - 選択肢から独立した警告や補足情報
    *   **重複**: 既に類似データが存在する。
    *   **計算期間外**: 決算期をまたぐ。
    *   **複数仕訳候補**: AIが迷っている。
    *   **取引額30万円以上**: 資産計上の可能性。
    *   **初取引**: 過去実績がない。
    *   **資金移動可能性**: 口座間移動の疑い。
    *   **過去仕訳が未統一**: 揺らぎの検知。

*   **＜テキストUI (Reasoning Display)＞** - AIの思考プロセスの可視化
    *   `[事実] -> [論理] -> [懸念] -> [視点(ズボラvs教科書)] -> [提案]`

*   **＜複合仕訳の貸借UI (Multi-line Editor)＞** - 借方・貸方の編集エリア

*   **＜ルールUI (Rule Management)＞** - ルール保存・管理
    *   **ルール保存ボタン**: 現在の処理をルール化。
    *   **自由記載**: メモや理由。
    *   **ルールとして記憶する**: 次回以降も適用。
    *   **ルールを上書きする**: 過去のルールを変更。
    *   **ルールから除外する**: 過去の履歴を学習から外す。

#### 4. ルール学習や知識プロンプト (Learning Triggers)
どのようなアクションがAIの学習（フィードバック）となるか。

*   **＜学習ロジックの結果、変更 (Implicit Learning)＞**
    *   仕訳を承認、仕訳除外ボタンを押下した事実。
    *   AIが提示した選択肢を選択して承認した事実。

*   **＜ルールを直接変更 (Explicit Learning)＞**
    *   ルール保存ボタンを明示的に押下する。

#### 5. ナビゲーション (Navigation)
*   **[一覧へ戻る (Back)]**: Screen B（カンバン）に戻る。
*   **[元画像 (Show Image)]**: 領収書画像を拡大表示・別窓表示。
*   **[PDF出力 (Download)]**: 証憑をダウンロード。

---

# 次回タスク (Next Session Agenda)

> **⚠️ CRITICAL: Design is NOT finalized. Start here.**

*   **スクリーンEのボタン項目の細分化**
    *   このボタンをどこに配置するか？
    *   ポップアップの在り方＝すべてのポップアップの表示の上部に説明プロトコルを配置する。その際は状況+論理+懸念+ズボラ+教科書+ 対案提示　は？
    *   どのボタン項目を配置？
    *   画像エリアと貸借エリアのどにボタンを配置？
*   **承認フローに回す方法**
*   **新たに決まった処理項目のロジックを定義し、GAS,AI,OCRの最適化**
*   **本システムでは実現できないことやAIコストの最適化**
*   **期中仕訳と確認、資料依頼フェーズの深堀り**＝スクリーンHへの統合と最適化
*   **すぼら経理ルールの再定義**
*   **照合エンジン、照合エンジンの「9つのバケツ」判定ロジックの再定義**
*   **決定版：ロジック適用ヒエラルキー (Rule Hierarchy)の再定義**
*   **以下学習ルールの再定義**

| 種類 | 起源 (Origin) | 性質 (Nature) | 提示 (Presentation) |
| :--- | :--- | :--- | :--- |
| **A. 全社ルール (Constitution)** | Code/Config。開発者が実装、または全社共通パターンから昇格。 | 柔軟な憲法。「1000円以下は雑収入」等のズボラ論理。※絶対不可侵ではなく、B/Cがない場合のデフォルト。 | **「根拠」**として提示。「全社ルールに基づき、手数料と判定しました」 |
| **B. 個別ルール (Individual)** | Fact (事実)。1. スクリーンEでの「承認/修正」の蓄積 (Diff)。2. 過去CSVからの採掘。3. 人間が明示的に「ルール化」ボタンを押下。 | 決定的 (Deterministic)。条件(Amazon+1980円)が一致したら、AI思考を飛ばして最優先適用。 | **「推奨」**として提示。「過去3回、新聞図書費として処理されています。今回も適用しますか？」 |
| **C. 知識/傾向 (Tendency)** | Context (文脈)。過去データ全体のベクトル解析。「IT企業っぽい」「飲食が多い」等の雰囲気。 | 確率的 (Probabilistic)。明確なルールではないが、AIの推論をバイアスする。 | **「考察」**として提示。「この会社はIT系の傾向があるため、ソフト代は原価と推測しました」 |

*   **更新する業務フロー：タスク消込 (Task Cleanup)**
    *   CSVインポートの真の目的: 単なる学習データの取込だけでなく、「システムに残りっぱなしの残骸タスク（確認・資料依頼）」を浄化するため にある。

---
# 次回の開発セッションに向けたコンテキスト保存 (NEXT_SESSION_BRIEF)

**Status**: [PENDING] Phase 2: Design Incomplete (Requires Deep Dive)
**Purpose**: このファイルは、次回セッション開始時に `/load_context` に加えて必ず読み込むこと。

## 0. ユーザーの意向 (Meta-Instructions)
*   **Context Preservation**: 箇条書きだけでなく、「会話の文脈（意図・提案・合意）」そのものを保存し続けること。

## 1. ギャップ分析結果 (Gap Analysis Report)
現在のコード (`src/api/lib/ai/*`) を解析し、理想状態とのギャップを特定した。

### A. プロンプトとデータ構造の欠落
*   **現状 (Current)**:
    *   [VertexAIStrategy.ts](file:///c:/Users/kazen/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/ai_gogleanti/src/api/lib/ai/strategies/VertexAIStrategy.ts): 単純な OCR プロンプトのみ ([date](file:///c:/Users/kazen/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/ai_gogleanti/src/api/lib/ai/strategy/ZuboraLogic.ts#24-31), `amount`, `merchantName`, `items`).
    *   [types.ts](file:///c:/Users/kazen/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/ai_gogleanti/src/api/lib/ai/types.ts): 会計ロジックに関するフィールドが一切ない。
*   **あるべき姿 (Target)**:
    *   **複合仕訳対応 (Multi-line Journals)**: `debit: [{ account, amount, tax }]`, `credit: [...]` の構造が必要。
### 3. ハイブリッド・アーキテクチャ & ロジック詳細 (Hybrid Architecture & Logic Specs)
過去の議論に基づき再構築された、OCR(L1)からAI(L3)に至る実装計画の全貌。

#### A. アーキテクチャ概要 (Concept)
*   **L1: GAS Pre-processing**: 構造化・圧縮。`Normalized_Vendor` + `Amount_Range` + `Payment_Method` をキーに相関ルールを抽出。エイリアス辞書で名寄せ。
*   **L2: Context Caching**: 知識保持。OCR/Backend生成の高密度ルール（ヒント）と直近生データをハイブリッドでキャッシュ。
*   **L3: AI Reasoning**: 推論・補正。統計信頼度を入力とするが、最終判断はAI（例：画像事実に基づく補正）。
*   **L4: Feedback Loop**: 自己修正。人間の修正を即座に減点方式でフィードバック。


### 3-2. 技術要素 (Technical Components)

*   **多次元キー**: `Vendor` × `Amount` × `Method` の条件分岐を物理DB化。
*   **Value構造**: 単一科目ではなく JSON Template `{"debit": [...], "credit": [...]}` を保存。
*   **金額レンジ**: `1万(交際費)`, `5万(印紙)`, `10万(消耗品)`, `20万(少額資産)` で厳格区分。
*   **エイリアス管理**: 未知ベンダーはLLMで自動マッピング更新。
*   **マッチング強化**: `日付Window` + `金額完全一致` に加え、`音韻類似度(Phonetic)` と `電話番号` を活用。

#### C. ハイブリッド判定フロー (Hybrid Inference Flow)
1.  **Dispatcher (OCR/Backend)**: 重複排除・正規化・統計データとの照合（スコアリング）。
2.  **Worker (LLM)**:
    *   **高信頼度 (Score 90+)**: AIを通さずOCR/Backendだけで確定（コスト・時間ゼロ）も視野に入れるが、初期はAIを通す。
    *   **通常 (Score < 90)**: 統計データをプロンプトに注入し、AIが最終推論。
3.  **Human Review**: 人間が確定。
4.  **Learning**: 「人間が何を選ばなかったか（修正内容）」を統計DBに反映（Penalize/Reward）。

#### D. 出納帳・口座連携 (Reconciliation Engine)
領収書（借方）だけでなく、通帳・カード明細（貸方）を取り込み、自動突合を行う。
*   **データソース (Input Sources)**:
    *   **CSV (Primary)**: ネットバンキング/カード明細。最も信頼できる正解データ。Backend Parserで統一フォーマットに変換。
    *   **Image (Secondary)**: 通帳のスクショ等。Gemini Flashで構造化データ(JSON)に変換し、合計検算を経て取り込む。
*   **突合ロジック (Matching Logic)**:
    *   **3点マッチング**: `Date` (±45日) + `Amount` (完全一致) + `Vendor` (類似度)。
    *   **自動消込**: マッチしたら貸方を「未払金/預金」で確定し、「証憑あり」フラグを立てる。
*   **証憑なき仕訳の推論 (Auto-Journaling)**:
    *   領収書がない（振込手数料、サブスク等）明細について、「摘要統計エンジン」 を実装する。
    *   **Logic**: `Normalized_Desc` + `Amount_Range` をキーに過去仕訳を検索。
    *   **Result**: 信頼度80%以上で自動提案。

#### E. ストレスフリー重複排除 (Universal Deduplication)
目的: 経営者に「前回どこまで送ったか？」を確認させず、「とりあえず全部送る」運用を許容する。
*   **銀行/カード (Ledger)**:
    *   **行レベル指紋**: `Date` + `Desc` + `Amount` + `Balance` の4要素でユニークキー（指紋）を作成。
    *   **挙動**: 過去の取り込み済みデータと指紋が一致する行は、完全に無視（スキップ）する。
*   **領収書 (Receipts)**:
    *   **Tier 1 (MD5)**: ファイル自体のハッシュ一致 → 即時削除（完全な二重送信）。
    *   **Tier 2 (Semantic)**: [日付+店名+金額] が一致 → 「重複の疑い」警告を表示（同日同額のタクシー代の可能性があるため、勝手に消さない）。

#### F. 拡張照合ルール (Zubora Extended)
*   **A-4: FX Variance (為替ズレ)**:
    *   **Logic**: `IF 差額絶対値 <= AUTO_FEE_LIMIT`.
    *   **Action**: 「支払手数料」 として自動処理。税区分: 親取引を継承 (海外なら対象外)。
*   **A-5: Bundle Payment (合算払い)**:
    *   **Logic**: スマート総当たり。日付 ±BUNDLE_WINDOW_DAYS 内の 未消込領収書 を探索。
    *   **Action**: `Sum(領収書群) == 引落額` なら、Screen E に 「合算マッチ候補」 として提案。
    *   **UI**: 「この8,500円の引落は、これら3枚の合計と一致します。承認しますか？」
*   **A-6: Points Usage (ポイント・値引き)**:
    *   **Logic**: `IF (領収書額 > 引落額)`.
    *   **Action**: 複合仕訳。借方: 経費(全額), 貸方: 預金(実額), 貸方: 値引/ポイント(差額)。
    *   **UI**: 差額を 緑/青の「ポイント利用」 として表示（エラーではない）。


**【決定事項】UI実装の前に「AI/GASロジック設計」を優先する**
> 「ボタンを押したら何が起きるか（ロジック）」が決まっていないのに、UIのボタンは作れない。
> 「UI先走り」による手戻りを防ぐため、まずは**設計図（Implementation Plan）**を完成させる。

## 2. 現在の検討課題 (The Chicken or Egg Problem)
Screen E (仕訳修正画面) のUIを完成させたいが、AIの推論根拠やルール適用ロジックが未定のため、仕様が固まらない。

### A. AIプロンプトとGASの役割分担
*   **現状**: 未整理。GASでOCRするのか、Backendでやるのか曖昧。
*   **あるべき姿 (提案中)**:
    *   **GAS**: 単なる「運び屋」。Gmail/DriveからファイルをBackendに投げるだけ。
    *   **Backend (Vertex AI)**: OCR、意味解釈、複合仕訳の作成、ルール適用すべてを担当。保守性を高めるためロジックを集約する。

### B. 推論ロジックの優先順位
Screen E で「なぜこの仕訳になったか」を表示するバッジや、修正時のルール保存ボタンを作るために、以下の優先順位を定義する必要がある。
*   **Proposed Priority**:
    1.  User Manual Override (その場の修正)
    2.  Individual Company Rule (個別会社ルール)
    3.  Global Rule (全社共通ルール)
    4.  Historical Data (過去の継続取引)
    5.  Pure AI Inference (AI推論)

## 3. 次回の最初のアクション (Next Actions)

次回起動時は、以下の手順で作業を開始せよ。

1.  **コンテキスト読み込み**: 最新の `NEXT_SESSION_BRIEF.md`, `screen_e_ui_spec.md`, `implementation_plan.md` をロード。
2.  **Implementation**: Phase 2 (AI/Data Logic) の実装を開始。特に `types.ts` と `VertexAIStrategy.ts` の刷新を行う。


## 5. ◆実装済み (Implemented)
以下の項目は、プログラムコード (`src/*`) に既に反映されている。

### A. 運用パラメータ (Operational Parameters)
[src/api/config.ts](file:///c:/Users/kazen/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/ai_gogleanti/src/api/config.ts) に実装済み。

*   **ドラフト生成・監視間隔**: 5分 (未処理検知)
*   **Batch API結果確認間隔**: 5分
*   **学習処理間隔**: 60分
*   **最終確認整形間隔**: 5分
*   **知識最適化間隔**: 30日
*   **完了通知時刻**: 9, 12, 15, 18時 (1日4回)
*   **最大処理件数/1回 (Batch Size)**: 20件
*   **Batch API推奨サイズ**: 10~50件 (今回は20件採用)
*   **タイムアウト**: 270秒
*   **最大リトライ回数**: 3回
*   **最適化処理数/1回**: 1
*   **ジョブ履歴保持期間**: 30日

### B. セキュリティ (Security)
[src/router/index.ts](file:///c:/Users/kazen/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/ai_gogleanti/src/router/index.ts) に実装済み。

*   **Admin Settings Protection**:
    *   `/admin-settings` へのアクセスを `admin@sugu-suru.com` のみに制限する Navigation Guard を実装済み。
    *   権限のないユーザーがアクセスしようとすると、警告アラートを表示し、ホームにリダイレクトする。

    *   権限のないユーザーがアクセスしようとすると、警告アラートを表示し、ホームにリダイレクトする。

### C. 業務フローとアーキテクチャの刷新 (Final Hybrid Architecture)
ユーザーとの徹底的な議論の結果、コストと精度のバランスを極限まで高めた**「多次元統計ハイブリッドモデル」**を最終採用とする。

#### 1. アーキテクチャ概要 (Concept)
「AIへ丸投げ (Raw Context)」でも「単純な統計 (Simple Stats)」でもなく、**「GASで高度に構造化したコンテキストを、AIが最終判断する」** 構成とする。

| 層 (Layer) | 担当機能 | 具体的な処理内容 |
| :--- | :--- | :--- |
| **L1: GAS Pre-processing** | **構造化・圧縮** | **多次元ハッシュマップ生成**: `Normalized_Vendor` + `Amount_Range` + `Payment_Method` をキーに相関ルールを抽出。<br>**時間減衰 (Time Decay)**: 「直近の正解」を重み付けし、古いルールを自然淘汰させる。<br>**正規化**: エイリアス辞書 (`V_ALIAS_MAP`) を用いて名寄せを行う。 |
| **L2: Context Caching** | **知識保持** | GASが生成した「高密度な統計ルール（ヒント）」と「直近の生データ（参照用）」をハイブリッドでキャッシュする。Rawデータのみの場合に比べ、トークン量を大幅に節約しつつ文脈を維持する。 |
| **L3: AI Reasoning** | **推論・補正** | GASの統計結果（信頼度80%など）を入力として受け取るが、**最終判断はAI**が行う。<br>例:「統計では備品だが、画像がお茶なので今回は会議費に補正する（RAGアプローチ）」。 |
| **L4: Feedback Loop** | **自己修正** | 人間が修正した結果（負の学習）をフィードバックし、特定のキー（Amazon×消耗品）のスコアを減点方式で即座に矯正する。 |

#### 2. 採用する技術要素 (Technical Components)
1.  **多次元キー (Multidimensional Key)**:
    *   単なる「Amazon=消耗品」ではなく、**「Amazon × 10万以上 × カード = 備品」** という条件分岐構造を物理的にDB化する。
    *   **Value構造**: 単一科目ではなく `{ "debit": [...], "credit": [...] }` の **JSON Template** を保存し、複合仕訳や貸借構造を完全再現する。
    *   **金額レンジ (Tax Thresholds)**: 以下の法定義務に基づき、定数として厳格に区分けする。
        1.  **¥10,000 (飲食費/インボイス)**: 交際費vs会議費 / インボイス少額特例 / 少額返還免除
        2.  **¥50,000 (印紙税)**: 領収書の印紙要否
        3.  **¥100,000 (資産)**: 消耗品費 vs 一括償却資産
        4.  **¥200,000 (資産)**: 一括償却 vs 少額減価償却資産
        5.  **0 (資産)**: 固定資産 (原則)
2.  **エイリアス管理 (Alias Management)**:
    *   `Amazon.co.jp`, `アマゾン` 等の揺らぎを吸収するマッピングテーブル。
    *   解決策: 未知のベンダー名はLLMに「既存のどれと同じか？」を判定させ、自動でマッピングを更新する。
3.  **マッチング強化 (Enhanced Matching)**:
    *   **「日付Window」+「金額一致」** を基本とする。
    *   **音韻類似度 (Phonetic)**: カタカナ変換後の類似度判定 (Seven-Eleven vs ｾﾌﾞﾝｲﾚﾌﾞﾝ)。
    *   **電話番号 (Tel)**: 領収書の電話番号を最強のユニークキーとして活用する。
4.  **ハイブリッド判定 (Hybrid Inference Flow)**:
    *   **Step 1 (Statistics)**: 多次元ハッシュを検索。
        *   Hit (n>1): 「社内ルール」としてテンプレートを提示。信頼度スコアを付与。
        *   Miss (n=1/0): 「判断不能 (None)」を返す。
    *   **Step 2 (LLM Fallback)**:
        *   Statsあり: そのテンプレートを正解候補としつつ、画像事実との矛盾がないか確認。
        *   Statsなし: **「一般常識」** で推論。「Adobeはソフト代」等の世間の常識を適用し、人間に提案。確定後に「n=1」として学習開始。

#### 3. 確定ワークフロー (Operational Flow)
1.  **Dispatcher (GAS)**: 重複排除・正規化・統計データとの照合（スコアリング）。
2.  **Worker (AI)**:
    *   **高信頼度 (Score 90+)**: AIを通さずGASだけで確定（コスト・時間ゼロ）も視野に入れるが、初期はAIを通す。
    *   **通常 (Score < 90)**: 統計データをプロンプトに注入し、AIが最終推論。
3.  **Human Review**: 人間が確定。
4.  **Learning**: 「人間が何を選ばなかったか（修正内容）」をGASの統計DBに反映（Penalize/Reward）。

#### 4. 出納帳・口座連携 (Reconciliation Engine)
領収書（借方）だけでなく、通帳・カード明細（貸方）を取り込み、自動突合を行う。

1.  **データソース (Input Sources)**:
    *   **CSV (Primary)**: ネットバンキング/カード明細。最も信頼できる正解データ。GASパーサーで統一フォーマットに変換。
    *   **Image (Secondary)**: 通帳のスクショ等。Gemini 1.5 Flashで構造化データ(JSON)に変換し、合計検算を経て取り込む。
2.  **突合ロジック (Matching Logic)**:
    *   **3点マッチング**: `Date (±45日)` + `Amount (完全一致)` + `Vendor (類似度)`。
    *   **自動消込**: マッチしたら貸方を「未払金/預金」で確定し、「証憑あり」フラグを立てる。
3.  **証憑なき仕訳の推論 (Auto-Journaling)**:
    *   領収書がない（振込手数料、サブスク等）明細について、**「摘要統計エンジン」** を実装する。
    *   **Logic**: `Normalized_Desc` + `Amount_Range` をキーに過去仕訳を検索。
    *   **Code**: `Logic_BankRules.gs` にて実装。信頼度80%以上で自動提案。
4.  **ストレスフリー重複排除 (Universal Deduplication)**:
    *   **目的**: 経営者に「前回どこまで送ったか？」を確認させず、「とりあえず全部送る」運用を許容する。
    *   **銀行/カード (Ledger)**:
        *   **行レベル指紋**: [Date](file:///c:/Users/kazen/OneDrive/%E3%83%87%E3%82%B9%E3%82%AF%E3%83%88%E3%83%83%E3%83%97/ai_gogleanti/src/api/lib/ai/strategy/ZuboraLogic.ts#156-160) + `Desc` + `Amount` + `Balance` の4要素でユニークキー（指紋）を作成。
        *   **挙動**: 過去の取り込み済みデータと指紋が一致する行は、完全に無視（スキップ）する。重複アップロードを歓迎する仕様。
    *   **領収書 (Receipts)**:
        *   **Tier 1 (MD5)**: ファイル自体のハッシュ一致 → **即時削除**（完全な二重送信）。
        *   **Tier 2 (Semantic)**: [日付+店名+金額] が一致 → **「重複の疑い」警告**を表示（同日同額のタクシー代の可能性があるため、勝手に消さない）。

#### 5. 会計基準と特殊仕訳 (Accounting Standards & Edge Cases)
「AIは発生主義で仕訳を切る」を原則としつつ、実務的な「期中現金主義」に対応する。

1.  **記帳方式 (Accounting Method)**:
    *   **期中現金主義 (Interim Cash Basis)**: 
        *   **期中 (Apr-Feb)**: 通帳/カード引き落とし時点で「費用」計上。請求書画像は「未処理」として保存のみ。
        *   **期末 (Mar)**: 未払いの請求書画像をAIが解析し、決算整理仕訳 `[借] 費用 / [貸] 未払金` を自動生成。
    *   **発生主義 (Accrual)**: 全て `[借] 費用 / [貸] 未払金` で計上し、通帳で `[借] 未払金 / [貸] 預金` を消し込む（理想形）。
    *   **切替**: 顧問先ごとの設定スイッチ (`client.settings.method`) で制御。

2.  **Screen C: 9つのバケツ (The 9 Reconciliation Buckets)**:
    すべてのデータを以下の9カテゴリに分類し、月次決算を完了させる。
    | No. | リスト名 | 定義・アクション |
    |:--- |:--- |:--- |
    | **1** | **✅ 消込完了 (Matched)** | 証憑と明細が一致。自動仕訳 `[借]費用/[貸]預金` 生成。 |
    | **2** | **🧾 未払・未決済 (Unpaid)** | 請求書あり・引落なし。期末に未払計上。 |
    | **3** | **🔄 資金移動 (Funds)** | 預金間移動・クレカ引落・現金引出。P/L除外 `[借]預金/[貸]預金`。 |
    | **4** | **👥 給与・税金 (B/S Items)** | 給与(額面/預り金)、借入返済(元本/利息)、租税公課。**台帳取込**へ誘導。 |
    | **5** | **⏳ 資産・前払 (Deferrals)** | 30万超の固定資産、年払いの前払費用(期間按分)。 |
    | **6** | **🏛️ 源泉徴収 (Withholding)** | 報酬・原稿料。支払調書/納付書作成用データとして集計。 |
    | **7** | **🏠 家事按分 (Allocations)** | 新規取引先の公私混同チェック。按分マスタへの登録。 |
    | **8** | **❓ 使途不明 (Unknown)** | 証憑なし出金、不明入金（仮受）。社長へのチャット質問対象。 |
    | **9** | **⚠️ エラー (Errors)** | 重複疑義、インボイス番号なし(非適格)、OCR不能。 |

3.  **実務特化ロジック (Real-World Practical Logic)**:
    *   **給与 (Payroll)**: 台帳取込は**廃止**。通帳出金＝手取り給与として `[借]給料/[貸]預金` で直計上（年末調整で一括補正）。
    *   **前払費用 (Prepaid)**: 1年以内の期間対応費用（年払い等）は、**「短期前払費用の特例」**を適用し、即時全額費用計上する（按分しない）。
    *   **現金払 (Cash)**: 領収書(現金)の貸方は原則 **「役員借入金」** とする（金庫マイナス回避）。
    *   **自動調整 (Auto-Adjust)**: レシートと明細の差額が少額(1,000円以下)の場合、**「雑収入/雑損失」**で自動埋め合わせし、消込完了とする。
    *   **ETC/駐車場**: カード明細の「ETC」は無条件で**インボイス適格**とみなす。少額駐車場はレシートなしでも経費承認。
    *   **インボイス足切り (Audit Threshold)**: **3万円未満**（設定可）の領収書は、T番号の有無を問わず**「適格(100%控除)」**として自動処理する（実務的無視ライン）。厳密チェックは3万円以上のみ実施。
    *   **消費税 (Force Balance)**: 税計算の1円ズレは無視。合計金額から逆算した税額を正とし、強制的に貸借を合わせる（エラー撲滅）。
    *   **在庫 (Periodic Inventory)**: 期中の仕入はすべて**「仕入高(費用)」**で処理（資産計上しない）。期末のみ「期末商品棚卸高」で一括調整する。
    *   **外貨 (Ignore FX)**: レシートのドル表記($10.00)は無視。カード明細の**「日本円引落額」**を正解とし、為替差損益は計上しない。
    *   **少額不明金 (Auto-Resolve)**: 1,000円未満の不明入出金は、社長に質問せず**「雑収入/雑損失」**で自動処理する。

4.  **安全装置 (Safety Nets - The "Undo" Button)**:
    「勝手に消す」恐怖を回避するため、以下の安全策を強制実装する。
    *   **ゴミ箱機能 (Soft Delete)**: 「重複」や「期間外」と判定されたファイルは、絶対に削除せず**専用フォルダ(`_TRASH/YYYYMM`)**へ移動するだけにする。
    *   **AI監査タグ (Audit Tags)**: 自動調整した仕訳には必ずタグ(`AUTO_TAX_FIX`, `AUTO_IGNORE_INVOICE`)を付与する。
    *   **事後確認モード**: Screen C に「これ、AIが勝手に処理しましたリスト」を表示し、ワンクリックで**「元に戻す(Undo)」**機能を実装する。
    *   **慎重スイッチ**: これらの自動化機能は `ADMIN_CONFIG` で個別に ON/OFF 可能にする（デフォルトはON）。

5.  **学習・可視化機能 (Adaptive Learning & Visualization)**:
    *   **AIアシスト判定 (Human-in-the-Loop)**: 「完全自動化」ではなく「人間への提案」を基本とする。
        *   **過去ルール一致**: 「過去に強制一致させています。同様に処理しますか？」と警告表示 → **[強制一致]ボタン**で Screen E に摘要反映。
        *   **ルール不一致**: 「未知のズレです。顧問先に確認しますか？」と警告表示 → **[質問リストへ追加]ボタン**で保留。
        *   **既読マスキング (Visual Masking)**:
        *   過去に取り込み済みの明細行や、重複画像は、Screen C 上で**「グレーアウト（半透明）」**表示する。
        *   「どこまで送ったか」を人間が視覚的に判断できるようにし、AIの「勝手な無視」への不安を払拭する。

6.  **業務フローとアーキテクチャの刷新 (Final Hybrid Architecture)**:
    コストと精度のバランス極めるため、**「多次元統計ハイブリッドモデル」**を最終採用する。
    
    *   **アーキテクチャ概要 (Concept)**:
        *   **L1: GAS Pre-processing**: 構造化・圧縮。`Normalized_Vendor` + `Amount_Range` + `Payment_Method` をキーに相関ルール抽出。エイリアス辞書で名寄せ。
        *   **L2: Context Caching**: 知識保持。GAS生成の高密度ルール（ヒント）と直近生データをハイブリッドでキャッシュ。
        *   **L3: AI Reasoning**: 推論・補正。統計信頼度を入力とするが、最終判断はAI（例：画像事実に基づく補正）。
        *   **L4: Feedback Loop**: 自己修正。人間の修正を即座に減点方式でフィードバック。
    
    *   **技術要素 (Technical Components)**:
        *   **多次元キー**: `Vendor × Amount × Method` の条件分岐を物理DB化。
        *   **Value構造**: 単一科目ではなく JSON Template `{"debit": [...], "credit": [...]}` を保存。
        *   **金額レンジ**: `1万(交際費)`, `5万(印紙)`, `10万(消耗品)`, `20万(少額資産)` で厳格区分。
        *   **エイリアス管理**: 未知ベンダーはLLMで自動マッピング更新。
        *   **マッチング強化**: 日付Window + 金額完全一致に加え、音韻類似度(Phonetic)と電話番号を活用。
    
    *   **ハイブリッド判定フロー**:
        1.  **Stats**: ヒットあり(n>1)なら社内ルール提示。
        2.  **LLM Fallback**: Statsなしなら「一般常識」推論。人間確定後に学習開始。

### D. 採用AIモデル (Selected AI Models)
ユーザー指示により、以下の最新「Gemini 3シリーズ」3種を適材適所で組み合わせて実装する。

*   **Gemini 3 Flash**:
    *   **役割**: 高速処理、一次仕訳、コスト削減。
*   **Gemini 3 Pro**:
    *   **役割**: 論理的整合性、ルール適用。
    *   **用途**: 全社ルールの適用確認、インボイス整合性チェック。
*   **Gemini 3 Thinking (DeepThink)**:
    *   **Pro**: ルール適用、会計チェック。
    *   **Thinking**: 複雑な仕訳推論、例外処理。

### G. コンテキストと決定の経緯 (Context & Decision History)
*次回セッションの担当AIへ：このセクションは、これまでの議論の「文脈（なぜそうなったか）」を理解するために必読である。*

1.  **「教科書」からの脱却**:
    *   当初は「発生主義」「厳密な消込」を提案したが、ユーザーより「現場が回らない」との指摘を受け、**「実務的ズボラ運用 (Pragmatic Operation)」** へ方針を大転換した。
    *   **重要**: 実装時は「会計的な正しさ」よりも「ユーザーの手間削減」を常に優先せよ。

2.  **安全性への懸念と対策**:
    *   ズボラ機能（自動消込・重複排除）に対し、ユーザーは「勝手に消される恐怖」を強く懸念した。
    *   これに対し、**「Soft Delete」「Audit Tags」「Human-in-the-Loop (提案型UI)」** を導入することで合意した。
    *   **重要**: ユーザーが「クリックするまで確定しない」安心感をUIで表現せよ。

3.  **インボイスと消費税の現実**:
    *   「3万円未満は適格とみなす」「1円の税額ズレは無視する」。これらはユーザーの強い要望により決定した**「法的リスクを許容した上での運用ルール」**である。
    *   **重要**: AIが勝手に「税計算が合わない」と騒いではならない。

4.  **最終ゴール**:
    *   このシステムは「完璧な帳簿」を作ることではなく、**「経営者がストレスなく月次を締めること」**を目的とする。

5.  **開発プロセスの教訓 (Development History - The "Stop Work" Pivot)**:
    *   **UI先行の失敗と修正**: 当初「Screen Eのボタン設置」等、UI修正を急ごうとしたが、ユーザーより**「ロジック（GAS/AIの役割）が固まっていないのにボタンは作れない」**と強く戒められた経緯がある。
    *   **決定事項**: 「なんとなくUIで作る」ことを厳禁とする。まず **「全社ルール vs 個別ルール vs AI推論」** の重み付けロジックを確立し、それをUIに投影する順序を厳守せよ。
    *   **ルール優先順位**: 
        1. **新ルール (New Rules)**: 人間が直近で修正した内容（最優先）。
        2. **継続取引 (Recurring)**: 毎月の定額取引。
        3. **全社ルール (Global Rules)**: インボイス等の法的要件。
        4. **AI推論 (Inference)**: 最終手段。

---
---

---

### H. UI/UX定義: Screen E (オペレーションセンター)
デザイン哲学: 画像オーバーレイによる 「能動的選択 (Active Choice)」。 「なんとなく承認」を排除する。画像側でシンプルな選択（意思表示）を行わせ、それを仕訳側に反映させるフローを強制する。

#### 1. レイアウトとゾーン
*   **左側 (画像オーバーレイ)**: 意思決定ゾーン。
    *   **Popup**: 領収書の上に浮かぶグラスモーフィズムカード。
    *   **コンテンツ**: [事実] -> [論理] -> [懸念] -> [視点(ズボラvs教科書)] -> [提案]。
    *   **メインアクション (最大3つ)**: 「推奨」「対案」「現状維持」。
    *   **サブアクション (フッター)**: 「顧客に質問」「資料請求」「後回し」「除外」。
*   **右側 (仕訳エリア)**: 結果ゾーン。
    *   ポップアップでの選択結果を自動反映。
    *   詳細編集（行分割、金額修正）が可能。
*   **フッター**: 最終コミット。
    *   大きな「承認」ボタン。

#### 2. 人間のアクション (絶対的リスト)
| 分類 | アクション | 挙動 |
| :--- | :--- | :--- |
| **ルール** | **記憶 (Memorize)** | 「Vendor X は常に Account Y (固定)」。 |
| **ルール** | **上書き (Overwrite)** | 「新ルール: 古いのは忘れて、今後は Z を使う」。 |
| **ルール** | **除外 (Exclude)** | 「例外: このレシートは特殊なので学習させない」。 (NEW) |
| **タスク** | **質問 (Ask Client)** | 「チャット/メールで問い合わせる」。 (Pending) |
| **タスク** | **資料請求 (Request)** | 「契約書/請求書が必要」。 (Pending) |
| **タスク** | **後回し (Later)** | 「今はスキップし、受信トレイに残す」。 (NEW) |
| **タスク** | **破棄 (Trash)** | 「これは経費ではない (削除)」。 |
| **フロー** | **承認 (Approve)** | 元帳へコミット & 学習ループ起動。 |

#### 3. 提示プロトコル (ポップアップ構造)
*   **構造**:
    *   **ヘッダー**: `[事実] 状況` + `[論理] 理由`
    *   **ボディ**: `[懸念] リスク` + `[視点] ズボラ vs 教科書`
    *   **提案**: `[選択肢] 推奨アクション`
*   **例 (分類判断)**:
    > **[事実]** 金額 5,400円 (5,000円基準超過)。
    > **[論理]** 会議費には人数が必要。ないと税務否認リスクあり。
    > **[視点]** 教科書なら「交際費」。ズボラなら「人数書いて会議費」。
    >
    > **[選択肢A]** 会議費にする (人数入力) - *ズボラ案*
    > **[選択肢B]** 交際費にする (推奨) - *教科書案*
    > **[選択肢C]** 今回のみこのまま - *ルールなし*

---
**End of Phase 2 Logic Design**
*Proceed to Implementation Phase: `src/api/lib/ai/strategy/`*

---

# APPENDIX A: Screen E UI Specification (Full Text)

# Screen E: UI/UX & 挙動仕様書
ver 1.0

## 1. デザインコンセプト
**"能動的選択インターフェース (Active Choice Interface)"**
AIは複雑な仕訳を勝手に確定させません。代わりに **「画像上のポップアップ」** を通じて透明性のある意思決定プロセスを提示し、ユーザーのシンプルな選択操作によって仕訳を作成します。

![UI Concept](file:///C:/Users/kazen/.gemini/antigravity/brain/69339ee8-ec83-4cfb-8b61-3f40ac80588a/screen_e_popup_concept_1767803386977.png)

---

## 2. 画面レイアウトとゾーン定義

画面は左右50%ずつの2カラム構成です。

### ゾーンA: 画像オーバーレイ (左側)
*   **役割**: **意思決定 (Decision Making)** - AIの推論エンジン
*   **コンポーネント**: `<ImageOverlayPopup />`
*   **振る舞い**:
    *   領収書画像の上にフローティング表示される。
    *   **決定プロトコル** (事実・論理・提案) を表示する。
    *   **ルール生成** や **タスク振り分け** を担当する。

### ゾーンB: 仕訳エリア (右側)
*   **役割**: **実行・編集 (Execution & Editing)** - 会計エンジン
*   **コンポーネント**: `<JournalEditorForm />`
*   **振る舞い**:
    *   ゾーンAでの選択結果を即座に反映する。
    *   詳細な編集（税区分、正確な金額修正）を行う。
    *   **複合仕訳 (行分割)** を処理する。
    *   フッターに **最終承認ボタン** を持つ。

---

## 3. ポップアップ提示プロトコル (ゾーンA)

認知負荷を下げるため、全てのポップアップは以下の厳格なナラティブ構造に従います。

### 構造
1.  **ヘッダー (状況)**:
    *   アイコン (⚠️/✅/🤖) + 短いタイトル。
    *   `[事実]`: 議論の余地のないデータ (OCR金額、日付、店名)。
2.  **ボディ (論理・推論)**:
    *   `[論理]`: なぜAIが迷っているか、または自信があるか。
    *   `[懸念]`: 間違った場合に起きるリスク (税務否認など)。
    *   `[視点]`: **ズボラ視点** (効率) vs **教科書視点** (厳格)。
3.  **選択肢 (提案)**:
    *   最大3つのプライマリアクションボタン。
    *   推奨度/安全性の高い順に配置。

### ケーススタディ

#### ケース1: 分類矛盾 (例: セブンイレブンで5,400円)
*   **ヘッダー**: ⚠️ **5,000円基準超過** (事実: Amount > 5000)
*   **ボディ**:
    *   「飲食代ですが、会議費の上限を超えています。」
    *   「参加人数がないと、交際費（損金不算入）になるリスクがあります。」
    *   **教科書**: 交際費として処理すべき。
    *   **ズボラ**: 人数を追記して会議費にする。
*   **ボタン**:
    *   `[A] 会議費にする (人数入力)` (青/ズボラ) -> *ゾーンBの「人数欄」にフォーカス*
    *   `[B] 交際費にする` (緑/教科書) -> *ゾーンBに「交際費」をセット*
    *   `[C] 今回のみこのまま` (グレー) -> *現在の入力値を採用*

#### ケース2: 履歴一致 (History Match)
*   **ヘッダー**: 🟢 **履歴一致** (事実: 過去3回の実績)
*   **ボディ**:
    *   「過去3回、Amazonを『新聞図書費』として効率的に処理しています。」
    *   「リスク: 今回が備品（ペン等）でなければ問題ありません。」
*   **ボタン**:
    *   `[A] 新聞図書費 (推奨)` (青/履歴)
    *   `[B] 消耗品費` (緑/対案)

---

## 4. アクション一覧と配置場所

ユーザーの全行動の「住所」を定義します。

| アクション分類 | アクション名 | 配置場所 | 挙動 |
| :--- | :--- | :--- | :--- |
| **一次選択** | **AI提案の選択** | Popup ボディ | 選択内容をゾーンBに反映する。 |
| **ルール管理** | **記憶 (Memorize)** | Popup "オプション" | チェックボックス:「今後、[Vendor]は常にこの科目にする」。 |
| **ルール管理** | **自然言語定義** | Popup "ルール"ボタン | テキスト入力:「10万円以下なら消耗品にして」。 |
| **ルール管理** | **除外 (Exclude)** | Popup 上部メニュー | 「この領収書は特殊なので学習させない」。 |
| **例外処理** | **複合仕訳 (Split)** | Popup "詳細" | ゾーンBを「複数行モード」に切り替える。 |
| **タスク化** | **顧問先に確認** | Popup フッター | 「保留 - 質問」リストへ移動。 |
| **タスク化** | **資料請求** | Popup フッター | 「保留 - 資料」リストへ移動。 |
| **タスク化** | **あとで検討** | Popup フッター | 「受信トレイ - 後回し」リストへ移動。 |
| **破棄** | **削除 (Trash)** | Popup 右上 | ゴミ箱へ移動。 |
| **最終化** | **承認 (Approve)** | ゾーンB フッター | 総勘定元帳へコミット & 学習ループ起動。 |

---

## 5. 高度なインタラクション

### 自然言語によるルール生成
*   **トリガー**: Popup内の「ルール定義」をクリック。
*   **UI**: Popup内にテキスト入力欄が出現。
*   **ユーザー入力**: 「金額が1,000円以下なら雑収入にして」
*   **システム動作**:
    1.  LLMがロジックに変換: `IF Amount <= 1000 THEN Account = 'Misc Income'`.
    2.  `IndividualRule` DBに保存。
    3.  現在のゾーンBの入力を即座に更新。

### 複合仕訳 (Focus Mode)
*   **トリガー**: Popupが「給与」や「合算払い」を検知。
*   **Popup表示**: 「給与支給の可能性があります。詳細な内訳入力が必要です。」
*   **アクション**: 「内訳を入力する」をクリック。
*   **結果**:
    1.  Popupが縮小/退避する。
    2.  **ゾーンB** が複数行エディタに切り替わりハイライトされる。
    3.  ユーザーがゾーンBで貸方/借方行を編集する。

---

## 6. 「ルール」と「傾向」の定義

*   **全社ルール (A)**: 固定の「憲法」（税法、ズボラ初期設定など）。 *UI表示: 「全社標準」*
*   **個別ルール (B)**: 決定的なユーザー上書き (`Vendor` + `Condition` = `Account`)。 *UI表示: 「履歴/ルール」*
*   **傾向/推論 (C)**: 確率的な雰囲気 (LLMの推測)。 *UI表示: 「AI推論」*

この仕様書をもって、実装の「正解」とします。

---

# APPENDIX B: Implementation Plan (Full Text)

# AI経理システム 実装計画書 (Implementation Plan)

## Phase 1: フロントエンド基盤構築 & 基本構造 (完了)
- [x] **プロジェクトセットアップ**: リポジトリ作成, 環境変数設定, Cloud Run構成。
- [x] **UI実装 (Screen A - H)**:
    - [x] Screen A: 顧客一覧 (モックデータ)
    - [x] Screen B: 仕訳ステータス (カンバンボード)
    - [x] Screen C: 照合 (UI骨子)
    - [x] Screen E: 仕訳エディタ (インタラクティブ動作)
- [x] **デプロイ**: Cloud Run + Firebase Hosting (検証済)。

## Phase 2: AIロジック & バックエンド (次回セッション)
**目標**: 「ハイブリッド・アーキテクチャ」と「照合エンジン」を高精度で実装する。

### Step 0: 詳細設計 & ロジック監査 (完了)
- [x] **技術詳細定義**: `src/api/lib/ai/strategy/ZuboraLogic.ts` および `NEXT_SESSION_BRIEF.md` にて定義済。
    - [x] L1 GAS層のための ハッシュマップ関数。
    - [x] 重複排除フィンガープリント アルゴリズム。
    - [x] 論理削除 用ディレクトリ構造。
    - [x] ズボラルール 判定ロジック (A-1...A-6, B-1...B-6)。
- [x] **スキーマ確定**: 9つのバケツ要件を設計に統合。

### Step 1: コアロジック実装 (GAS/Typescript)
- [ ] **照合エンジン (`src/api/lib/reconciliation/`)**:
    - [ ] 9つのバケツ 振り分けロジックの実装。
    - [ ] 3点照合 (日付/金額/店名) の実装。
    - [ ] 少額差異 (<1000円) の 自動解決 実装。
- [ ] **会計ルールエンジン (`src/api/lib/accounting/`)**:
    - [ ] 給与ロジック (手取り方式) の実装。
    - [ ] 前払特例 (短期前払) の実装。
    - [ ] 現金処理 (役員立替) の実装。
    - [ ] インボイス特例 (3万円未満などの少額特例) の実装。
- [ ] **安全装置レイヤー**:
    - [ ] 論理削除 ユーティリティの実装。
    - [ ] 監査タグ付け デコレータの実装。

### Step 2: AI戦略 & ハイブリッド脳
- [ ] **Gemini統合**:
    - [ ] `VertexAIStrategy.ts` を階層型モデル (Flash/Pro/Thinking) にリファクタリング。
    - [ ] 「ハイブリッド・コンテキスト注入」用のプロンプトテンプレート実装。
- [ ] **適応学習**:
    - [ ] 過去の「ズボラパターン」を照会する `HistoryService` の作成。
    - [ ] Screen E における「Human-in-the-Loop」UIトリガーの実装。

### Step 3: フロントエンド統合
- [ ] **Screen C (照合)**:
    - [ ] バックエンドAPIと接続し、9バケツデータを表示。
    - [ ] 「元に戻す(Undo)」/「強制突合(Force Match)」UIの実装。
- [ ] **Screen E (仕訳エディタ)**:
    - [ ] 「適応型アラート」ポップアップ (アシストモード) の追加。
    - [ ] 処理済み行の「グレーアウト」実装。

## Phase 3: テスト & 最適化
- [ ] **結合テスト**: 「CSVアップロード」から「仕訳作成」までの一連フロー検証。
- [ ] **負荷テスト**: 大量の重複データセットを用いたバッチ処理検証。
- [ ] **UX改善**: レスポンシブ確認とアニメーション調整。

---

# APPENDIX C: Design Discussion Logs (Full Text)

# 詳細設計・ロジック定義ディスカッション

本ドキュメントでは、Phase 2 実装着手前に確定すべき「業務ロジックの曖昧点」をカテゴリー別に整理し、弊社の推奨案（Proposal）を提示します。これらについて合意形成を行い、仕様をFixします。

---

## カテゴリーA：照合エンジン (Reconciliation Engine)

銀行口座・クレカ明細（正）と、領収書（証拠）を突き合わせる際の判定ロジックです。

### 論点A-3：照合AIの「説明プロトコル」の統一

**【方針】**
AIの回答は単なる結果報告ではなく、**「事実 → 推論ロジック → 懸念点 → 対案提示」** の4段構成で統一します。

**テンプレート:**
`[状況] {差異の事実}。 [論理] {AIの判断根拠}。 [懸念] {リスクの提示}。 [提案] {次のアクション}？`

#### 実装例ケーススタディ

**ケース1: 差額 770円 (範囲内)**
> "口座引落額と領収書に **770円の差額** があります。
> 1,000円未満かつ他に近い取引がないため、**「振込手数料」** と判断して仕訳候補を作成しました。
> ※もし手数料でない場合は、差額の理由を確認する必要があります。
> **このまま登録してよろしいですか？**"

**ケース2: 差額 10,000円 (範囲外)**
> "口座引落額と領収書に **10,000円の差額** があります。
> 手数料としては金額が大きすぎるため、**自動処理を停止** しました。
> 「一部入金」や「相殺」、あるいは「別の領収書」である可能性があります。
> **確認タスクに追加しますか？**"

**ケース3: 日付ズレ・重複 (サブスク重複など)**
> "期間内に **同額・同店名の領収書が2件** (1/1分 と 2/1分) 見つかりました。
> 日付ウィンドウ(45日)の中で候補が特定できず、誤って紐付けると翌月分も狂うリスクがあります。
> **どちらが今回の明細に対応するか、手動で指定してください。**"

---

## カテゴリーB：ズボラ経理ルール (Zubora Logic)

実務を優先し、簿記の原則を曲げてでも効率化する「特例ルール」の定義です。

### カテゴリーB：ズボラ経理ルール (Zubora Logic) 詳細定義

**方針**: 「完璧な帳簿」より「社長の手間ゼロ」を優先する。

#### B-1. 役員立替 (Director's Loan)
*   **課題**: 現金で払った領収書を「現金」勘定で処理すると、金庫残高がマイナスになり、決算で「現金過不足」の修正が必要になる。
*   **Logic**:
    *   **IF** `PaymentMethod == 'Cash'` (領収書・レシート)
    *   **THEN** `CreditAccount = '役員借入金'` (Director's Loan)
    *   **理由**: 「社長のポケットマネーで立て替えた」ことにすれば、金庫管理が不要になる。

#### B-2. 少額差異の自動調整 (Small Diff Auto-fill)
*   **課題**: 1円〜数百円のズレで「不明」として社長に質問が行くのはストレス。
*   **Logic**:
*   **Logic**:
    *   **IF** `Diff <= 1,000 JPY` AND `Reason == Unknown`
    *   **THEN**:
        *   `Diff > 0` (入金多): `Credit = '雑収入'`
        *   `Diff < 0` (出金多): `Debit = '雑損失'`
    *   **Alert**: なし (Silent Fix)。ただし `AUTO_RESOLVE` タグを付ける。

#### B-3. 給与 (Payroll - Net Basis)
*   **課題**: 給与台帳を取り込んで、額面・社保・税金を仕訳するのは作業コストが高すぎる。
*   **Logic**:
    *   **IF** `Desc` contains "給与" OR "賞与"
    *   **THEN**:
        *   `Debit = '給料手当'`
        *   `Amount = WithdrawalAmount` (手取り額！)
        *   `TaxClass = '対象外'`
    *   **運用**: 源泉税などの調整は、年末調整時に税理士が「年次仕訳」で一括調整する。毎月は手取りだけで良い。

#### B-4. 短期前払特例 (Short-term Prepaid)
*   **課題**: サーバー代(年払)などを「前払費用」にして毎月崩すのは面倒。
*   **Logic**:
    *   **IF** `PaymentCycle == 'Yearly'` AND `ServicePeriod <= 1 Year`
    *   **THEN** `Debit = '通信費' (Expense)` (全額費用計上)
    *   **理由**: 税法上の「短期前払費用の特例」を適用し、資産計上を回避する。

#### B-5. 消費税1円調整 (Force Tax Balance)
*   **課題**: 税込金額から税額を割り戻すと、1円の端数ズレが出ることがある。
*   **Logic**:
    *   **IF** `CalculatedTax != ReceiptTax` (Diff == 1 JPY)
    *   **THEN** `TaxAmount = Corrected to match Receipt` (強制合わせ)
    *   **優先**: 常に「支払総額」を正とし、税額側を調整する。

#### B-6. ETC・駐車場 (Auto Invoice)
*   **課題**: 高速代やコインパーキングの適格請求書(T番号)をいちいち確認するのは非現実的。
*   **Logic**:
    *   **IF** `Vendor` in ['ETC', 'タイムズ', '三井のリパーク'] AND `Amount <= 3,000`
    *   **THEN** `InvoiceStatus = 'Qualified'` (適格扱い)
    *   **理由**: 少額特例、または回収コストに見合わないため「適格」とみなして処理する。

---
以上、カテゴリーBの全ルールです。
「これはやりすぎ（NG）」または「もっとこうしたい」という箇所はありますか？

---

## カテゴリーC：Human-in-the-Loop (対話・確認)

AIが「自信がない」ときに、ユーザーにどう尋ねるかのUI/UX定義です。

### 論点C-1：問いかけの深さ

**【課題】**
単に「要確認」フラグを立てるだけでは、人間は何を見ればいいかわからず、結局「最初から全部見る」のと変わらない手間になる。

**【推奨案 (Proposal)】**
AIは必ず **「仮説」** と **「迷いの理由」** をセットで提示します。

**UIイメージ（Assist Mode Pop-up）:**

> ⚠️ **確認してください**
>
> この領収書（セブンイレブン 5,400円）について、
> **「会議費」** として処理しようとしましたが、
> 過去の履歴では **「交際費」** とされていることが多いです。
>
> **どうしますか？**
> *   [ ] 会議費でOK (今回だけ)
> *   [ ] 交際費に変更する (推奨)
> *   [ ] ルールとして記憶させる (今後も交際費)

*   **ポイント**: 「わかりません」ではなく「Aだと思いますが、Bの可能性もあります」と聞くことで、人間は「選択」するだけで済むようにする。

---

### ⚠️ 議論のピボット (Strategic Pivot)
**「ズボラルール」の前に「学習メカニズム」を定義する**

*   **発見**: 「全社ルール」ばかり議論していたが、「ユーザーがScreen Eで修正した結果」がどうシステムにフィードバックされるか（学習ループ）が未定義だった。
*   **決定**:
    *   ズボラルール（カテゴリーB）の確定は一旦保留する。
    *   次回の最優先事項は **「カテゴリーC: Human-in-the-Loop & Learning」** の設計とする。
    *   **論点**: 「一度承認したら、次回からAIはそれを『鉄の掟』として自動適用していいのか？」（ルール昇格の条件）。

---
以上で本セッションの議論を終了し、この結論を `NEXT_SESSION_BRIEF.md` に引き継ぎます。


## 7. 新たな決定事項 (New Decisions)
*   **日付**: 2026/01/09
*   **決定**: **9つのバケツ (Defined Schemas)** は、UI画面 (Screen C) としては実装しない。
*   **理由**: ModelとViewの分離。Screen E等で内部ロジック（ステータス定義）として活用する方が、実装工数を抑えつつAIの賢さ（フィルタリングやアラート）を最大化できるため。
*   **方針**:
    *   **UI Status**: `Screen C` implementation is **CANCELLED**.
    *   **Logic Status**: `9 Buckets Logic` is **APPROVED** for Backend/Filtering usage.


## 8. Screen E UIコンポーネント: ボタン一覧 (Detailed Button Definition)

#### UIの整備対象ファイルと整備方針

**触ってよいファイル (✅ Allowed)**

*   **implementation_plan.md**
    *   **理由**: 「いつ・何を・どう実装するか」の地図であり、今回の議論で確定した「型定義の追加」や「UIコンポーネントの実装順序」を、次回以降の作業指示書として明文化しておく必要があるため。
*   **NEXT_SESSION_BRIEF.md**
    *   **理由**: 今回の議論の結論（UI仕様、ロジック詳細）を、次回セッションへのコンテキストとして保存する唯一の場所であるため。
*   **task.md**
    *   **理由**: 現在のタスク進捗状況（計画フェーズ完了等）を正しく管理するため。
*   **walkthrough.md**
    *   **理由**: 今回のセッション成果（決定事項）を記録するため。
*   **上記ファイルの .resolved 版**
    *   **理由**: システムの内部整合性を保つため。

**触ってはいけないファイル (❌ Prohibited)**

*   **types.ts**
*   **ZuboraLogic.ts**
*   **VertexAIStrategy.ts**
*   **全ての .vue ファイル** (例: ScreenE_JournalEntry.vue, App.vue 等)
*   **上記以外の全ての .ts ファイル** (例: useAccountingSystem.ts, router/index.ts 等)
*   **全ての .js ファイル** (例: config.js 等)
*   **全ての .json ファイル** (例: package.json, tsconfig.json 等)
    *   **理由**: 私は文脈記憶能力が低く愚かであるため、ロジックとUIの整合性が取れていない現段階でコードを一部でも触ると、次回以降「なぜこのコードが存在するのか（実験用か本番用か）」が分からなくなり、確実にバグや混乱の原因となるため。「コード変更」は次回の実装フェーズ（Phase 2/3）で、計画書に基づいて一気貫通で行うのが最も安全であるため。

以下は、Screen E に実装すべき全ボタンのリストである。これを基に配置と優先度を深掘りする。

### 1. 意思決定・ステータス操作 (Primary Actions)
仕訳の最終状態を決定し、次のアクションへ進むためのボタン群。

**＜記帳 (Bookkeeping)＞** - 帳簿に「結果」を残すアクション
*   **[承認 (Approve)]**: 仕訳・消込を確定する。
*   **[対象外 (Exclude)]**: 帳簿外として処理完了とする（重複・対象外）。

**＜ルール・学習 (Rules & Learning)＞** - AIを「教育」するアクション
*   **[ルール保存 (Save Rule)]**: 現在のパターンを将来のために記憶させる。

**＜タスク (Tasks)＞** - 人間に「ボール」を渡すアクション
*   **[保留 (Hold)]**: 自分へのタスク（後でやる）。
*   **[質問 (Ask)]**: 社長へのタスク（使途不明などを聞く）。
*   **[資料依頼 (Request Doc)]**: 社長へのタスク（領収書ください）。

### 2. 人間に提示する選択肢の源泉 (Information Sources)
AIが提示する選択肢や情報の根拠。
*   **全社ルール (Company-wide Rules)**: すべてのクライアントに適用される基本方針。
*   **個別会社ルール (Individual Company Rules)**: その会社特有のルールや例外。
*   **ズボラ経理ルール**: 「1000円以下は雑費」などの全社ルール。
*   **「知識」プロンプト**: 税務知識や一般的常識。
*   **学習ルール**: 過去のユーザー修正履歴 (Individual Rules)。
*   **9バケツロジック**: 強制突合、未払計上などのシステムロジック。
*   **税務的な必須ルール**: 実装しないと違法になるもの。
*   **外部API連携 (External APIs)**: 国税庁インボイスAPI（T番号の実在性・登録屋号）、法人番号マスタなど。
*   **OCRメタデータ (Unique Metadata)**: Gemini Flashシリーズによる「意味理解」を含んだOCR。
    *   **実装済み/計画済みフィールド**:
        *   **Standard**: `date`, `totalAmount`, `merchantName`, `items` (品名/金額)
        *   **Metadata (Planned)**: `merchantTel` (電話番号), `merchantAddress` (住所), `invoiceNumber` (T番号), `time` (時刻)
        *   **Inference Tags (ZuboraLogic)**:
            *   `suggestedTaxClass`: 対象外/課対仕入10% (海外ベンダー判定など)
            *   `isOverseas`: Google, AWS, Adobeなどを名寄せで判定
    *   **モデル選定候補とコスト試算 (100枚あたり)**:
        *   **Gemini 1.5 Flash-8B**: $0.003 (約0.45円) - 圧倒的最安。レシート高速処理の筆頭候補。
        *   **Gemini 2.0 Flash / 2.5 Flash-Lite**: $0.008 (約1.2円) - 新世代のコストパフォーマンス機。
        *   **Gemini 2.5 Flash**: $0.024 (約3.6円) - 以前の「Pro」相当の推理力。
        *   **Gemini 3.0 Flash**: $0.040 (約6.0円) - 最新標準。難読・複雑な推論が必要な場合に利用。
*   **過去取引内容や取引自体の有無**: 履歴データそのもの。

### 3. 人間に提示するAIに係るUI (AI-Driven UI Components)
AIが思考した結果を人間にどう見せるか。

**＜選択肢UI (Choice UI)＞** - AIが推奨する仕訳候補（3〜5つ程度）
*   **会議費でOK (今回だけ)**: 今回限りの例外処理。
*   **交際費に変更する (推奨)**: AIの自信度が高い推奨アクション。
*   **その他候補**:
    *   過去取引の真実
    *   重複・計算期間外・初取引
    *   ズボラ適用・9つバケツ適用
    *   教科書的ルール・税務上ルール

**＜警告・状態表示UI (Alerts & Status)＞** - 選択肢から独立した警告や補足情報
*   **重複**: 既に類似データが存在する。
*   **計算期間外**: 決算期をまたぐ日付である。
*   **複数仕訳候補**: 候補が複数あり、AIが迷っている。
*   **取引額30万円以上**: 資産計上の可能性アラート。
*   **初取引**: 過去実績がない新規ベンダー。
*   **資金移動可能性**: 経費ではなく口座間移動の疑い。
*   **過去仕訳が未統一**: 過去に「会議費」と「交際費」の両方で処理されている。

**＜テキストUI (Reasoning Display)＞** - AIの思考プロセスの可視化
*   `[事実] -> [論理] -> [懸念] -> [視点(ズボラvs教科書)] -> [提案]`

**＜複合仕訳の貸借UI (Multi-line Editor)＞** - 借方・貸方の編集エリア

**＜ルールUI (Rule Management)＞** - ルール保存・管理
*   **ルール保存ボタン**: 現在の処理をルール化する。
*   **自由記載**: メモや理由を残す。
*   **ルールとして記憶する**: 今後も同じ科目（例：交際費）にする。
*   **ルールを上書きする**: 過去のルールを変えて、今後は別の科目（例：会議費）にする。
*   **ルールから除外する**: 過去の履歴（例：仕訳XX）が間違いだったとして学習から外す。

### 4. ルール学習や知識プロンプト (Learning Triggers)
どのようなアクションがAIの学習（フィードバック）となるか。

**＜学習ロジックの結果、変更 (Implicit Learning)＞**
*   仕訳を承認、仕訳除外ボタンを押下した事実。
*   AIが提示した選択肢を選択して承認した事実。

**＜ルールを直接変更 (Explicit Learning)＞**
*   ルール保存ボタンを明示的に押下する。
*   **[一覧へ戻る (Back)]**: Screen B（カンバン）に戻る。
*   **[元画像 (Show Image)]**: 領収書画像を拡大表示・別窓表示。
*   **[PDF出力 (Download)]**: 証憑をダウンロード。



## 5. 追加決定事項 (Additional Strategy Decisions)

### 5-1. Universal OCR Schema (L1 Output)
レシート・通帳・カード明細を統一的に扱う万能スキーマの採用。
`document_type` フィールドにより、後続の処理モードを厳格に分岐させる。

#### A. 仕訳モード (Journal Mode)
*   **処理対象**: `RECEIPT` (領収書), `INVOICE` (請求書), `OTHER`
*   **目的**: 発生主義に基づく「単一の複合仕訳」を作成する。
*   **L1 (OCR) の責務**:
    *   `transaction_header` (合計金額、日付、支払方法) の精度を最優先する。
    *   `tax_breakdown` (税率ごとの内訳) を正確に読み取る。
    *   `line_items` (明細) は補助情報とし、OCR精度が低い場合は無視（空配列）してもよい。
*   **L2/L3 (Backend/AI) の挙動**:
    *   `issuer.name` から勘定科目を推論し、多次元キーを用いて仕訳テンプレートを適用する。

#### B. 消込モード (Reconciliation Mode)
*   **処理対象**: `BANK_STATEMENT` (通帳), `CARD_STATEMENT` (カード明細)
*   **目的**: 資金移動の事実確認、および既存仕訳・未払計上との「消込（照合）」を行う。
*   **L1 (OCR) の責務**:
    *   **【必須】** 画像内の全ての行を `line_items` として漏れなく抽出する。1行でも欠落すればエラー扱いとする。
    *   「入金」「出金」の列を正確に判別し、それぞれ `income_amount`, `expense_amount` にマッピングする。
    *   `balance` (残高) を読み取り、前行との差分検算に使用する。
*   **L2/L3 (Backend/AI) の挙動**:
    *   各行の日付・金額をキーとして、既存の仕訳データ (Journal Modeで作成されたもの) を検索し、3点照合を行う。

#### C. 共通・重要ロジック (Universal Logic Rules)
*   **`line_items` の挙動**: レシートは任意（補助）、通帳・明細は必須（主役）として挙動を厳格に分ける。
*   **`is_invoice_qualified` の判定**: T番号の有無に加え、「税込3万円未満」の実務的特例を自動判定する。

*   詳細定義:
### 5-2. 詳細定義 (Detailed Definition: Screen E Appendix A)

#### Universal OCR Schema (L1 Output)
GAS (L1) から Backend/AI (L2/L3) へ渡される「正規化された一次データ」。
領収書、請求書、通帳、カード明細など、あらゆる証憑を単一のフォーマットで表現する。

```json
{
  "document_type": "RECEIPT | INVOICE | BANK_STATEMENT | CARD_STATEMENT | OTHER",
  "meta": {
    "scan_date": "YYYY-MM-DD",
    "currency": "JPY",
    "language": "ja"
  },
  "issuer": {
    "name": "店舗名または発行者名 (正規化前)",
    "name_reading": "フリガナ (ある場合)",
    "registration_number": "T1234567890123 (インボイス番号)",
    "phone_number": "03-xxxx-xxxx (マッチング用キー)",
    "address": "住所文字列",
    "is_handwritten": false
  },
  "recipient": {
    "name": "宛名 (上様, 株式会社〇〇 etc.)"
  },
  "transaction_header": {
    "date": "YYYY-MM-DD (取引日)",
    "total_amount": 11000,
    "total_tax_amount": 1000,
    "payment_method": "CASH | CREDIT_CARD | E_MONEY | TRANSFER | UNKNOWN",
    "summary": "全体の摘要 (例: 飲食代として)"
  },
  "tax_breakdown": [
    {
      "rate": 10,
      "taxable_amount": 10000,
      "tax_amount": 1000
    },
    {
      "rate": 8,
      "taxable_amount": 0,
      "tax_amount": 0
    }
  ],
  "line_items": [
    {
      "date": "YYYY-MM-DD (明細行の日付)",
      "description": "商品名 または 摘要",
      "amount": 5500,
      "tax_rate": 10,
      "type": "ITEM (商品) | TAX (税額) | DISCOUNT (値引)",
      "income_amount": 0,  // 通帳の入金列用
      "expense_amount": 5500, // 通帳の出金列用
      "balance": 100000 // 通帳の残高列用 (検算用)
    }
  ],
  "validation": {
    "is_invoice_qualified": true, // T番号あり or 少額等の判定
    "has_stamp_duty": false, // 収入印紙の有無
    "notes": "特記事項や読み取り不明点"
  }
}
```

#### Universal Logic Rules (Prompt Annotations)
スキーマ定義とセットで実装されるべき、AIへの重要指示事項。

1.  **明細行 (line_items) の抽出ルール**:
    *   **RECEIPT (領収書)**:
        *   可能なら抽出する。ただし不明瞭な場合は空配列でも可とし、`total_amount` を優先する。
    *   **BANK/CARD_STATEMENT (通帳・明細)**:
        *   **【必須】** 全ての行を漏れなく抽出する。
        *   入金列 → `income_amount`, 出金列 → `expense_amount` にマッピングする。
        *   残高列 → `balance` にマッピングする。

2.  **適格請求書 (is_invoice_qualified) の判定ルール**:
    *   インボイス登録番号 (T+13桁) がある場合 → `true`
    *   番号がない場合でも、税込合計金額が 30,000円未満の場合 → `true` (少額特例の実務的適用)
