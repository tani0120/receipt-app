# 次回の開発セッションに向けたコンテキスト保存 (NEXT_SESSION_BRIEF)

**Status**: [PAUSED] at Phase 2: Logic Design (Gap Analysis Completed)
**Purpose**: このファイルは、次回セッション開始時に `/load_context` に加えて必ず読み込むこと。

## 1. ギャップ分析結果 (Gap Analysis Report)
現在のコード (`src/api/lib/ai/*`) を解析し、理想状態とのギャップを特定した。

### A. プロンプトとデータ構造の欠落
*   **現状 (Current)**:
    *   `VertexAIStrategy.ts`: 単純な OCR プロンプトのみ (`date`, `amount`, `merchantName`, `items`).
    *   `types.ts`: 会計ロジックに関するフィールドが一切ない。
*   **あるべき姿 (Target)**:
    *   **複合仕訳対応 (Multi-line Journals)**: `debit: [{ account, amount, tax }]`, `credit: [...]` の構造が必要。
    *   **推論根拠 (Reasoning)**: `reason_code` (e.g., `RULE_MATCH`, `AI_INFERENCE`) と `confidence_score` を返す必要がある。
    *   **ルール適用 (Rule Priority)**: プロンプト内で「全社ルール」「個別ルール」をどう参照させるか（Context Cachingなど）の設計が欠落している。

### B. アーキテクチャの決断
*   **GAS**: 「ファイルの運搬役（Gmail -> Drive Upload）」に徹する。複雑なテキスト解析は行わない。
*   **Backend**: 以下の最新モデル群を活用し、役割分担を行う "Ensemble AI" 構成を採用する。
    *   **Gemini 3 Flash**: 高速レスポンス・一次仕訳生成（コスト効率重視）
    *   **Gemini 3 Pro**: 複雑なルール適用・全体整合性チェック（精度重視）
    *   **Deep Thinking (Thinking Model)**: 難解な複合仕訳・未知の取引パターンの推論（深い思考）


**【決定事項】UI実装の前に「AI/GASロジック設計」を優先する**
> 「ボタンを押したら何が起きるか（ロジック）」が決まっていないのに、UIのボタンは作れない。
> 「UI先走り」による手戻りを防ぐため、まずは**設計図（Implementation Plan）**を完成させる。

## 2. 現在の検討課題 (The Chicken or Egg Problem)
Screen E (仕訳修正画面) のUIを完成させたいが、AIの推論根拠やルール適用ロジックが未定のため、仕様が固まらない。

### A. AIプロンプトとGASの役割分担
*   **現状**: 未整理。GASでOCRするのか、Backendでやるのか曖昧。
*   **あるべき姿 (提案中)**:
    *   **GAS**: 単なる「運び屋」。Gmail/DriveからファイルをBackendに投げるだけ。
    *   **Backend (Vertex AI)**: OCR、意味解釈、複合仕訳の作成、ルール適用すべてを担当。保守性を高めるためロジックを集約する。

### B. 推論ロジックの優先順位
Screen E で「なぜこの仕訳になったか」を表示するバッジや、修正時のルール保存ボタンを作るために、以下の優先順位を定義する必要がある。
*   **Proposed Priority**:
    1.  User Manual Override (その場の修正)
    2.  Individual Company Rule (個別会社ルール)
    3.  Global Rule (全社共通ルール)
    4.  Historical Data (過去の継続取引)
    5.  Pure AI Inference (AI推論)

## 3. 次回の最初のアクション (Next Actions)

次回起動時は、以下の手順で作業を開始せよ。

1.  **コンテキスト読み込み**:
    *   このファイル (`brain/.../NEXT_SESSION_BRIEF.md`) を読む。
    *   `src/api/lib/ai/prompts.ts` を読む。

3.  **深堀り検討と提案 (Deep Dive Discovery) - [FIRST PRIORITY]**:
    *   **"人間が求めるあるべき姿"** を定義するためのディスカッションを行う。
    *   **AIからの技術的・思想的提案 (Technical & Philosophical Proposal)**:
        *   **Context Caching**: 全社ルールや過去仕訳をRAGではなく、Geminiの巨大コンテキストに丸ごと載せる手法の是非。
        *   **Multi-modal Reasoning**: 文字情報だけでなく、「領収書のレイアウト」や「ロゴ」から業種を推定する能力について。
        *   **"Brain" Architecture**: Gemini 3 Flash / Pro / Thinking をどう使い分けるか？（例：Flashで即答し、Thinkingで裏検証するなど）

### C. 次回提示予定の具体案 (Draft Proposal to be Discussed)
以下を次回議論のたたき台として用意した。

#### テーマ: "Three-Tier Brain Model" (3層の頭脳モデル)
Gemini 3 シリーズ（Flash, Pro, Thinking）の特性を活かし、単なる「OCRの延長」ではなく、**「人間の熟練経理担当者の思考プロセス」そのものを模倣するアーキテクチャ** を提案する。

| 層 (Layer) | モデル (Model) | 役割 (Role) | 思考プロセス (Thought Process) |
| :--- | :--- | :--- | :--- |
| **1. Reflex (反射脳)** | **Gemini 3 Flash** | 一次仕訳、即答 | 「スタバだ、交際費だ」と瞬時に判断。ユーザーを待たせない爆速レスポンス担当。 |
| **2. Logic (論理脳)** | **Gemini 3 Pro** | ルールチェック、整合性 | 「全社ルールに違反していないか？」「インボイス番号は有効か？」を裏で検閲。Context Cachingで全社ルールを記憶。 |
| **3. Deep Thought (熟考脳)** | **Gemini 3 Thinking** | 例外解決、複合仕訳 | 「見たことない請求書だ…」「税区分が混在している…」等の難問に対し、仮説検証を行い解決策を導く。 |

**【提案の核心】**
「ボタンを押したら1つのAIが答える」ではなく、**「Flashが即答し、Proがルールチェックし、Thinkingが難問を解く」** という **チームプレー** をバックエンドに実装する。

### D. 現場からの極めて重要な洞察 (Critical Domain Insights)
ユーザー(税理士)より、以下の具体的な業務要件とAIへの期待値が提示された。これを設計の憲法とする。

1.  **"難問"は10%以下だが、性質が特殊**:
    *   科目が分からないケースは稀。
    *   **本当の難問** = 「経費になるかどうかの境界線（税務リスク）」や「取引先名だけでは内容が不明（詳細確認が必要）」なケース。
    *   **AIへの期待**: 答えを出すことより、「これは確認が必要です（忘れないで！）」とアラートを出すこと。

2.  **80%は"反射"でいいが、"記憶"の補助が必須**:
    *   人間は「前の仕訳なんだっけ？」を忘れる。これが非効率とブレの原因。
    *   **重要**: AIは毎回ゼロから推論するのではなく、**「前回と同じ取引は、確実に前回と同じ科目にする（P/L連続性の担保）」** ことが最優先。推論はその"チェック役"に留める。

3.  **暗黙知の言語化 (Rule Extraction)**:
    *   「全社ルール」「標準科目」は明文化されていないことが多い。
    *   **AIの新機能提案**: 仕訳処理のログから、「この会社、いつもこのパターンですね。ルール化しますか？」と**暗黙知をルールとして提案・整備する機能**が必要。

4.  **インボイス**: 実務上は番号があればOKだが、実装は維持する。

5.  **コミュニケーションとタスク管理 (Communication Integration)**:
    *   **"顧客に確認"機能**: UI上でボタンを押すと、「この画像の件で確認」というタスクが立ち、画像とセットで一元管理される（散逸防止）。
    *   **AIによる補完**:
        *   **Web検索**: 未知の取引先名があれば、AIがネットで業態を調べ、「たぶん飲食店のようです」とヒントを出す。
        *   **資料請求の推奨**: 「借入金」「修繕費」など、契約書や見積書が必須になる科目をAIが検知し、「契約書の徴求が必要です、依頼しますか？」と人間に促す（鋳型整備）。

### E. 次回のアクションプラン (Revised)
上記の洞察に基づき、"Three-Tier Brain" の役割を再定義して提案する。
*   **Flash**: 過去履歴(History)を最優先で検索し、あればそれを即答する「記憶検索係」。
*   **Pro**: 過去履歴が妥当か、今のルールに合致するかをチェックする「監査係」。
*   **Thinking**: 「経費性の判断」や「暗黙知のルール化」を担当する「コンサル係」。

4.  **設計提案 (Design Proposal)**:
    *   ユーザーに対して「理想のデータ構造 (JSON Schema)」を提示する。
    *   **複合仕訳 (Debit/Credit)** に対応したType定義を作成する。
    *   **合意が取れたら**、それを `implementation_plan.md` に書き起こし、実装フェーズ (Phase 2) に移行する。

## 4. ユーザーへのメッセージ (To User)
PCをシャットダウンしても、このファイルが残ります。
次回開始時に **「/load_context」** と入力（または指示）していただければ、私がこのファイルを読み込み、即座に「ロジック設計の続き」から再開できます。
