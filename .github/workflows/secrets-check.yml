name: Security Check (AI Defense)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Gitleaksで600種類以上の秘密情報を検出
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Dockerfileの環境変数チェック
      - name: Check Dockerfile for hardcoded secrets
        run: |
          if grep -rE "VITE_.*=AIza|VITE_.*=sk-|API_KEY=AIza" Dockerfile* 2>/dev/null; then
            echo "❌ ハードコードされたAPIキーを検出"
            echo "Dockerfileに直接APIキーが記載されています"
            exit 1
          fi
          echo "✅ Dockerfileチェック完了"
      
      # .envファイルの誤コミットチェック
      - name: Check for .env files
        run: |
          if git ls-files | grep -E "^\.env$|\.env\.production$|\.env\.local$"; then
            echo "❌ .envファイルがコミットされています"
            echo "以下のファイルを.gitignoreに追加してください:"
            git ls-files | grep -E "^\.env"
            exit 1
          fi
          echo "✅ .envファイルチェック完了"
      
      # package.jsonやその他の設定ファイルのチェック
      - name: Check for secrets in config files
        run: |
          if grep -rE "AIzaSy[0-9A-Za-z_-]{33}|sk-[0-9A-Za-z]{48}" package.json tsconfig.json vite.config.ts 2>/dev/null; then
            echo "❌ 設定ファイルにAPIキーを検出"
            exit 1
          fi
          echo "✅ 設定ファイルチェック完了"
