name: Type Safety Policy Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  type-safety-check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: TypeScript type check
        continue-on-error: true
        run: npm run type-check
      
      - name: Type error baseline check
        run: |
          ERROR_COUNT=$(npm run type-check 2>&1 | grep -oP 'Found \K\d+' || echo 0)
          echo "Current type errors: $ERROR_COUNT"
          # baseline=280（Phase 2で2個削減: accountingSoftware型定義修正）
          # TS2724: 4件は技術的制約として別トラック管理
          # 詳細: docs/type-assumptions.md
          echo "Baseline: 280"
          if [ $ERROR_COUNT -gt 280 ]; then
            echo "❌ Type errors increased: $ERROR_COUNT > 280"
            exit 1
          fi
          echo "✅ Type Safety Policy Gate: PASS"
      
      - name: Type error trend report
        run: |
          echo "Type error reduction targets:"
          echo "- Week 1: 200 errors"
          echo "- Week 2: 100 errors"
          echo "- Week 3: 0 errors"
