name: Type Safety Policy Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  type-safety-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
      
      # ========== HARD FAIL: TypeScriptå‹ãƒã‚§ãƒƒã‚¯ ==========
      - name: TypeScript type check
        run: npm run type-check
      
      # ========== HARD FAIL: ASTãƒ™ãƒ¼ã‚¹Partialæ¤œçŸ¥ ==========
      - name: AST-based type safety check
        run: npm run type-check:ast
      
      # ========== HARD FAIL: Domainå±¤å³æ ¼ãƒã‚§ãƒƒã‚¯ ==========
      - name: Domain layer strict check
        run: |
          echo "ğŸ” Checking domain and features layers..."
          if grep -r "Partial<\|:\s*any" src/domain src/features 2>/dev/null | grep -v "@type-audit"; then
            echo "âŒ Prohibited types in domain/features layer detected"
            echo "ğŸ“– See docs/CONVENTIONS.md for correct patterns"
            exit 1
          fi
          echo "âœ… Domain layer check passed"
      
      # ========== WARN: DTOå±¤è­¦å‘Š ==========
      - name: DTO layer warning check (information only)
        continue-on-error: true
        run: |
          echo "ğŸ” Checking API layer for any types..."
          if grep -r ":\s*any" src/api 2>/dev/null > dto-any.log; then
            echo "âš ï¸  Warning: any types found in API layer (review recommended)"
            cat dto-any.log
          else
            echo "âœ… No any types in API layer"
            touch dto-any.log
          fi
      
      # ========== HARD FAIL: è¨¼è·¡ã‚³ãƒ¡ãƒ³ãƒˆãªã—ã®any ==========
      - name: Validate audit comments
        run: |
          echo "ğŸ” Validating @type-audit comments..."
          if grep -r ":\s*any" src 2>/dev/null | grep -v "node_modules" | grep -v "@type-audit"; then
            echo "âŒ any type without @type-audit comment detected"
            echo "Add // @type-audit: [reason] comment before any types"
            echo "ğŸ“– See docs/CONVENTIONS.md for examples"
            exit 1
          fi
          echo "âœ… All any types have audit comments"
      
      # ========== è¨¼è·¡ä¿å­˜ï¼ˆç›£æŸ»å¯¾å¿œï¼‰ ==========
      - name: Save type audit logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: type-audit-logs-${{ github.sha }}
          path: "*.log"
          retention-days: 90
      
      # ========== æˆåŠŸæ™‚ã®ã‚µãƒãƒªãƒ¼ ==========
      - name: Type safety summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Type Safety Policy Gate: PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "All type safety checks passed:"
          echo "  âœ“ TypeScript compilation"
          echo "  âœ“ AST-based type validation"
          echo "  âœ“ Domain layer strict policy"
          echo "  âœ“ Audit comment validation"
          echo ""
